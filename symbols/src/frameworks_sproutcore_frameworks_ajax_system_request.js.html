<html><head><meta http-equiv="content-type" content="text/html; charset=utf8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="COMM">// ==========================================================================</span><span class="WHIT">
<span class='line'>  2</span> </span><span class="COMM">// Project:   SproutCore - JavaScript Application Framework</span><span class="WHIT">
<span class='line'>  3</span> </span><span class="COMM">// Copyright: ©2006-2011 Strobe Inc. and contributors.</span><span class="WHIT">
<span class='line'>  4</span> </span><span class="COMM">//            Portions ©2008-2011 Apple Inc. All rights reserved.</span><span class="WHIT">
<span class='line'>  5</span> </span><span class="COMM">// License:   Licensed under MIT license (see license.js)</span><span class="WHIT">
<span class='line'>  6</span> </span><span class="COMM">// ==========================================================================</span><span class="WHIT">
<span class='line'>  7</span> 
<span class='line'>  8</span> </span><span class="NAME">sc_require</span><span class="PUNC">(</span><span class="STRN">'system/response'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>  9</span> 
<span class='line'> 10</span> </span><span class="COMM">/**
<span class='line'> 11</span>   @class
<span class='line'> 12</span> 
<span class='line'> 13</span>   Implements support for AJAX requests using XHR, XHR2 and other protocols.
<span class='line'> 14</span> 
<span class='line'> 15</span>   SC.Request is essentially a client version of the request/response objects you receive when
<span class='line'> 16</span>   implementing HTTP servers.
<span class='line'> 17</span> 
<span class='line'> 18</span>   To send a request, you just need to create your request object, configure your options, and call
<span class='line'> 19</span>   `send()` to initiate the request. The request will be added to the pending request queue managed
<span class='line'> 20</span>   by `SC.Request.manager`.
<span class='line'> 21</span> 
<span class='line'> 22</span>   For example,
<span class='line'> 23</span> 
<span class='line'> 24</span>       // Create a simple XHR request.
<span class='line'> 25</span>       var request = SC.Request.create();
<span class='line'> 26</span>       request.set('address', resourceAddress);
<span class='line'> 27</span>       request.set('type', 'GET');
<span class='line'> 28</span>       request.send();
<span class='line'> 29</span> 
<span class='line'> 30</span>   The previous example will create an XHR GET request to `resourceAddress`. Because the `address`
<span class='line'> 31</span>   and `type` of the request must be set on every request, there are helper methods on `SC.Request`
<span class='line'> 32</span>   that you will likely use in every situation.
<span class='line'> 33</span> 
<span class='line'> 34</span>   For example, the previous example can be written more concisely as,
<span class='line'> 35</span> 
<span class='line'> 36</span>       // Create a simple XHR request.
<span class='line'> 37</span>       var request = SC.Request.getUrl(resourceAddress);
<span class='line'> 38</span> 
<span class='line'> 39</span>   There are four other helper methods to cover the other common HTTP method types: `POST`, `DELETE`,
<span class='line'> 40</span>   `PUT` and `PATCH`, which are `postUrl`, `deleteUrl`, `putUrl` and `patchUrl` respectively. Since
<span class='line'> 41</span>   you may also send a body with `POST`, `PUT` and `PATCH` requests, those helper methods also take a
<span class='line'> 42</span>   second argument `body` (which is analogous to calling `request.set('body', body)`).
<span class='line'> 43</span> 
<span class='line'> 44</span>   ## Responses
<span class='line'> 45</span> 
<span class='line'> 46</span>   ### XHR Requests & Custom Communication Protocols
<span class='line'> 47</span> 
<span class='line'> 48</span>   By default, the request will create an instance of `SC.XHRResponse` in order to complete the
<span class='line'> 49</span>   request. As the name implies, the `SC.XHRResponse` class will make an XHR request to the server,
<span class='line'> 50</span>   which is the typical method that the SproutCore client will communicate with remote endpoints.
<span class='line'> 51</span> 
<span class='line'> 52</span>   In order to use a custom response type handler, you should extend `SC.Response` and set the
<span class='line'> 53</span>   `responseClass` of the request to your custom response type.
<span class='line'> 54</span> 
<span class='line'> 55</span>   For example,
<span class='line'> 56</span> 
<span class='line'> 57</span>       var request = SC.Request.getUrl(resourceAddress).set('responseClass', MyApp.CustomProtocolResponse);
<span class='line'> 58</span> 
<span class='line'> 59</span> 
<span class='line'> 60</span>   ### Handling Responses
<span class='line'> 61</span> 
<span class='line'> 62</span>   `SC.Request` supports multiple response handlers based on the status code of the response. This
<span class='line'> 63</span>   system is quite intelligent and allows for specific callbacks to handle specific status codes
<span class='line'> 64</span>   (e.g. 404) or general status codes (e.g. 400) or combinations of both. Callbacks are registered
<span class='line'> 65</span>   using the `notify` method, which accepts a `target` and a `method` which will be called when the
<span class='line'> 66</span>   request completes. The most basic example of registering a general response handler would be like
<span class='line'> 67</span>   so,
<span class='line'> 68</span> 
<span class='line'> 69</span>       // The response handler target (typically a state or controller or some such SC.Object instance).
<span class='line'> 70</span>       var targetObject;
<span class='line'> 71</span> 
<span class='line'> 72</span>       targetObject = SC.Object.create({
<span class='line'> 73</span> 
<span class='line'> 74</span>         handleResponse: function (response) {
<span class='line'> 75</span>           // Handle the various possible status codes.
<span class='line'> 76</span>           var status = response.get('status');
<span class='line'> 77</span>           if (status === 200) { // 200 OK
<span class='line'> 78</span>             // Do something.
<span class='line'> 79</span>           } else if (status &lt; 400) { // i.e. 3xx
<span class='line'> 80</span>             // Do something.
<span class='line'> 81</span>           } else ...
<span class='line'> 82</span>         }
<span class='line'> 83</span> 
<span class='line'> 84</span>       });
<span class='line'> 85</span> 
<span class='line'> 86</span> 
<span class='line'> 87</span>       // Create a simple XHR request.
<span class='line'> 88</span>       var request;
<span class='line'> 89</span> 
<span class='line'> 90</span>       request = SC.Request.getUrl(resourceAddress)
<span class='line'> 91</span>                           .notify(targetObject, 'handleResponse')
<span class='line'> 92</span>                           .send();
<span class='line'> 93</span> 
<span class='line'> 94</span>   However, this approach requires that every response handler be able to handle all of the possible
<span class='line'> 95</span>   error codes that we may be able to handle in a more general manner. It's also more code for us
<span class='line'> 96</span>   to write to write all of the multiple condition statements. For this reason, the `notify` method
<span class='line'> 97</span>   accepts an optional status code argument *before* the target and method. You can use a generic
<span class='line'> 98</span>   status code (i.e. 400) or a specific status code (i.e. 404). If you use a generic status code, all
<span class='line'> 99</span>   statuses within that range will result in that callback being used.
<span class='line'>100</span> 
<span class='line'>101</span>   For example, here is a more specific example,
<span class='line'>102</span> 
<span class='line'>103</span>       // The response handler target (typically a data source or state or some such SC.Object instance).
<span class='line'>104</span>       var targetObject;
<span class='line'>105</span> 
<span class='line'>106</span>       targetObject = SC.Object.create({
<span class='line'>107</span> 
<span class='line'>108</span>         gotOK: function (response) { // 2xx Successful
<span class='line'>109</span>           // Do something.
<span class='line'>110</span> 
<span class='line'>111</span>           return true; // Return true to ensure that any following generic handlers don't run!
<span class='line'>112</span>         },
<span class='line'>113</span> 
<span class='line'>114</span>         gotForbidden: function (response) { // 403 Forbidden
<span class='line'>115</span>           // Do something.
<span class='line'>116</span> 
<span class='line'>117</span>           return true; // Return true to ensure that any following generic handlers don't run!
<span class='line'>118</span>         },
<span class='line'>119</span> 
<span class='line'>120</span>         gotUnknownError: function (response) { // 3xx, 4xx (except 403), 5xx
<span class='line'>121</span>           // Do something.
<span class='line'>122</span>         }
<span class='line'>123</span> 
<span class='line'>124</span>       });
<span class='line'>125</span> 
<span class='line'>126</span> 
<span class='line'>127</span>       // Create a simple XHR request.
<span class='line'>128</span>       var request;
<span class='line'>129</span> 
<span class='line'>130</span>       request = SC.Request.getUrl(resourceAddress)
<span class='line'>131</span>                           .notify(200, targetObject, 'gotOK')
<span class='line'>132</span>                           .notify(403, targetObject, 'gotForbidden')
<span class='line'>133</span>                           .notify(targetObject, 'gotUnknownError')
<span class='line'>134</span>                           .send();
<span class='line'>135</span> 
<span class='line'>136</span>   Please note that the notifications will fall through in the order they are added if not handled.
<span class='line'>137</span>   This means that the generic handler `gotUnknownError` will be called for any responses not caught
<span class='line'>138</span>   by the other handlers. In this example, to ensure that `gotUnknownError` doesn't get called when a
<span class='line'>139</span>   2xx or 403 response comes in, those handlers *return `true`*.
<span class='line'>140</span> 
<span class='line'>141</span>   Please also note that this design allows us to easily re-use handler methods. For example, we may
<span class='line'>142</span>   choose to have `gotUnknownError` be the standard last resort fallback handler for all requests.
<span class='line'>143</span> 
<span class='line'>144</span>   For more examples, including handling of XHR2 progress events, please @see SC.Request.prototype.notify.
<span class='line'>145</span> 
<span class='line'>146</span>   ### Response Bodies & JSON Decoding
<span class='line'>147</span> 
<span class='line'>148</span>   The body of the response is the `body` property on the response object which is passed to the
<span class='line'>149</span>   notify target method. For example,
<span class='line'>150</span> 
<span class='line'>151</span>       gotOK: function (response) { // 2xx Successful
<span class='line'>152</span>         var body = response.get('body');
<span class='line'>153</span> 
<span class='line'>154</span>         // Do something.
<span class='line'>155</span> 
<span class='line'>156</span>         return true; // Return true to ensure that any following generic handlers don't run!
<span class='line'>157</span>       },
<span class='line'>158</span> 
<span class='line'>159</span>   The type of the body will depend on what the server returns, but since it will typically be JSON,
<span class='line'>160</span>   we have a built-in option to have the body be decoded into a JavaScript object automatically by
<span class='line'>161</span>   setting `isJSON` to true on the request.
<span class='line'>162</span> 
<span class='line'>163</span>   For example,
<span class='line'>164</span> 
<span class='line'>165</span>       // Create a simple XHR request.
<span class='line'>166</span>       var request;
<span class='line'>167</span> 
<span class='line'>168</span>       request = SC.Request.getUrl(resourceAddress)
<span class='line'>169</span>                           .set('isJSON', true)
<span class='line'>170</span>                           .notify(200, targetObject, 'gotOK')
<span class='line'>171</span>                           .send();
<span class='line'>172</span> 
<span class='line'>173</span>   There is a helper method to achieve this as well, `json()`,
<span class='line'>174</span> 
<span class='line'>175</span>       // Create a simple XHR request.
<span class='line'>176</span>       var request;
<span class='line'>177</span> 
<span class='line'>178</span>       request = SC.Request.getUrl(resourceAddress)
<span class='line'>179</span>                           .json() // Set `isJSON` to true.
<span class='line'>180</span>                           .notify(200, targetObject, 'gotOK')
<span class='line'>181</span>                           .send();
<span class='line'>182</span> 
<span class='line'>183</span>   @extends SC.Object
<span class='line'>184</span>   @extends SC.Copyable
<span class='line'>185</span>   @extends SC.Freezable
<span class='line'>186</span>   @since SproutCore 1.0
<span class='line'>187</span> */</span><span class="WHIT">
<span class='line'>188</span> </span><span class="NAME">SC.Request</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Object.extend</span><span class="PUNC">(</span><span class="NAME">SC.Copyable</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">SC.Freezable</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>189</span> </span><span class="COMM">/** @scope SC.Request.prototype */</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>190</span> 
<span class='line'>191</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>192</span> </span><span class="WHIT">  </span><span class="COMM">// PROPERTIES</span><span class="WHIT">
<span class='line'>193</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>194</span> 
<span class='line'>195</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>196</span>     Whether to allow credentials, such as Cookies, in the request. While this has no effect on
<span class='line'>197</span>     requests to the same domain, cross-domain requests require that the transport be configured to
<span class='line'>198</span>     allow the inclusion of credentials such as Cookies.
<span class='line'>199</span> 
<span class='line'>200</span>     You can change this property using the chainable `credentials()` helper method (or set it directly).
<span class='line'>201</span> 
<span class='line'>202</span>     @type Boolean
<span class='line'>203</span>     @default YES
<span class='line'>204</span>   */</span><span class="WHIT">
<span class='line'>205</span> </span><span class="WHIT">  </span><span class="NAME">allowCredentials</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>206</span> 
<span class='line'>207</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>208</span>     Sends the request asynchronously instead of blocking the browser. You
<span class='line'>209</span>     should almost always make requests asynchronous. You can change this
<span class='line'>210</span>     options with the async() helper option (or simply set it directly).
<span class='line'>211</span> 
<span class='line'>212</span>     @type Boolean
<span class='line'>213</span>     @default YES
<span class='line'>214</span>   */</span><span class="WHIT">
<span class='line'>215</span> </span><span class="WHIT">  </span><span class="NAME">isAsynchronous</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>216</span> 
<span class='line'>217</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>218</span>     Processes the request and response as JSON if possible. You can change
<span class='line'>219</span>     this option with the json() helper method.
<span class='line'>220</span> 
<span class='line'>221</span>     @type Boolean
<span class='line'>222</span>     @default NO
<span class='line'>223</span>   */</span><span class="WHIT">
<span class='line'>224</span> </span><span class="WHIT">  </span><span class="NAME">isJSON</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>225</span> 
<span class='line'>226</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>227</span>     Process the request and response as XML if possible. You can change this
<span class='line'>228</span>     option with the xml() helper method.
<span class='line'>229</span> 
<span class='line'>230</span>     @type Boolean
<span class='line'>231</span>     @default NO
<span class='line'>232</span>   */</span><span class="WHIT">
<span class='line'>233</span> </span><span class="WHIT">  </span><span class="NAME">isXML</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>234</span> 
<span class='line'>235</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>236</span>     Specifies whether or not the request will have custom headers attached
<span class='line'>237</span>     to it. By default, SC.Request attaches X-Requested-With and
<span class='line'>238</span>     X-SproutCore-Version headers to all outgoing requests. This allows
<span class='line'>239</span>     you to override that behavior.
<span class='line'>240</span> 
<span class='line'>241</span>     You may want to set this to NO if you are making simple CORS requests
<span class='line'>242</span>     in compatible browsers. See &lt;a href="http://www.w3.org/TR/cors/">CORS
<span class='line'>243</span>     Spec for more information.&lt;/a>
<span class='line'>244</span> 
<span class='line'>245</span>     TODO: Add unit tests for this feature
<span class='line'>246</span> 
<span class='line'>247</span>     @type Boolean
<span class='line'>248</span>     @default YES
<span class='line'>249</span>   */</span><span class="WHIT">
<span class='line'>250</span> </span><span class="WHIT">  </span><span class="NAME">attachIdentifyingHeaders</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>251</span> 
<span class='line'>252</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>253</span>     Current set of headers for the request
<span class='line'>254</span> 
<span class='line'>255</span>     @field
<span class='line'>256</span>     @type Hash
<span class='line'>257</span>     @default {}
<span class='line'>258</span>   */</span><span class="WHIT">
<span class='line'>259</span> </span><span class="WHIT">  </span><span class="NAME">headers</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>260</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._headers</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>261</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">ret</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._headers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>262</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>263</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">property</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">cacheable</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>264</span> 
<span class='line'>265</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>266</span>     Whether the request is within the same domain or not. The response class may use this property
<span class='line'>267</span>     to determine specific cross domain configurations.
<span class='line'>268</span> 
<span class='line'>269</span>     @field
<span class='line'>270</span>     @type Boolean
<span class='line'>271</span>   */</span><span class="WHIT">
<span class='line'>272</span> </span><span class="WHIT">  </span><span class="NAME">isSameDomain</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>273</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">address</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'address'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>274</span> </span><span class="WHIT">      </span><span class="NAME">urlRegex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="REGX">/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>275</span> </span><span class="WHIT">      </span><span class="NAME">location</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">window.location</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>276</span> </span><span class="WHIT">      </span><span class="NAME">parts</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">originParts</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>277</span> 
<span class='line'>278</span> </span><span class="WHIT">      </span><span class="COMM">// This pattern matching strategy was taken from jQuery.</span><span class="WHIT">
<span class='line'>279</span> </span><span class="WHIT">      </span><span class="NAME">parts</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">urlRegex.exec</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">address.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">  </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>280</span> </span><span class="WHIT">      </span><span class="NAME">originParts</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">urlRegex.exec</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">location.href.toLowerCase</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>281</span> 
<span class='line'>282</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">SC.none</span><span class="PUNC">(</span><span class="NAME">parts</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>283</span> </span><span class="WHIT">        </span><span class="PUNC">(</span><span class="NAME">parts</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">originParts</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">  </span><span class="COMM">// protocol</span><span class="WHIT">
<span class='line'>284</span> </span><span class="WHIT">         </span><span class="NAME">parts</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">originParts</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">  </span><span class="COMM">// domain</span><span class="WHIT">
<span class='line'>285</span> </span><span class="WHIT">         </span><span class="PUNC">(</span><span class="NAME">parts</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">parts</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"http:"</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NUMB">80</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">443</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">originParts</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">originParts</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"http:"</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NUMB">80</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">443</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// port</span><span class="WHIT">
<span class='line'>286</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">property</span><span class="PUNC">(</span><span class="STRN">'address'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">cacheable</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>287</span> 
<span class='line'>288</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>289</span>     Underlying response class to actually handle this request. Currently the
<span class='line'>290</span>     only supported option is SC.XHRResponse which uses a traditional
<span class='line'>291</span>     XHR transport.
<span class='line'>292</span> 
<span class='line'>293</span>     @type SC.Response
<span class='line'>294</span>     @default SC.XHRResponse
<span class='line'>295</span>   */</span><span class="WHIT">
<span class='line'>296</span> </span><span class="WHIT">  </span><span class="NAME">responseClass</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">SC.XHRResponse</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>297</span> 
<span class='line'>298</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>299</span>     The original request for copied requests.
<span class='line'>300</span> 
<span class='line'>301</span>     @property SC.Request
<span class='line'>302</span>     @default null
<span class='line'>303</span>   */</span><span class="WHIT">
<span class='line'>304</span> </span><span class="WHIT">  </span><span class="NAME">source</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>305</span> 
<span class='line'>306</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>307</span>     The URL this request to go to.
<span class='line'>308</span> 
<span class='line'>309</span>     @type String
<span class='line'>310</span>     @default null
<span class='line'>311</span>   */</span><span class="WHIT">
<span class='line'>312</span> </span><span class="WHIT">  </span><span class="NAME">address</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>313</span> 
<span class='line'>314</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>315</span>     The HTTP method to use.
<span class='line'>316</span> 
<span class='line'>317</span>     @type String
<span class='line'>318</span>     @default 'GET'
<span class='line'>319</span>   */</span><span class="WHIT">
<span class='line'>320</span> </span><span class="WHIT">  </span><span class="NAME">type</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'GET'</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>321</span> 
<span class='line'>322</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>323</span>     An optional timeout value of the request, in milliseconds. The timer
<span class='line'>324</span>     begins when SC.Response#fire is actually invoked by the request manager
<span class='line'>325</span>     and not necessarily when SC.Request#send is invoked. If this timeout is
<span class='line'>326</span>     reached before a response is received, the equivalent of
<span class='line'>327</span>     SC.Request.manager#cancel() will be invoked on the SC.Response instance
<span class='line'>328</span>     and the didReceive() callback will be called.
<span class='line'>329</span> 
<span class='line'>330</span>     An exception will be thrown if you try to invoke send() on a request that
<span class='line'>331</span>     has both a timeout and isAsyncronous set to NO.
<span class='line'>332</span> 
<span class='line'>333</span>     @type Number
<span class='line'>334</span>     @default null
<span class='line'>335</span>   */</span><span class="WHIT">
<span class='line'>336</span> </span><span class="WHIT">  </span><span class="NAME">timeout</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>337</span> 
<span class='line'>338</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>339</span>     The body of the request.  May be an object if isJSON or isXML is set,
<span class='line'>340</span>     otherwise should be a string.
<span class='line'>341</span> 
<span class='line'>342</span>     @type Object|String
<span class='line'>343</span>     @default null
<span class='line'>344</span>   */</span><span class="WHIT">
<span class='line'>345</span> </span><span class="WHIT">  </span><span class="NAME">body</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>346</span> 
<span class='line'>347</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>348</span>     The body, encoded as JSON or XML if needed.
<span class='line'>349</span> 
<span class='line'>350</span>     @field
<span class='line'>351</span>     @type Object|String
<span class='line'>352</span>     @default #body
<span class='line'>353</span>   */</span><span class="WHIT">
<span class='line'>354</span> </span><span class="WHIT">  </span><span class="NAME">encodedBody</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>355</span> </span><span class="WHIT">    </span><span class="COMM">// TODO: support XML</span><span class="WHIT">
<span class='line'>356</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'body'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>357</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'isJSON'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.json.encode</span><span class="PUNC">(</span><span class="NAME">ret</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>358</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>359</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">.</span><span class="NAME">property</span><span class="PUNC">(</span><span class="STRN">'isJSON'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'isXML'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'body'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">cacheable</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>360</span> 
<span class='line'>361</span> 
<span class='line'>362</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>363</span> </span><span class="WHIT">  </span><span class="COMM">// CALLBACKS</span><span class="WHIT">
<span class='line'>364</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>365</span> 
<span class='line'>366</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>367</span>     Invoked on the original request object just before a copied request is
<span class='line'>368</span>     frozen and then sent to the server. This gives you one last change to
<span class='line'>369</span>     fixup the request; possibly adding headers and other options.
<span class='line'>370</span> 
<span class='line'>371</span>     If you do not want the request to actually send, call cancel().
<span class='line'>372</span> 
<span class='line'>373</span>     @param {SC.Request} request A copy of the request object, not frozen
<span class='line'>374</span>     @param {SC.Response} response The object that will wrap the response
<span class='line'>375</span>   */</span><span class="WHIT">
<span class='line'>376</span> </span><span class="WHIT">  </span><span class="NAME">willSend</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">request</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">response</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>377</span> 
<span class='line'>378</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>379</span>     Invoked on the original request object just after the request is sent to
<span class='line'>380</span>     the server. You might use this callback to update some state in your
<span class='line'>381</span>     application.
<span class='line'>382</span> 
<span class='line'>383</span>     The passed request is a frozen copy of the request, indicating the
<span class='line'>384</span>     options set at the time of the request.
<span class='line'>385</span> 
<span class='line'>386</span>     @param {SC.Request} request A copy of the request object, frozen
<span class='line'>387</span>     @param {SC.Response} response The object that will wrap the response
<span class='line'>388</span>     @returns {Boolean} YES on success, NO on failure
<span class='line'>389</span>   */</span><span class="WHIT">
<span class='line'>390</span> </span><span class="WHIT">  </span><span class="NAME">didSend</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">request</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">response</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>391</span> 
<span class='line'>392</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>393</span>     Invoked when a response has been received but not yet processed. This is
<span class='line'>394</span>     your chance to fix up the response based on the results. If you don't
<span class='line'>395</span>     want to continue processing the response call response.cancel().
<span class='line'>396</span> 
<span class='line'>397</span>     @param {SC.Request} request A copy of the request object, frozen
<span class='line'>398</span>     @param {SC.Response} response The object that will wrap the response
<span class='line'>399</span>   */</span><span class="WHIT">
<span class='line'>400</span> </span><span class="WHIT">  </span><span class="NAME">willReceive</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">request</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">response</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>401</span> 
<span class='line'>402</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>403</span>     Invoked after a response has been processed but before any listeners are
<span class='line'>404</span>     notified. You can do any standard processing on the request at this
<span class='line'>405</span>     point. If you don't want to allow notifications to continue, call
<span class='line'>406</span>     response.cancel()
<span class='line'>407</span> 
<span class='line'>408</span>     @param {SC.Request} request A copy of the request object, frozen
<span class='line'>409</span>     @param {SC.Response} response The object that will wrap the response
<span class='line'>410</span>   */</span><span class="WHIT">
<span class='line'>411</span> </span><span class="WHIT">  </span><span class="NAME">didReceive</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">request</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">response</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>412</span> 
<span class='line'>413</span> 
<span class='line'>414</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>415</span> </span><span class="WHIT">  </span><span class="COMM">// HELPER METHODS</span><span class="WHIT">
<span class='line'>416</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>417</span> 
<span class='line'>418</span> </span><span class="WHIT">  </span><span class="COMM">/** @private */</span><span class="WHIT">
<span class='line'>419</span> </span><span class="WHIT">  </span><span class="NAME">concatenatedProperties</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'COPY_KEYS'</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>420</span> 
<span class='line'>421</span> </span><span class="WHIT">  </span><span class="COMM">/** @private */</span><span class="WHIT">
<span class='line'>422</span> </span><span class="WHIT">  </span><span class="NAME">COPY_KEYS</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="STRN">'attachIdentifyingHeaders'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'allowCredentials'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'isAsynchronous'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'isJSON'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'isXML'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'address'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'type'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'timeout'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'body'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'responseClass'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'willSend'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'didSend'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'willReceive'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'didReceive'</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>423</span> 
<span class='line'>424</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>425</span>     Returns a copy of the current request. This will only copy certain
<span class='line'>426</span>     properties so if you want to add additional properties to the copy you
<span class='line'>427</span>     will need to override copy() in a subclass.
<span class='line'>428</span> 
<span class='line'>429</span>     @returns {SC.Request} new request
<span class='line'>430</span>   */</span><span class="WHIT">
<span class='line'>431</span> </span><span class="WHIT">  </span><span class="NAME">copy</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>432</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>433</span> </span><span class="WHIT">        </span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.COPY_KEYS</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>434</span> </span><span class="WHIT">        </span><span class="NAME">loc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">keys.length</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>435</span> </span><span class="WHIT">        </span><span class="NAME">key</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>436</span> 
<span class='line'>437</span> </span><span class="WHIT">    </span><span class="KEYW">while</span><span class="PUNC">(</span><span class="PUNC">--</span><span class="NAME">loc</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>438</span> </span><span class="WHIT">      </span><span class="NAME">key</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="PUNC">[</span><span class="NAME">loc</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>439</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.hasOwnProperty</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>440</span> </span><span class="WHIT">        </span><span class="NAME">ret</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>441</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>442</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>443</span> 
<span class='line'>444</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.hasOwnProperty</span><span class="PUNC">(</span><span class="STRN">'listeners'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>445</span> </span><span class="WHIT">      </span><span class="NAME">ret.listeners</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.copy</span><span class="PUNC">(</span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'listeners'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>446</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>447</span> 
<span class='line'>448</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.hasOwnProperty</span><span class="PUNC">(</span><span class="STRN">'_headers'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>449</span> </span><span class="WHIT">      </span><span class="NAME">ret._headers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.copy</span><span class="PUNC">(</span><span class="NAME">this._headers</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>450</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>451</span> 
<span class='line'>452</span> </span><span class="WHIT">    </span><span class="NAME">ret.source</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'source'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>453</span> 
<span class='line'>454</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.constructor.create</span><span class="PUNC">(</span><span class="NAME">ret</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>455</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>456</span> 
<span class='line'>457</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>458</span>     To set headers on the request object. Pass either a single key/value
<span class='line'>459</span>     pair or a hash of key/value pairs. If you pass only a header name, this
<span class='line'>460</span>     will return the current value of the header.
<span class='line'>461</span> 
<span class='line'>462</span>     @param {String|Hash} key
<span class='line'>463</span>     @param {String} value
<span class='line'>464</span>     @returns {SC.Request|Object} receiver
<span class='line'>465</span>   */</span><span class="WHIT">
<span class='line'>466</span> </span><span class="WHIT">  </span><span class="NAME">header</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>467</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">header</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">headers</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>468</span> 
<span class='line'>469</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_STRING</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>470</span> </span><span class="WHIT">      </span><span class="NAME">headers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._headers</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>471</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">arguments.length</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>472</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">headers</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">headers</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>473</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>474</span> </span><span class="WHIT">        </span><span class="NAME">this.propertyWillChange</span><span class="PUNC">(</span><span class="STRN">'headers'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>475</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">headers</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">headers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._headers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>476</span> </span><span class="WHIT">        </span><span class="NAME">headers</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>477</span> </span><span class="WHIT">        </span><span class="NAME">this.propertyDidChange</span><span class="PUNC">(</span><span class="STRN">'headers'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>478</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>479</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>480</span> 
<span class='line'>481</span> </span><span class="WHIT">    </span><span class="COMM">// handle parsing hash of parameters</span><span class="WHIT">
<span class='line'>482</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>483</span> </span><span class="WHIT">      </span><span class="NAME">headers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">key</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>484</span> </span><span class="WHIT">      </span><span class="NAME">this.beginPropertyChanges</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>485</span> </span><span class="WHIT">      </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">header</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">headers</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>486</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">headers.hasOwnProperty</span><span class="PUNC">(</span><span class="NAME">header</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">continue</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>487</span> </span><span class="WHIT">        </span><span class="NAME">this.header</span><span class="PUNC">(</span><span class="NAME">header</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">headers</span><span class="PUNC">[</span><span class="NAME">header</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>488</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>489</span> </span><span class="WHIT">      </span><span class="NAME">this.endPropertyChanges</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>490</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>491</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>492</span> 
<span class='line'>493</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>494</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>495</span> 
<span class='line'>496</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>497</span>     Clears the list of headers that were set on this request.
<span class='line'>498</span>     This could be used by a subclass to blow-away any custom
<span class='line'>499</span>     headers that were added by the super class.
<span class='line'>500</span>   */</span><span class="WHIT">
<span class='line'>501</span> </span><span class="WHIT">  </span><span class="NAME">clearHeaders</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>502</span> </span><span class="WHIT">    </span><span class="NAME">this.propertyWillChange</span><span class="PUNC">(</span><span class="STRN">'headers'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>503</span> </span><span class="WHIT">    </span><span class="NAME">this._headers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>504</span> </span><span class="WHIT">    </span><span class="NAME">this.propertyDidChange</span><span class="PUNC">(</span><span class="STRN">'headers'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>505</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>506</span> 
<span class='line'>507</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>508</span>     Converts the current request to be asynchronous.
<span class='line'>509</span> 
<span class='line'>510</span>     @param {Boolean} flag YES to make asynchronous, NO or undefined. Default YES.
<span class='line'>511</span>     @returns {SC.Request} receiver
<span class='line'>512</span>   */</span><span class="WHIT">
<span class='line'>513</span> </span><span class="WHIT">  </span><span class="NAME">async</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">flag</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>514</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">flag</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">flag</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>515</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'isAsynchronous'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">flag</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>516</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>517</span> 
<span class='line'>518</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>519</span>     Converts the current request to request allowing credentials or not.
<span class='line'>520</span> 
<span class='line'>521</span>     @param {Boolean} flag YES to request allowing credentials, NO to disallow credentials. Default YES.
<span class='line'>522</span>     @returns {SC.Request} receiver
<span class='line'>523</span>   */</span><span class="WHIT">
<span class='line'>524</span> </span><span class="WHIT">  </span><span class="NAME">credentials</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">flag</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>525</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">flag</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">flag</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>526</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'allowCredentials'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">flag</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>527</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>528</span> 
<span class='line'>529</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>530</span>     Sets the maximum amount of time the request will wait for a response.
<span class='line'>531</span> 
<span class='line'>532</span>     @param {Number} timeout The timeout in milliseconds.
<span class='line'>533</span>     @returns {SC.Request} receiver
<span class='line'>534</span>   */</span><span class="WHIT">
<span class='line'>535</span> </span><span class="WHIT">  </span><span class="NAME">timeoutAfter</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">timeout</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>536</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'timeout'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">timeout</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>537</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>538</span> 
<span class='line'>539</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>540</span>     Converts the current request to use JSON.
<span class='line'>541</span> 
<span class='line'>542</span>     @param {Boolean} flag YES to make JSON, NO or undefined. Default YES.
<span class='line'>543</span>     @returns {SC.Request} receiver
<span class='line'>544</span>   */</span><span class="WHIT">
<span class='line'>545</span> </span><span class="WHIT">  </span><span class="NAME">json</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">flag</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>546</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">flag</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">flag</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>547</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">flag</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'isXML'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>548</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'isJSON'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">flag</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>549</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>550</span> 
<span class='line'>551</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>552</span>     Converts the current request to use XML.
<span class='line'>553</span> 
<span class='line'>554</span>     @param {Boolean} flag YES to make XML, NO or undefined. Default YES.
<span class='line'>555</span>     @returns {SC.Request} recevier
<span class='line'>556</span>   */</span><span class="WHIT">
<span class='line'>557</span> </span><span class="WHIT">  </span><span class="NAME">xml</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">flag</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>558</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">flag</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">flag</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>559</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">flag</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'isJSON'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>560</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'isXML'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">flag</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>561</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>562</span> 
<span class='line'>563</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>564</span>     Called just before a request is enqueued.  This will encode the body
<span class='line'>565</span>     into JSON if it is not already encoded, and set identifying headers
<span class='line'>566</span>   */</span><span class="WHIT">
<span class='line'>567</span> </span><span class="WHIT">  </span><span class="NAME">_prep</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>568</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">hasContentType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">!</span><span class="NAME">this.header</span><span class="PUNC">(</span><span class="STRN">'Content-Type'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>569</span> 
<span class='line'>570</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'attachIdentifyingHeaders'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>571</span> </span><span class="WHIT">      </span><span class="NAME">this.header</span><span class="PUNC">(</span><span class="STRN">'X-Requested-With'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'XMLHttpRequest'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>572</span> </span><span class="WHIT">      </span><span class="NAME">this.header</span><span class="PUNC">(</span><span class="STRN">'X-SproutCore-Version'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">SC.VERSION</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>573</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>574</span> 
<span class='line'>575</span> </span><span class="WHIT">    </span><span class="COMM">// Set the Content-Type header only if not specified and the request</span><span class="WHIT">
<span class='line'>576</span> </span><span class="WHIT">    </span><span class="COMM">// includes a body.</span><span class="WHIT">
<span class='line'>577</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">hasContentType</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">!</span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'body'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>578</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'isJSON'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>579</span> </span><span class="WHIT">        </span><span class="NAME">this.header</span><span class="PUNC">(</span><span class="STRN">'Content-Type'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'application/json'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>580</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'isXML'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>581</span> </span><span class="WHIT">        </span><span class="NAME">this.header</span><span class="PUNC">(</span><span class="STRN">'Content-Type'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'text/xml'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>582</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>583</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>584</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>585</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>586</span> 
<span class='line'>587</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>588</span>     Will fire the actual request. If you have set the request to use JSON
<span class='line'>589</span>     mode then you can pass any object that can be converted to JSON as the
<span class='line'>590</span>     body. Otherwise you should pass a string body.
<span class='line'>591</span> 
<span class='line'>592</span>     @param {String|Object} [body]
<span class='line'>593</span>     @returns {SC.Response} New response object
<span class='line'>594</span>   */</span><span class="WHIT">
<span class='line'>595</span> </span><span class="WHIT">  </span><span class="NAME">send</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">body</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>596</span> </span><span class="WHIT">    </span><span class="COMM">// Sanity-check: Be sure a timeout value was not specified if the request</span><span class="WHIT">
<span class='line'>597</span> </span><span class="WHIT">    </span><span class="COMM">// is synchronous (because it wouldn't work).</span><span class="WHIT">
<span class='line'>598</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">timeout</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'timeout'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>599</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">timeout</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'isAsynchronous'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>600</span> </span><span class="WHIT">      </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"Timeout values cannot be used with synchronous requests"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>601</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">timeout</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>602</span> </span><span class="WHIT">      </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"The timeout value must either not be specified or must be greater than 0"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>603</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>604</span> 
<span class='line'>605</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">body</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'body'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">body</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>606</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">SC.Request.manager.sendRequest</span><span class="PUNC">(</span><span class="NAME">this.copy</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">_prep</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>607</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>608</span> 
<span class='line'>609</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>610</span>     Resends the current request. This is more efficient than calling send()
<span class='line'>611</span>     for requests that have already been used in a send. Otherwise acts just
<span class='line'>612</span>     like send(). Does not take a body argument.
<span class='line'>613</span> 
<span class='line'>614</span>     @returns {SC.Response} new response object
<span class='line'>615</span>   */</span><span class="WHIT">
<span class='line'>616</span> </span><span class="WHIT">  </span><span class="NAME">resend</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>617</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">req</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'source'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.copy</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">_prep</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>618</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">SC.Request.manager.sendRequest</span><span class="PUNC">(</span><span class="NAME">req</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>619</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>620</span> 
<span class='line'>621</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>622</span>     Configures a callback to execute as a request progresses or completes. You
<span class='line'>623</span>     must pass at least a target and action/method to this and optionally an
<span class='line'>624</span>     event name or status code.
<span class='line'>625</span> 
<span class='line'>626</span>     You may also pass additional arguments which will then be passed along to
<span class='line'>627</span>     your callback.
<span class='line'>628</span> 
<span class='line'>629</span>     ## Scoping With Status Codes
<span class='line'>630</span> 
<span class='line'>631</span>     If you pass a status code as the first argument to this method, the
<span class='line'>632</span>     accompanying notification callback will only be called if the response
<span class='line'>633</span>     status matches the status code. For example, if you pass 201 (or
<span class='line'>634</span>     SC.Request.CREATED), the accompanying method will only be called if the
<span class='line'>635</span>     response status from the server is also 201.
<span class='line'>636</span> 
<span class='line'>637</span>     You can also pass "generic" status codes such as 200, 300, or 400, which
<span class='line'>638</span>     will be invoked anytime the status code is in the same range and if a more
<span class='line'>639</span>     specific notifier was not registered first and returned YES.
<span class='line'>640</span> 
<span class='line'>641</span>     Finally, passing a status code of 0 or no status at all will cause your
<span class='line'>642</span>     method to be executed no matter what the resulting status is unless a
<span class='line'>643</span>     more specific notifier was registered first and returned YES.
<span class='line'>644</span> 
<span class='line'>645</span>     For example,
<span class='line'>646</span> 
<span class='line'>647</span>         var req = SC.Request.create({type: 'POST'});
<span class='line'>648</span>         req.notify(201, this, this.reqWasCreated);  // Handle a specific status code
<span class='line'>649</span>         req.notify(401, this, this.reqWasUnauthorized);  // Handle a specific status code
<span class='line'>650</span>         req.notify(400, this, this.reqDidRedirect);  // Handle any 4xx status
<span class='line'>651</span>         req.notify(this, function(response, arg1, arg2) {
<span class='line'>652</span>           // do something
<span class='line'>653</span>         }, arg1, arg2);  // Handle any status.  Also, passing additional arguments to the callback handler
<span class='line'>654</span> 
<span class='line'>655</span>     ## Notifying on Progress Events
<span class='line'>656</span> 
<span class='line'>657</span>     If you pass a progress event name your callback will be called each time
<span class='line'>658</span>     the event fires on the response.  For example, the XMLHttpRequest Level 2
<span class='line'>659</span>     specification defines several progress events: loadstart, progress, abort,
<span class='line'>660</span>     error, load, timeout and loadend.  Therefore, when using the default
<span class='line'>661</span>     SC.Request responseClass, SC.XHRResponse, you can be notified of each of
<span class='line'>662</span>     these events by simply providing the matching event name.
<span class='line'>663</span> 
<span class='line'>664</span>     Note that many older browsers do not support XMLHttpRequest Level 2.  See
<span class='line'>665</span>     http://caniuse.com/xhr2 for a list of supported browsers.
<span class='line'>666</span> 
<span class='line'>667</span>     For example,
<span class='line'>668</span> 
<span class='line'>669</span>       var req = SC.Request.create({type: 'GET'});
<span class='line'>670</span>       req.notify('progress', this, this.reqDidProgress); // Handle 'progress' events
<span class='line'>671</span>       req.notify('abort', this, this.reqDidAbort); // Handle 'abort' events
<span class='line'>672</span>       req.notify('upload.progress', this, this.reqUploadDidProgress); // Handle 'progress' events on the XMLHttpRequestUpload
<span class='line'>673</span>       req.send();
<span class='line'>674</span> 
<span class='line'>675</span>     ## Callback Format
<span class='line'>676</span> 
<span class='line'>677</span>     Your notification callback should expect to receive the Response object as
<span class='line'>678</span>     the first parameter for status code notifications and the Event object for
<span class='line'>679</span>     progress notifications; plus any additional parameters that you pass. If
<span class='line'>680</span>     your callback handles the notification and to prevent further handling, it
<span class='line'>681</span>     should return YES.
<span class='line'>682</span> 
<span class='line'>683</span>     @param [statusOrEvent] {Number|String} A Number status code or String Event name.
<span class='line'>684</span>     @param target {Object} The target object for the callback action.
<span class='line'>685</span>     @param action {String|Function} The method name or function to call on the target.
<span class='line'>686</span>     @returns {SC.Request} The SC.Request object.
<span class='line'>687</span>   */</span><span class="WHIT">
<span class='line'>688</span> </span><span class="WHIT">  </span><span class="NAME">notify</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">statusOrEvent</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">target</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">action</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>689</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">args</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>690</span> </span><span class="WHIT">      </span><span class="NAME">i</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>691</span> 
<span class='line'>692</span> </span><span class="WHIT">    </span><span class="COMM">//@if (debug)</span><span class="WHIT">
<span class='line'>693</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">statusOrEvent</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'loadend'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">SC.Request.WARN_ON_LOADEND</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>694</span> </span><span class="WHIT">      </span><span class="NAME">SC.warn</span><span class="PUNC">(</span><span class="STRN">"Developer Warning: You have called SC.Request#notify for the 'loadend' event. Note that on certain platforms, like older iPads, loadend is not supported and this notification will fail silently. You can protect against this by checking SC.platform.get('supportsXHR2LoadEndEvent'), and attaching listeners for load, error and abort instead. (This is not done automatically because your code may need to handle event type and fire order considerations.) To suppress this warning, set SC.Request.WARN_ON_LOADEND to NO."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>695</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>696</span> </span><span class="WHIT">    </span><span class="COMM">//@endif</span><span class="WHIT">
<span class='line'>697</span> 
<span class='line'>698</span> </span><span class="WHIT">    </span><span class="COMM">// Normalize arguments</span><span class="WHIT">
<span class='line'>699</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">statusOrEvent</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">SC.T_NUMBER</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">statusOrEvent</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">SC.T_STRING</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>700</span> </span><span class="WHIT">      </span><span class="COMM">// Accept multiple additional arguments (Do so before shifting the arguments!)</span><span class="WHIT">
<span class='line'>701</span> 
<span class='line'>702</span> </span><span class="WHIT">      </span><span class="COMM">// Fast arguments access.</span><span class="WHIT">
<span class='line'>703</span> </span><span class="WHIT">      </span><span class="COMM">// Accessing `arguments.length` is just a Number and doesn't materialize the `arguments` object, which is costly.</span><span class="WHIT">
<span class='line'>704</span> </span><span class="WHIT">      </span><span class="NAME">args</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="NAME">arguments.length</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">//  SC.A(arguments).slice(2)</span><span class="WHIT">
<span class='line'>705</span> </span><span class="WHIT">      </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">args.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">args</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">arguments</span><span class="PUNC">[</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>706</span> 
<span class='line'>707</span> </span><span class="WHIT">      </span><span class="COMM">// Shift the arguments</span><span class="WHIT">
<span class='line'>708</span> </span><span class="WHIT">      </span><span class="NAME">action</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">target</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>709</span> </span><span class="WHIT">      </span><span class="NAME">target</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">statusOrEvent</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>710</span> </span><span class="WHIT">      </span><span class="NAME">statusOrEvent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>711</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>712</span> </span><span class="WHIT">      </span><span class="COMM">// Accept multiple additional arguments.</span><span class="WHIT">
<span class='line'>713</span> 
<span class='line'>714</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">arguments.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>715</span> </span><span class="WHIT">        </span><span class="COMM">// Fast arguments access.</span><span class="WHIT">
<span class='line'>716</span> </span><span class="WHIT">        </span><span class="COMM">// Accessing `arguments.length` is just a Number and doesn't materialize the `arguments` object, which is costly.</span><span class="WHIT">
<span class='line'>717</span> </span><span class="WHIT">        </span><span class="NAME">args</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="NAME">arguments.length</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">//  SC.A(arguments).slice(3)</span><span class="WHIT">
<span class='line'>718</span> </span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">args.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">args</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">arguments</span><span class="PUNC">[</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>719</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>720</span> </span><span class="WHIT">        </span><span class="NAME">args</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>721</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>722</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>723</span> 
<span class='line'>724</span> </span><span class="WHIT">    </span><span class="COMM">// Prepare listeners for this object and notification target.</span><span class="WHIT">
<span class='line'>725</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">listeners</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'listeners'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>726</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">listeners</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'listeners'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">listeners</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>727</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">listeners</span><span class="PUNC">[</span><span class="NAME">statusOrEvent</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">listeners</span><span class="PUNC">[</span><span class="NAME">statusOrEvent</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>728</span> 
<span class='line'>729</span> </span><span class="WHIT">    </span><span class="COMM">// Add another listener for the given status code or event name.</span><span class="WHIT">
<span class='line'>730</span> </span><span class="WHIT">    </span><span class="NAME">listeners</span><span class="PUNC">[</span><span class="NAME">statusOrEvent</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">push</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="NAME">target</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">target</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">action</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">action</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">args</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">args</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>731</span> 
<span class='line'>732</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>733</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>734</span> 
<span class='line'>735</span> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>736</span> 
<span class='line'>737</span> </span><span class="NAME">SC.Request.mixin</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>738</span> </span><span class="COMM">/** @scope SC.Request */</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>739</span> 
<span class='line'>740</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>741</span>     Helper method for quickly setting up a GET request.
<span class='line'>742</span> 
<span class='line'>743</span>     @param {String} address url of request
<span class='line'>744</span>     @returns {SC.Request} receiver
<span class='line'>745</span>   */</span><span class="WHIT">
<span class='line'>746</span> </span><span class="WHIT">  </span><span class="NAME">getUrl</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">address</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>747</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">set</span><span class="PUNC">(</span><span class="STRN">'address'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">address</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">set</span><span class="PUNC">(</span><span class="STRN">'type'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'GET'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>748</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>749</span> 
<span class='line'>750</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>751</span>     Helper method for quickly setting up a POST request.
<span class='line'>752</span> 
<span class='line'>753</span>     @param {String} address url of request
<span class='line'>754</span>     @param {String} body
<span class='line'>755</span>     @returns {SC.Request} receiver
<span class='line'>756</span>   */</span><span class="WHIT">
<span class='line'>757</span> </span><span class="WHIT">  </span><span class="NAME">postUrl</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">address</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">body</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>758</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">req</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">set</span><span class="PUNC">(</span><span class="STRN">'address'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">address</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">set</span><span class="PUNC">(</span><span class="STRN">'type'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'POST'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>759</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">body</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">req.set</span><span class="PUNC">(</span><span class="STRN">'body'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">body</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>760</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">req</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>761</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>762</span> 
<span class='line'>763</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>764</span>     Helper method for quickly setting up a DELETE request.
<span class='line'>765</span> 
<span class='line'>766</span>     @param {String} address url of request
<span class='line'>767</span>     @returns {SC.Request} receiver
<span class='line'>768</span>   */</span><span class="WHIT">
<span class='line'>769</span> </span><span class="WHIT">  </span><span class="NAME">deleteUrl</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">address</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>770</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">set</span><span class="PUNC">(</span><span class="STRN">'address'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">address</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">set</span><span class="PUNC">(</span><span class="STRN">'type'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'DELETE'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>771</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>772</span> 
<span class='line'>773</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>774</span>     Helper method for quickly setting up a PUT request.
<span class='line'>775</span> 
<span class='line'>776</span>     @param {String} address url of request
<span class='line'>777</span>     @param {String} body
<span class='line'>778</span>     @returns {SC.Request} receiver
<span class='line'>779</span>   */</span><span class="WHIT">
<span class='line'>780</span> </span><span class="WHIT">  </span><span class="NAME">putUrl</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">address</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">body</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>781</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">req</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">set</span><span class="PUNC">(</span><span class="STRN">'address'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">address</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">set</span><span class="PUNC">(</span><span class="STRN">'type'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'PUT'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>782</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">body</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">req.set</span><span class="PUNC">(</span><span class="STRN">'body'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">body</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>783</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">req</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>784</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>785</span> 
<span class='line'>786</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>787</span>     Helper method for quickly setting up a PATCH request.
<span class='line'>788</span> 
<span class='line'>789</span>     @param {String} address url of request
<span class='line'>790</span>     @param {String} body
<span class='line'>791</span>     @returns {SC.Request} receiver
<span class='line'>792</span>   */</span><span class="WHIT">
<span class='line'>793</span> </span><span class="WHIT">  </span><span class="NAME">patchUrl</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">address</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">body</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>794</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">req</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">set</span><span class="PUNC">(</span><span class="STRN">'address'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">address</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">set</span><span class="PUNC">(</span><span class="STRN">'type'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'PATCH'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>795</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">body</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">req.set</span><span class="PUNC">(</span><span class="STRN">'body'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">body</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>796</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">req</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>797</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>798</span> 
<span class='line'>799</span> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>800</span> 
<span class='line'>801</span> </span><span class="COMM">/* @private Gates loadend warning. */</span><span class="WHIT">
<span class='line'>802</span> </span><span class="NAME">SC.Request.WARN_ON_LOADEND</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>803</span> 
<span class='line'>804</span> </span><span class="COMM">/**
<span class='line'>805</span>   @class
<span class='line'>806</span> 
<span class='line'>807</span>   The request manager coordinates all of the active XHR requests. It will
<span class='line'>808</span>   only allow a certain number of requests to be active at a time; queuing
<span class='line'>809</span>   any others. This allows you more precise control over which requests load
<span class='line'>810</span>   in which order.
<span class='line'>811</span> 
<span class='line'>812</span>   @since SproutCore 1.0
<span class='line'>813</span> */</span><span class="WHIT">
<span class='line'>814</span> </span><span class="NAME">SC.Request.manager</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Object.create</span><span class="PUNC">(</span><span class="WHIT">
<span class='line'>815</span> </span><span class="COMM">/** @scope SC.Request.manager */</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>816</span> 
<span class='line'>817</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>818</span>     Maximum number of concurrent requests allowed. 6 for all browsers.
<span class='line'>819</span> 
<span class='line'>820</span>     @type Number
<span class='line'>821</span>     @default 6
<span class='line'>822</span>   */</span><span class="WHIT">
<span class='line'>823</span> </span><span class="WHIT">  </span><span class="NAME">maxRequests</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">6</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>824</span> 
<span class='line'>825</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>826</span>     Current requests that are inflight.
<span class='line'>827</span> 
<span class='line'>828</span>     @type Array
<span class='line'>829</span>     @default []
<span class='line'>830</span>   */</span><span class="WHIT">
<span class='line'>831</span> </span><span class="WHIT">  </span><span class="NAME">inflight</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>832</span> 
<span class='line'>833</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>834</span>     Requests that are pending and have not been started yet.
<span class='line'>835</span> 
<span class='line'>836</span>     @type Array
<span class='line'>837</span>     @default []
<span class='line'>838</span>   */</span><span class="WHIT">
<span class='line'>839</span> </span><span class="WHIT">  </span><span class="NAME">pending</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>840</span> 
<span class='line'>841</span> 
<span class='line'>842</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>843</span> </span><span class="WHIT">  </span><span class="COMM">// METHODS</span><span class="WHIT">
<span class='line'>844</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>845</span> 
<span class='line'>846</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>847</span>     Invoked by the send() method on a request. This will create a new low-
<span class='line'>848</span>     level transport object and queue it if needed.
<span class='line'>849</span> 
<span class='line'>850</span>     @param {SC.Request} request the request to send
<span class='line'>851</span>     @returns {SC.Object} response object
<span class='line'>852</span>   */</span><span class="WHIT">
<span class='line'>853</span> </span><span class="WHIT">  </span><span class="NAME">sendRequest</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">request</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>854</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">request</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>855</span> 
<span class='line'>856</span> </span><span class="WHIT">    </span><span class="COMM">// create low-level transport.  copy all critical data for request over</span><span class="WHIT">
<span class='line'>857</span> </span><span class="WHIT">    </span><span class="COMM">// so that if the request has been reconfigured the transport will still</span><span class="WHIT">
<span class='line'>858</span> </span><span class="WHIT">    </span><span class="COMM">// work.</span><span class="WHIT">
<span class='line'>859</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">response</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">request.get</span><span class="PUNC">(</span><span class="STRN">'responseClass'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">create</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">request</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">request</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>860</span> 
<span class='line'>861</span> </span><span class="WHIT">    </span><span class="COMM">// add to pending queue</span><span class="WHIT">
<span class='line'>862</span> </span><span class="WHIT">    </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'pending'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">pushObject</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>863</span> </span><span class="WHIT">    </span><span class="NAME">this.fireRequestIfNeeded</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>864</span> 
<span class='line'>865</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">response</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>866</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>867</span> 
<span class='line'>868</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>869</span>     Cancels a specific request. If the request is pending it will simply
<span class='line'>870</span>     be removed. Otherwise it will actually be cancelled.
<span class='line'>871</span> 
<span class='line'>872</span>     @param {SC.Response} response a response object
<span class='line'>873</span>     @returns {Boolean} YES if cancelled
<span class='line'>874</span>   */</span><span class="WHIT">
<span class='line'>875</span> </span><span class="WHIT">  </span><span class="NAME">cancel</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>876</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pending</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'pending'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>877</span> </span><span class="WHIT">        </span><span class="NAME">inflight</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'inflight'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>878</span> 
<span class='line'>879</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">pending.indexOf</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>880</span> </span><span class="WHIT">      </span><span class="NAME">this.propertyWillChange</span><span class="PUNC">(</span><span class="STRN">'pending'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>881</span> </span><span class="WHIT">      </span><span class="NAME">pending.removeObject</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>882</span> </span><span class="WHIT">      </span><span class="NAME">this.propertyDidChange</span><span class="PUNC">(</span><span class="STRN">'pending'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>883</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>884</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">inflight.indexOf</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>885</span> </span><span class="WHIT">      </span><span class="NAME">response.cancel</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>886</span> 
<span class='line'>887</span> </span><span class="WHIT">      </span><span class="NAME">inflight.removeObject</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>888</span> </span><span class="WHIT">      </span><span class="NAME">this.fireRequestIfNeeded</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>889</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>890</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>891</span> 
<span class='line'>892</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>893</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>894</span> 
<span class='line'>895</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>896</span>     Cancels all inflight and pending requests.
<span class='line'>897</span> 
<span class='line'>898</span>     @returns {Boolean} YES if any items were cancelled.
<span class='line'>899</span>   */</span><span class="WHIT">
<span class='line'>900</span> </span><span class="WHIT">  </span><span class="NAME">cancelAll</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>901</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pendingLen</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getPath</span><span class="PUNC">(</span><span class="STRN">'pending.length'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>902</span> </span><span class="WHIT">      </span><span class="NAME">inflightLen</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getPath</span><span class="PUNC">(</span><span class="STRN">'inflight.length'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>903</span> </span><span class="WHIT">      </span><span class="NAME">inflight</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'inflight'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>904</span> </span><span class="WHIT">      </span><span class="NAME">pending</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'pending'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>905</span> 
<span class='line'>906</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">pendingLen</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">inflightLen</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>907</span> </span><span class="WHIT">      </span><span class="COMM">// Iterate backwards.</span><span class="WHIT">
<span class='line'>908</span> </span><span class="WHIT">      </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">inflightLen</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">--</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>909</span> </span><span class="WHIT">        </span><span class="COMM">// This will 'eventually' try to remove the request from</span><span class="WHIT">
<span class='line'>910</span> </span><span class="WHIT">        </span><span class="COMM">// inflight, but it's not fast enough for us.</span><span class="WHIT">
<span class='line'>911</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">r</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">inflight.objectAt</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>912</span> </span><span class="WHIT">        </span><span class="NAME">r.cancel</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>913</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>914</span> 
<span class='line'>915</span> </span><span class="WHIT">      </span><span class="COMM">// Manually scrub the arrays without screwing up memory pointers.</span><span class="WHIT">
<span class='line'>916</span> </span><span class="WHIT">      </span><span class="NAME">pending.replace</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pendingLen</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>917</span> </span><span class="WHIT">      </span><span class="NAME">inflight.replace</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">inflightLen</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>918</span> 
<span class='line'>919</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>920</span> 
<span class='line'>921</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>922</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>923</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>924</span> 
<span class='line'>925</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>926</span>     Checks the inflight queue. If there is an open slot, this will move a
<span class='line'>927</span>     request from pending to inflight.
<span class='line'>928</span> 
<span class='line'>929</span>     @returns {Object} receiver
<span class='line'>930</span>   */</span><span class="WHIT">
<span class='line'>931</span> </span><span class="WHIT">  </span><span class="NAME">fireRequestIfNeeded</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>932</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pending</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'pending'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>933</span> </span><span class="WHIT">        </span><span class="NAME">inflight</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'inflight'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>934</span> </span><span class="WHIT">        </span><span class="NAME">max</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'maxRequests'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>935</span> </span><span class="WHIT">        </span><span class="NAME">next</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>936</span> 
<span class='line'>937</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">pending.length</span><span class="PUNC">></span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">inflight.length</span><span class="PUNC">&lt;</span><span class="NAME">max</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>938</span> </span><span class="WHIT">      </span><span class="NAME">next</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">pending.shiftObject</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>939</span> </span><span class="WHIT">      </span><span class="NAME">inflight.pushObject</span><span class="PUNC">(</span><span class="NAME">next</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>940</span> </span><span class="WHIT">      </span><span class="NAME">next.fire</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>941</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>942</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>943</span> 
<span class='line'>944</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>945</span>     Called by a response/transport object when finishes running. Removes
<span class='line'>946</span>     the transport from the queue and kicks off the next one.
<span class='line'>947</span>   */</span><span class="WHIT">
<span class='line'>948</span> </span><span class="WHIT">  </span><span class="NAME">transportDidClose</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>949</span> </span><span class="WHIT">    </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'pending'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">removeObject</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>950</span> </span><span class="WHIT">    </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'inflight'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">removeObject</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>951</span> </span><span class="WHIT">    </span><span class="NAME">this.fireRequestIfNeeded</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>952</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>953</span> 
<span class='line'>954</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>955</span>     Checks if the response is in the pending queue.
<span class='line'>956</span> 
<span class='line'>957</span>     @param {SC.Response} response a response object
<span class='line'>958</span>     @return {Boolean} is response in pending queue
<span class='line'>959</span>   */</span><span class="WHIT">
<span class='line'>960</span> </span><span class="WHIT">  </span><span class="NAME">isPending</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>961</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'pending'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">contains</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>962</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>963</span> 
<span class='line'>964</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>965</span>     Checks if the response is in the inflight queue.
<span class='line'>966</span> 
<span class='line'>967</span>     @param {SC.Response} response a response object
<span class='line'>968</span>     @return {Boolean} is response in inflight queue
<span class='line'>969</span>   */</span><span class="WHIT">
<span class='line'>970</span> </span><span class="WHIT">  </span><span class="NAME">isInFlight</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>971</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'inflight'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">contains</span><span class="PUNC">(</span><span class="NAME">response</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>972</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>973</span> 
<span class='line'>974</span> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>975</span> </span></pre></body></html>