<html><head><meta http-equiv="content-type" content="text/html; charset=utf8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="COMM">// ==========================================================================</span><span class="WHIT">
<span class='line'>  2</span> </span><span class="COMM">// Project:   SproutCore - JavaScript Application Framework</span><span class="WHIT">
<span class='line'>  3</span> </span><span class="COMM">// Copyright: ©2006-2011 Strobe Inc. and contributors.</span><span class="WHIT">
<span class='line'>  4</span> </span><span class="COMM">//            Portions ©2008-2011 Apple Inc. All rights reserved.</span><span class="WHIT">
<span class='line'>  5</span> </span><span class="COMM">// License:   Licensed under MIT license (see license.js)</span><span class="WHIT">
<span class='line'>  6</span> </span><span class="COMM">// ==========================================================================</span><span class="WHIT">
<span class='line'>  7</span> 
<span class='line'>  8</span> </span><span class="NAME">sc_require</span><span class="PUNC">(</span><span class="STRN">'models/record'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>  9</span> 
<span class='line'> 10</span> </span><span class="COMM">/**
<span class='line'> 11</span>   @class
<span class='line'> 12</span> 
<span class='line'> 13</span> 
<span class='line'> 14</span>   The Store is where you can find all of your dataHashes. Stores can be
<span class='line'> 15</span>   chained for editing purposes and committed back one chain level at a time
<span class='line'> 16</span>   all the way back to a persistent data source.
<span class='line'> 17</span> 
<span class='line'> 18</span>   Every application you create should generally have its own store objects.
<span class='line'> 19</span>   Once you create the store, you will rarely need to work with the store
<span class='line'> 20</span>   directly except to retrieve records and collections.
<span class='line'> 21</span> 
<span class='line'> 22</span>   Internally, the store will keep track of changes to your json data hashes
<span class='line'> 23</span>   and manage syncing those changes with your data source.  A data source may
<span class='line'> 24</span>   be a server, local storage, or any other persistent code.
<span class='line'> 25</span> 
<span class='line'> 26</span>   @extends SC.Object
<span class='line'> 27</span>   @since SproutCore 1.0
<span class='line'> 28</span> */</span><span class="WHIT">
<span class='line'> 29</span> </span><span class="NAME">SC.Store</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Object.extend</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="COMM">/** @scope SC.Store.prototype */</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 30</span> 
<span class='line'> 31</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'> 32</span>     An (optional) name of the store, which can be useful during debugging,
<span class='line'> 33</span>     especially if you have multiple nested stores.
<span class='line'> 34</span> 
<span class='line'> 35</span>     @type String
<span class='line'> 36</span>   */</span><span class="WHIT">
<span class='line'> 37</span> </span><span class="WHIT">  </span><span class="NAME">name</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 38</span> 
<span class='line'> 39</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'> 40</span>     An array of all the chained stores that current rely on the receiver
<span class='line'> 41</span>     store.
<span class='line'> 42</span> 
<span class='line'> 43</span>     @type Array
<span class='line'> 44</span>   */</span><span class="WHIT">
<span class='line'> 45</span> </span><span class="WHIT">  </span><span class="NAME">nestedStores</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 46</span> 
<span class='line'> 47</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'> 48</span>     The data source is the persistent storage that will provide data to the
<span class='line'> 49</span>     store and save changes.  You normally will set your data source when you
<span class='line'> 50</span>     first create your store in your application.
<span class='line'> 51</span> 
<span class='line'> 52</span>     @type SC.DataSource
<span class='line'> 53</span>   */</span><span class="WHIT">
<span class='line'> 54</span> </span><span class="WHIT">  </span><span class="NAME">dataSource</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 55</span> 
<span class='line'> 56</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'> 57</span>     This type of store is not nested.
<span class='line'> 58</span> 
<span class='line'> 59</span>     @default NO
<span class='line'> 60</span>     @type Boolean
<span class='line'> 61</span>   */</span><span class="WHIT">
<span class='line'> 62</span> </span><span class="WHIT">  </span><span class="NAME">isNested</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 63</span> 
<span class='line'> 64</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'> 65</span>     This type of store is not nested.
<span class='line'> 66</span> 
<span class='line'> 67</span>     @default NO
<span class='line'> 68</span>     @type Boolean
<span class='line'> 69</span>   */</span><span class="WHIT">
<span class='line'> 70</span> </span><span class="WHIT">  </span><span class="NAME">commitRecordsAutomatically</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 71</span> 
<span class='line'> 72</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'> 73</span> </span><span class="WHIT">  </span><span class="COMM">// DATA SOURCE SUPPORT</span><span class="WHIT">
<span class='line'> 74</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'> 75</span> 
<span class='line'> 76</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'> 77</span>     Convenience method.  Sets the current data source to the passed property.
<span class='line'> 78</span>     This will also set the store property on the dataSource to the receiver.
<span class='line'> 79</span> 
<span class='line'> 80</span>     If you are using this from the `core.js` method of your app, you may need to
<span class='line'> 81</span>     just pass a string naming your data source class.  If this is the case,
<span class='line'> 82</span>     then your data source will be instantiated the first time it is requested.
<span class='line'> 83</span> 
<span class='line'> 84</span>     @param {SC.DataSource|String} dataSource the data source
<span class='line'> 85</span>     @returns {SC.Store} receiver
<span class='line'> 86</span>   */</span><span class="WHIT">
<span class='line'> 87</span> </span><span class="WHIT">  </span><span class="NAME">from</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">dataSource</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 88</span> </span><span class="WHIT">    </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'dataSource'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataSource</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 89</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 90</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 91</span> 
<span class='line'> 92</span> </span><span class="WHIT">  </span><span class="COMM">// lazily convert data source to real object</span><span class="WHIT">
<span class='line'> 93</span> </span><span class="WHIT">  </span><span class="NAME">_getDataSource</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 94</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'dataSource'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 95</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_STRING</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 96</span> </span><span class="WHIT">      </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.requiredObjectForPropertyPath</span><span class="PUNC">(</span><span class="NAME">ret</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 97</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ret.isClass</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ret.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 98</span> </span><span class="WHIT">      </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'dataSource'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 99</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>100</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>101</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>102</span> 
<span class='line'>103</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>104</span>     Convenience method.  Creates a `CascadeDataSource` with the passed
<span class='line'>105</span>     data source arguments and sets the `CascadeDataSource` as the data source
<span class='line'>106</span>     for the receiver.
<span class='line'>107</span> 
<span class='line'>108</span>     @param {SC.DataSource...} dataSource one or more data source arguments
<span class='line'>109</span>     @returns {SC.Store} receiver
<span class='line'>110</span>   */</span><span class="WHIT">
<span class='line'>111</span> </span><span class="WHIT">  </span><span class="NAME">cascade</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">dataSource</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>112</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">dataSources</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>113</span> 
<span class='line'>114</span> </span><span class="WHIT">    </span><span class="COMM">// Fast arguments access.</span><span class="WHIT">
<span class='line'>115</span> </span><span class="WHIT">    </span><span class="COMM">// Accessing `arguments.length` is just a Number and doesn't materialize the `arguments` object, which is costly.</span><span class="WHIT">
<span class='line'>116</span> </span><span class="WHIT">    </span><span class="NAME">dataSources</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="NAME">arguments.length</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">//  SC.A(arguments)</span><span class="WHIT">
<span class='line'>117</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dataSources.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">dataSources</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">arguments</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>118</span> 
<span class='line'>119</span> </span><span class="WHIT">    </span><span class="NAME">dataSource</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.CascadeDataSource.create</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>120</span> </span><span class="WHIT">      </span><span class="NAME">dataSources</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">dataSources</span><span class="WHIT">
<span class='line'>121</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>122</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.from</span><span class="PUNC">(</span><span class="NAME">dataSource</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>123</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>124</span> 
<span class='line'>125</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>126</span> </span><span class="WHIT">  </span><span class="COMM">// STORE CHAINING</span><span class="WHIT">
<span class='line'>127</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>128</span> 
<span class='line'>129</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>130</span>     Returns a new nested store instance that can be used to buffer changes
<span class='line'>131</span>     until you are ready to commit them.  When you are ready to commit your
<span class='line'>132</span>     changes, call `commitChanges()` or `destroyChanges()` and then `destroy()`
<span class='line'>133</span>     when you are finished with the chained store altogether.
<span class='line'>134</span> 
<span class='line'>135</span>         store = MyApp.store.chain();
<span class='line'>136</span>         .. edit edit edit
<span class='line'>137</span>         store.commitChanges().destroy();
<span class='line'>138</span> 
<span class='line'>139</span>     @param {Hash} attrs optional attributes to set on new store
<span class='line'>140</span>     @param {Class} newStoreClass optional the class of the newly-created nested store (defaults to SC.NestedStore)
<span class='line'>141</span>     @returns {SC.NestedStore} new nested store chained to receiver
<span class='line'>142</span>   */</span><span class="WHIT">
<span class='line'>143</span> </span><span class="WHIT">  </span><span class="NAME">chain</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">attrs</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newStoreClass</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>144</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">attrs</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">attrs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>145</span> </span><span class="WHIT">    </span><span class="NAME">attrs.parentStore</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>146</span> 
<span class='line'>147</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">newStoreClass</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>148</span> </span><span class="WHIT">      </span><span class="COMM">// Ensure the passed-in class is a type of nested store.</span><span class="WHIT">
<span class='line'>149</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">newStoreClass</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">'class'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"%@ is not a valid class"</span><span class="PUNC">.</span><span class="NAME">fmt</span><span class="PUNC">(</span><span class="NAME">newStoreClass</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>150</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">SC.kindOf</span><span class="PUNC">(</span><span class="NAME">newStoreClass</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">SC.NestedStore</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"%@ is not a type of SC.NestedStore"</span><span class="PUNC">.</span><span class="NAME">fmt</span><span class="PUNC">(</span><span class="NAME">newStoreClass</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>151</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>152</span> </span><span class="WHIT">    </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>153</span> </span><span class="WHIT">      </span><span class="NAME">newStoreClass</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.NestedStore</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>154</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>155</span> 
<span class='line'>156</span> </span><span class="WHIT">    </span><span class="COMM">// Replicate parent records references</span><span class="WHIT">
<span class='line'>157</span> </span><span class="WHIT">    </span><span class="NAME">attrs.childRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.childRecords</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">SC.clone</span><span class="PUNC">(</span><span class="NAME">this.childRecords</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>158</span> </span><span class="WHIT">    </span><span class="NAME">attrs.parentRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.parentRecords</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">SC.clone</span><span class="PUNC">(</span><span class="NAME">this.parentRecords</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>159</span> 
<span class='line'>160</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT">    </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newStoreClass.create</span><span class="PUNC">(</span><span class="NAME">attrs</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>161</span> </span><span class="WHIT">        </span><span class="NAME">nested</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.nestedStores</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>162</span> 
<span class='line'>163</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">nested</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">nested</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.nestedStores</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>164</span> </span><span class="WHIT">    </span><span class="NAME">nested.push</span><span class="PUNC">(</span><span class="NAME">ret</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>165</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>166</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>167</span> 
<span class='line'>168</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>169</span>     Creates an autonomous nested store that is connected to the data source.
<span class='line'>170</span> 
<span class='line'>171</span>     Use this kind of nested store to ensure that all records that are committed into the main store
<span class='line'>172</span>     are first of all committed to the server.
<span class='line'>173</span> 
<span class='line'>174</span>     For example,
<span class='line'>175</span> 
<span class='line'>176</span>         nestedStore = store.chainAutonomousStore();
<span class='line'>177</span> 
<span class='line'>178</span>         // ... commit all changes from the nested store to the remote data store
<span class='line'>179</span>         nestedStore.commitRecords();
<span class='line'>180</span> 
<span class='line'>181</span>         // or commit the changes of a nested store's record to the remote data store ...
<span class='line'>182</span>         nestedRecord.commitRecord();
<span class='line'>183</span> 
<span class='line'>184</span>     ## Resolving nested store commits with the main store
<span class='line'>185</span> 
<span class='line'>186</span>     When the committed changes are deemed successful (either by observing the status of the modified
<span class='line'>187</span>     record(s) or by using callbacks with commitRecord/commitRecords), the changes can be passed back
<span class='line'>188</span>     to the main store.
<span class='line'>189</span> 
<span class='line'>190</span>     In the case that the commits are all successful, simply commit to the main store using
<span class='line'>191</span>     `commitSuccessfulChanges`. Note, that using `commitSuccessfulChanges` rather than the standard
<span class='line'>192</span>     `commitChanges` ensures that only clean changes propagate back to the main store.
<span class='line'>193</span> 
<span class='line'>194</span>     For example,
<span class='line'>195</span> 
<span class='line'>196</span>         nestedStore.commitSuccessfulChanges();
<span class='line'>197</span> 
<span class='line'>198</span>     In the case that some or all of the commits fail, you can still use `commitSuccessfulChanges` to
<span class='line'>199</span>     update only those commits that have succeeded in the main store or wait until all commits have
<span class='line'>200</span>     succeeded. Regardless, it will be up to your application to act on the failures and work with
<span class='line'>201</span>     the user to resolve all failures until the nested store records are all clean.
<span class='line'>202</span> 
<span class='line'>203</span> 
<span class='line'>204</span>     @param {Hash} [attrs] attributes to set on new store
<span class='line'>205</span>     @param {Class} [newStoreClass] the class of the newly-created nested store (defaults to SC.NestedStore)
<span class='line'>206</span>     @returns {SC.NestedStore} new nested store chained to receiver
<span class='line'>207</span>   */</span><span class="WHIT">
<span class='line'>208</span> </span><span class="WHIT">  </span><span class="NAME">chainAutonomousStore</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">attrs</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newStoreClass</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>209</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newAttrs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">attrs</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">SC.clone</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">attrs</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>210</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">source</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._getDataSource</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>211</span> 
<span class='line'>212</span> </span><span class="WHIT">    </span><span class="NAME">newAttrs.dataSource</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">source</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>213</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.chain</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">newAttrs</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newStoreClass</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>214</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>215</span> 
<span class='line'>216</span> </span><span class="WHIT">  </span><span class="COMM">/** @private
<span class='line'>217</span> 
<span class='line'>218</span>     Called by a nested store just before it is destroyed so that the parent
<span class='line'>219</span>     can remove the store from its list of nested stores.
<span class='line'>220</span> 
<span class='line'>221</span>     @returns {SC.Store} receiver
<span class='line'>222</span>   */</span><span class="WHIT">
<span class='line'>223</span> </span><span class="WHIT">  </span><span class="NAME">willDestroyNestedStore</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">nestedStore</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>224</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.nestedStores</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>225</span> </span><span class="WHIT">      </span><span class="NAME">this.nestedStores.removeObject</span><span class="PUNC">(</span><span class="NAME">nestedStore</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>226</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>227</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>228</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>229</span> 
<span class='line'>230</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>231</span>     Used to determine if a nested store belongs directly or indirectly to the
<span class='line'>232</span>     receiver.
<span class='line'>233</span> 
<span class='line'>234</span>     @param {SC.Store} store store instance
<span class='line'>235</span>     @returns {Boolean} YES if belongs
<span class='line'>236</span>   */</span><span class="WHIT">
<span class='line'>237</span> </span><span class="WHIT">  </span><span class="NAME">hasNestedStore</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">store</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>238</span> </span><span class="WHIT">    </span><span class="KEYW">while</span><span class="PUNC">(</span><span class="NAME">store</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">store</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">store</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">store.get</span><span class="PUNC">(</span><span class="STRN">'parentStore'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>239</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">store</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>240</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>241</span> 
<span class='line'>242</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>243</span> </span><span class="WHIT">  </span><span class="COMM">// SHARED DATA STRUCTURES</span><span class="WHIT">
<span class='line'>244</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>245</span> 
<span class='line'>246</span> </span><span class="WHIT">  </span><span class="COMM">/** @private
<span class='line'>247</span>     JSON data hashes indexed by store key.
<span class='line'>248</span> 
<span class='line'>249</span>     *IMPORTANT: Property is not observable*
<span class='line'>250</span> 
<span class='line'>251</span>     Shared by a store and its child stores until you make edits to it.
<span class='line'>252</span> 
<span class='line'>253</span>     @type Hash
<span class='line'>254</span>   */</span><span class="WHIT">
<span class='line'>255</span> </span><span class="WHIT">  </span><span class="NAME">dataHashes</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>256</span> 
<span class='line'>257</span> </span><span class="WHIT">  </span><span class="COMM">/** @private
<span class='line'>258</span>     The current status of a data hash indexed by store key.
<span class='line'>259</span> 
<span class='line'>260</span>     *IMPORTANT: Property is not observable*
<span class='line'>261</span> 
<span class='line'>262</span>     Shared by a store and its child stores until you make edits to it.
<span class='line'>263</span> 
<span class='line'>264</span>     @type Hash
<span class='line'>265</span>   */</span><span class="WHIT">
<span class='line'>266</span> </span><span class="WHIT">  </span><span class="NAME">statuses</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>267</span> 
<span class='line'>268</span> </span><span class="WHIT">  </span><span class="COMM">/** @private
<span class='line'>269</span>     This array contains the revisions for the attributes indexed by the
<span class='line'>270</span>     storeKey.
<span class='line'>271</span> 
<span class='line'>272</span>     *IMPORTANT: Property is not observable*
<span class='line'>273</span> 
<span class='line'>274</span>     Revisions are used to keep track of when an attribute hash has been
<span class='line'>275</span>     changed. A store shares the revisions data with its parent until it
<span class='line'>276</span>     starts to make changes to it.
<span class='line'>277</span> 
<span class='line'>278</span>     @type Hash
<span class='line'>279</span>   */</span><span class="WHIT">
<span class='line'>280</span> </span><span class="WHIT">  </span><span class="NAME">revisions</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>281</span> 
<span class='line'>282</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>283</span>     Array indicates whether a data hash is possibly in use by an external
<span class='line'>284</span>     record for editing.  If a data hash is editable then it may be modified
<span class='line'>285</span>     at any time and therefore chained stores may need to clone the
<span class='line'>286</span>     attributes before keeping a copy of them.
<span class='line'>287</span> 
<span class='line'>288</span>     Note that this is kept as an array because it will be stored as a dense
<span class='line'>289</span>     array on some browsers, making it faster.
<span class='line'>290</span> 
<span class='line'>291</span>     @type Array
<span class='line'>292</span>   */</span><span class="WHIT">
<span class='line'>293</span> </span><span class="WHIT">  </span><span class="NAME">editables</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>294</span> 
<span class='line'>295</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>296</span>     A set of storeKeys that need to be committed back to the data source. If
<span class='line'>297</span>     you call `commitRecords()` without passing any other parameters, the keys
<span class='line'>298</span>     in this set will be committed instead.
<span class='line'>299</span> 
<span class='line'>300</span>     @type SC.Set
<span class='line'>301</span>   */</span><span class="WHIT">
<span class='line'>302</span> </span><span class="WHIT">  </span><span class="NAME">changelog</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>303</span> 
<span class='line'>304</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>305</span>     An array of `SC.Error` objects associated with individual records in the
<span class='line'>306</span>     store (indexed by store keys).
<span class='line'>307</span> 
<span class='line'>308</span>     Errors passed form the data source in the call to dataSourceDidError() are
<span class='line'>309</span>     stored here.
<span class='line'>310</span> 
<span class='line'>311</span>     @type Array
<span class='line'>312</span>   */</span><span class="WHIT">
<span class='line'>313</span> </span><span class="WHIT">  </span><span class="NAME">recordErrors</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>314</span> 
<span class='line'>315</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>316</span>     A hash of `SC.Error` objects associated with queries (indexed by the GUID
<span class='line'>317</span>     of the query).
<span class='line'>318</span> 
<span class='line'>319</span>     Errors passed from the data source in the call to
<span class='line'>320</span>     `dataSourceDidErrorQuery()` are stored here.
<span class='line'>321</span> 
<span class='line'>322</span>     @type Hash
<span class='line'>323</span>   */</span><span class="WHIT">
<span class='line'>324</span> </span><span class="WHIT">  </span><span class="NAME">queryErrors</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>325</span> 
<span class='line'>326</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>327</span>     A hash of child Records and there immediate parents
<span class='line'>328</span>   */</span><span class="WHIT">
<span class='line'>329</span> </span><span class="WHIT">  </span><span class="NAME">childRecords</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>330</span> 
<span class='line'>331</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>332</span>     A hash of parent records with registered children
<span class='line'>333</span>   */</span><span class="WHIT">
<span class='line'>334</span> </span><span class="WHIT">  </span><span class="NAME">parentRecords</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>335</span> 
<span class='line'>336</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>337</span> </span><span class="WHIT">  </span><span class="COMM">// CORE ATTRIBUTE API</span><span class="WHIT">
<span class='line'>338</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>339</span> </span><span class="WHIT">  </span><span class="COMM">// The methods in this layer work on data hashes in the store.  They do not</span><span class="WHIT">
<span class='line'>340</span> </span><span class="WHIT">  </span><span class="COMM">// perform any changes that can impact records.  Usually you will not need</span><span class="WHIT">
<span class='line'>341</span> </span><span class="WHIT">  </span><span class="COMM">// to use these methods.</span><span class="WHIT">
<span class='line'>342</span> 
<span class='line'>343</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>344</span>     Returns the current edit status of a store key.  May be one of
<span class='line'>345</span>     `EDITABLE` or `LOCKED`.  Used mostly for unit testing.
<span class='line'>346</span> 
<span class='line'>347</span>     @param {Number} storeKey the store key
<span class='line'>348</span>     @returns {Number} edit status
<span class='line'>349</span>   */</span><span class="WHIT">
<span class='line'>350</span> </span><span class="WHIT">  </span><span class="NAME">storeKeyEditState</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>351</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">editables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.editables</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>352</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">editables</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">editables</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">SC.Store.EDITABLE</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">SC.Store.LOCKED</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>353</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>354</span> 
<span class='line'>355</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>356</span>     Returns the data hash for the given `storeKey`.  This will also 'lock'
<span class='line'>357</span>     the hash so that further edits to the parent store will no
<span class='line'>358</span>     longer be reflected in this store until you reset.
<span class='line'>359</span> 
<span class='line'>360</span>     @param {Number} storeKey key to retrieve
<span class='line'>361</span>     @returns {Hash} data hash or null
<span class='line'>362</span>   */</span><span class="WHIT">
<span class='line'>363</span> </span><span class="WHIT">  </span><span class="NAME">readDataHash</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>364</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.dataHashes</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>365</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>366</span> 
<span class='line'>367</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>368</span>     Returns the data hash for the `storeKey`, cloned so that you can edit
<span class='line'>369</span>     the contents of the attributes if you like.  This will do the extra work
<span class='line'>370</span>     to make sure that you only clone the attributes one time.
<span class='line'>371</span> 
<span class='line'>372</span>     If you use this method to modify data hash, be sure to call
<span class='line'>373</span>     `dataHashDidChange()` when you make edits to record the change.
<span class='line'>374</span> 
<span class='line'>375</span>     @param {Number} storeKey the store key to retrieve
<span class='line'>376</span>     @returns {Hash} the attributes hash
<span class='line'>377</span>   */</span><span class="WHIT">
<span class='line'>378</span> </span><span class="WHIT">  </span><span class="NAME">readEditableDataHash</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>379</span> </span><span class="WHIT">    </span><span class="COMM">// read the value - if there is no hash just return; nothing to do</span><span class="WHIT">
<span class='line'>380</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.dataHashes</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>381</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">ret</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// nothing to do.</span><span class="WHIT">
<span class='line'>382</span> 
<span class='line'>383</span> </span><span class="WHIT">    </span><span class="COMM">// clone data hash if not editable</span><span class="WHIT">
<span class='line'>384</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">editables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.editables</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>385</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">editables</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">editables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.editables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>386</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">editables</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>387</span> </span><span class="WHIT">      </span><span class="NAME">editables</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// use number to store as dense array</span><span class="WHIT">
<span class='line'>388</span> </span><span class="WHIT">      </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.dataHashes</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.clone</span><span class="PUNC">(</span><span class="NAME">ret</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>389</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>390</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>391</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>392</span> 
<span class='line'>393</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>394</span>     Reads a property from the hash - cloning it if needed so you can modify
<span class='line'>395</span>     it independently of any parent store.  This method is really only well
<span class='line'>396</span>     tested for use with toMany relationships.  Although it is public you
<span class='line'>397</span>     generally should not call it directly.
<span class='line'>398</span> 
<span class='line'>399</span>     @param {Number} storeKey storeKey of data hash
<span class='line'>400</span>     @param {String} propertyName property to read
<span class='line'>401</span>     @returns {Object} editable property value
<span class='line'>402</span>   */</span><span class="WHIT">
<span class='line'>403</span> </span><span class="WHIT">  </span><span class="NAME">readEditableProperty</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">propertyName</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>404</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">hash</span><span class="WHIT">      </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readEditableDataHash</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>405</span> </span><span class="WHIT">        </span><span class="NAME">editables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.editables</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="COMM">// get editable info...</span><span class="WHIT">
<span class='line'>406</span> </span><span class="WHIT">        </span><span class="NAME">ret</span><span class="WHIT">       </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">hash</span><span class="PUNC">[</span><span class="NAME">propertyName</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>407</span> 
<span class='line'>408</span> </span><span class="WHIT">    </span><span class="COMM">// editables must be made into a hash so that we can keep track of which</span><span class="WHIT">
<span class='line'>409</span> </span><span class="WHIT">    </span><span class="COMM">// properties have already been made editable</span><span class="WHIT">
<span class='line'>410</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">editables</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">editables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.editables</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>411</span> 
<span class='line'>412</span> </span><span class="WHIT">    </span><span class="COMM">// clone if needed</span><span class="WHIT">
<span class='line'>413</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">editables</span><span class="PUNC">[</span><span class="NAME">propertyName</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>414</span> </span><span class="WHIT">      </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">hash</span><span class="PUNC">[</span><span class="NAME">propertyName</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>415</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">ret.isCopyable</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">hash</span><span class="PUNC">[</span><span class="NAME">propertyName</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ret.copy</span><span class="PUNC">(</span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>416</span> </span><span class="WHIT">      </span><span class="NAME">editables</span><span class="PUNC">[</span><span class="NAME">propertyName</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>417</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>418</span> 
<span class='line'>419</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>420</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>421</span> 
<span class='line'>422</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>423</span>     Replaces the data hash for the `storeKey`.  This will lock the data hash
<span class='line'>424</span>     and mark them as cloned.  This will also call `dataHashDidChange()` for
<span class='line'>425</span>     you.
<span class='line'>426</span> 
<span class='line'>427</span>     Note that the hash you set here must be a different object from the
<span class='line'>428</span>     original data hash.  Once you make a change here, you must also call
<span class='line'>429</span>     `dataHashDidChange()` to register the changes.
<span class='line'>430</span> 
<span class='line'>431</span>     If the data hash does not yet exist in the store, this method will add it.
<span class='line'>432</span>     Pass the optional status to edit the status as well.
<span class='line'>433</span> 
<span class='line'>434</span>     @param {Number} storeKey the store key to write
<span class='line'>435</span>     @param {Hash} hash the new hash
<span class='line'>436</span>     @param {String} status the new hash status
<span class='line'>437</span>     @returns {SC.Store} receiver
<span class='line'>438</span>   */</span><span class="WHIT">
<span class='line'>439</span> </span><span class="WHIT">  </span><span class="NAME">writeDataHash</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">hash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>440</span> 
<span class='line'>441</span> </span><span class="WHIT">    </span><span class="COMM">// update dataHashes and optionally status.</span><span class="WHIT">
<span class='line'>442</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">hash</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">this.dataHashes</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">hash</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>443</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">this.statuses</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>444</span> 
<span class='line'>445</span> </span><span class="WHIT">    </span><span class="COMM">// also note that this hash is now editable</span><span class="WHIT">
<span class='line'>446</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">editables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.editables</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>447</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">editables</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">editables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.editables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>448</span> </span><span class="WHIT">    </span><span class="NAME">editables</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// use number for dense array support</span><span class="WHIT">
<span class='line'>449</span> 
<span class='line'>450</span> </span><span class="WHIT">    </span><span class="COMM">// propagate the data to the child records</span><span class="WHIT">
<span class='line'>451</span> </span><span class="WHIT">    </span><span class="NAME">this._updateChildRecordHashes</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">hash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>452</span> 
<span class='line'>453</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>454</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>455</span> 
<span class='line'>456</span> </span><span class="WHIT">  </span><span class="COMM">/** @private
<span class='line'>457</span> 
<span class='line'>458</span>     Called by writeDataHash to update the child record hashes starting from the new (parent) data hash.
<span class='line'>459</span> 
<span class='line'>460</span>     @returns {SC.Store} receiver
<span class='line'>461</span>   */</span><span class="WHIT">
<span class='line'>462</span> </span><span class="WHIT">  </span><span class="NAME">_updateChildRecordHashes</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">hash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>463</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">processedPaths</span><span class="PUNC">=</span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>464</span> </span><span class="WHIT">    </span><span class="COMM">// Update the child record hashes in place.</span><span class="WHIT">
<span class='line'>465</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">SC.none</span><span class="PUNC">(</span><span class="NAME">this.parentRecords</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>466</span> </span><span class="WHIT">      </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">children</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.parentRecords</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>467</span> </span><span class="WHIT">        </span><span class="NAME">childHash</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>468</span> 
<span class='line'>469</span> </span><span class="WHIT">      </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">key</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">children</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>470</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">children.hasOwnProperty</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>471</span> </span><span class="WHIT">          </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">hash</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>472</span> </span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">childPath</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">children</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>473</span> </span><span class="WHIT">            </span><span class="NAME">childPath</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">childPath.split</span><span class="PUNC">(</span><span class="STRN">'.'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>474</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">childPath.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>475</span> </span><span class="WHIT">              </span><span class="NAME">childHash</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">hash</span><span class="PUNC">[</span><span class="NAME">childPath</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">childPath</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>476</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>477</span> </span><span class="WHIT">              </span><span class="NAME">childHash</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">hash</span><span class="PUNC">[</span><span class="NAME">childPath</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>478</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>479</span> 
<span class='line'>480</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">processedPaths</span><span class="PUNC">[</span><span class="NAME">hash</span><span class="PUNC">[</span><span class="NAME">childPath</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>481</span> </span><span class="WHIT">                </span><span class="COMM">// update data hash: required to push changes beyond the first nesting level</span><span class="WHIT">
<span class='line'>482</span> </span><span class="WHIT">                </span><span class="NAME">this.writeDataHash</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">childHash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>483</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>484</span> 
<span class='line'>485</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">childPath.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="WHIT"> </span><span class="NAME">processedPaths</span><span class="PUNC">[</span><span class="NAME">hash</span><span class="PUNC">[</span><span class="NAME">childPath</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>486</span> </span><span class="WHIT">              </span><span class="COMM">// save it so that we don't processed it over and over</span><span class="WHIT">
<span class='line'>487</span> </span><span class="WHIT">              </span><span class="NAME">processedPaths</span><span class="PUNC">[</span><span class="NAME">hash</span><span class="PUNC">[</span><span class="NAME">childPath</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">=</span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>488</span> 
<span class='line'>489</span> </span><span class="WHIT">              </span><span class="COMM">// force fetching of all children records by invoking the children_attribute wrapper code</span><span class="WHIT">
<span class='line'>490</span> </span><span class="WHIT">              </span><span class="COMM">// and then interating the list in an empty loop</span><span class="WHIT">
<span class='line'>491</span> </span><span class="WHIT">              </span><span class="COMM">// Ugly, but there's basically no other way to do it at the moment, other than</span><span class="WHIT">
<span class='line'>492</span> </span><span class="WHIT">              </span><span class="COMM">// leaving this broken as it was before</span><span class="WHIT">
<span class='line'>493</span> </span><span class="WHIT">              </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">that</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>494</span> </span><span class="WHIT">              </span><span class="NAME">this.invokeLast</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>495</span> </span><span class="WHIT">                </span><span class="NAME">that.records</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">get</span><span class="PUNC">(</span><span class="NAME">childPath</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">forEach</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">it</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>496</span> </span><span class="WHIT">              </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>497</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>498</span> </span><span class="WHIT">          </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>499</span> </span><span class="WHIT">            </span><span class="NAME">this.writeDataHash</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>500</span> </span><span class="WHIT">          </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>501</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>502</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>503</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>504</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>505</span> 
<span class='line'>506</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>507</span>     Removes the data hash from the store.  This does not imply a deletion of
<span class='line'>508</span>     the record.  You could be simply unloading the record.  Either way,
<span class='line'>509</span>     removing the dataHash will be synced back to the parent store but not to
<span class='line'>510</span>     the server.
<span class='line'>511</span> 
<span class='line'>512</span>     Note that you can optionally pass a new status to go along with this. If
<span class='line'>513</span>     you do not pass a status, it will change the status to `SC.RECORD_EMPTY`
<span class='line'>514</span>     (assuming you just unloaded the record).  If you are deleting the record
<span class='line'>515</span>     you may set it to `SC.Record.DESTROYED_CLEAN`.
<span class='line'>516</span> 
<span class='line'>517</span>     Be sure to also call `dataHashDidChange()` to register this change.
<span class='line'>518</span> 
<span class='line'>519</span>     @param {Number} storeKey
<span class='line'>520</span>     @param {String} status optional new status
<span class='line'>521</span>     @returns {SC.Store} receiver
<span class='line'>522</span>   */</span><span class="WHIT">
<span class='line'>523</span> </span><span class="WHIT">  </span><span class="NAME">removeDataHash</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>524</span> </span><span class="WHIT">     </span><span class="COMM">// don't use delete -- that will allow parent dataHash to come through</span><span class="WHIT">
<span class='line'>525</span> </span><span class="WHIT">    </span><span class="NAME">this.dataHashes</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>526</span> </span><span class="WHIT">    </span><span class="NAME">this.statuses</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record.EMPTY</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>527</span> 
<span class='line'>528</span> </span><span class="WHIT">    </span><span class="COMM">// hash is gone and therefore no longer editable</span><span class="WHIT">
<span class='line'>529</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">editables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.editables</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>530</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">editables</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">editables</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>531</span> 
<span class='line'>532</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>533</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>534</span> 
<span class='line'>535</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>536</span>     Reads the current status for a storeKey.  This will also lock the data
<span class='line'>537</span>     hash.  If no status is found, returns `SC.RECORD_EMPTY`.
<span class='line'>538</span> 
<span class='line'>539</span>     @param {Number} storeKey the store key
<span class='line'>540</span>     @returns {Number} status
<span class='line'>541</span>   */</span><span class="WHIT">
<span class='line'>542</span> </span><span class="WHIT">  </span><span class="NAME">readStatus</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>543</span> </span><span class="WHIT">    </span><span class="COMM">// use readDataHash to handle optimistic locking.  this could be inlined</span><span class="WHIT">
<span class='line'>544</span> </span><span class="WHIT">    </span><span class="COMM">// but for now this minimized copy-and-paste code.</span><span class="WHIT">
<span class='line'>545</span> </span><span class="WHIT">    </span><span class="NAME">this.readDataHash</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>546</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.statuses</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record.EMPTY</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>547</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>548</span> 
<span class='line'>549</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>550</span>     Reads the current status for the storeKey without actually locking the
<span class='line'>551</span>     record.  Usually you won't need to use this method.  It is mostly used
<span class='line'>552</span>     internally.
<span class='line'>553</span> 
<span class='line'>554</span>     @param {Number} storeKey the store key
<span class='line'>555</span>     @returns {Number} status
<span class='line'>556</span>   */</span><span class="WHIT">
<span class='line'>557</span> </span><span class="WHIT">  </span><span class="NAME">peekStatus</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>558</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.statuses</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record.EMPTY</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>559</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>560</span> 
<span class='line'>561</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>562</span>     Writes the current status for a storeKey.  If the new status is
<span class='line'>563</span>     `SC.Record.ERROR`, you may also pass an optional error object.  Otherwise
<span class='line'>564</span>     this param is ignored.
<span class='line'>565</span> 
<span class='line'>566</span>     @param {Number} storeKey the store key
<span class='line'>567</span>     @param {String} newStatus the new status
<span class='line'>568</span>     @param {SC.Error} error optional error object
<span class='line'>569</span>     @returns {SC.Store} receiver
<span class='line'>570</span>   */</span><span class="WHIT">
<span class='line'>571</span> </span><span class="WHIT">  </span><span class="NAME">writeStatus</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newStatus</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>572</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">that</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>573</span> </span><span class="WHIT">        </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>574</span> </span><span class="WHIT">    </span><span class="COMM">// use writeDataHash for now to handle optimistic lock.  maximize code</span><span class="WHIT">
<span class='line'>575</span> </span><span class="WHIT">    </span><span class="COMM">// reuse.</span><span class="WHIT">
<span class='line'>576</span> </span><span class="WHIT">    </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.writeDataHash</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newStatus</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>577</span> </span><span class="WHIT">    </span><span class="NAME">this._propagateToChildren</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>578</span> </span><span class="WHIT">      </span><span class="NAME">that.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newStatus</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>579</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>580</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>581</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>582</span> 
<span class='line'>583</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>584</span>     Call this method whenever you modify some editable data hash to register
<span class='line'>585</span>     with the Store that the attribute values have actually changed.  This will
<span class='line'>586</span>     do the book-keeping necessary to track the change across stores including
<span class='line'>587</span>     managing locks.
<span class='line'>588</span> 
<span class='line'>589</span>     @param {Number|Array} storeKeys one or more store keys that changed
<span class='line'>590</span>     @param {Number} rev optional new revision number. normally leave null
<span class='line'>591</span>     @param {Boolean} statusOnly (optional) YES if only status changed
<span class='line'>592</span>     @param {String} key that changed (optional)
<span class='line'>593</span>     @returns {SC.Store} receiver
<span class='line'>594</span>   */</span><span class="WHIT">
<span class='line'>595</span> </span><span class="WHIT">  </span><span class="NAME">dataHashDidChange</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rev</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">statusOnly</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">key</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>596</span> </span><span class="WHIT">    </span><span class="COMM">// update the revision for storeKey.  Use generateStoreKey() because that</span><span class="WHIT">
<span class='line'>597</span> </span><span class="WHIT">    </span><span class="COMM">// guarantees a universally (to this store hierarchy anyway) unique</span><span class="WHIT">
<span class='line'>598</span> </span><span class="WHIT">    </span><span class="COMM">// key value.</span><span class="WHIT">
<span class='line'>599</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">rev</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">rev</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Store.generateStoreKey</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>600</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>601</span> 
<span class='line'>602</span> </span><span class="WHIT">    </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_ARRAY</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>603</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>604</span> </span><span class="WHIT">      </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>605</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>606</span> </span><span class="WHIT">      </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>607</span> </span><span class="WHIT">      </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>608</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>609</span> 
<span class='line'>610</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">that</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>611</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>612</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>613</span> </span><span class="WHIT">      </span><span class="NAME">this.revisions</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rev</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>614</span> </span><span class="WHIT">      </span><span class="NAME">this._notifyRecordPropertyChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">statusOnly</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">key</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>615</span> 
<span class='line'>616</span> </span><span class="WHIT">      </span><span class="NAME">this._propagateToChildren</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>617</span> </span><span class="WHIT">        </span><span class="NAME">that.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">statusOnly</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">key</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>618</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>619</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>620</span> 
<span class='line'>621</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>622</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>623</span> 
<span class='line'>624</span> </span><span class="WHIT">  </span><span class="COMM">/** @private
<span class='line'>625</span>     Will push all changes to a the recordPropertyChanges property
<span class='line'>626</span>     and execute `flush()` once at the end of the runloop.
<span class='line'>627</span>   */</span><span class="WHIT">
<span class='line'>628</span> </span><span class="WHIT">  </span><span class="NAME">_notifyRecordPropertyChange</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">statusOnly</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">key</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>629</span> 
<span class='line'>630</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">records</span><span class="WHIT">      </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.records</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>631</span> </span><span class="WHIT">        </span><span class="NAME">nestedStores</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'nestedStores'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>632</span> </span><span class="WHIT">        </span><span class="NAME">K</span><span class="WHIT">            </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Store</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>633</span> </span><span class="WHIT">        </span><span class="NAME">rec</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">editState</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">store</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>634</span> 
<span class='line'>635</span> </span><span class="WHIT">    </span><span class="COMM">// pass along to nested stores</span><span class="WHIT">
<span class='line'>636</span> </span><span class="WHIT">    </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nestedStores</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">nestedStores.length</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>637</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>638</span> </span><span class="WHIT">      </span><span class="NAME">store</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nestedStores</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>639</span> </span><span class="WHIT">      </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">store.peekStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// important: peek avoids read-lock</span><span class="WHIT">
<span class='line'>640</span> </span><span class="WHIT">      </span><span class="NAME">editState</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">store.storeKeyEditState</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>641</span> 
<span class='line'>642</span> </span><span class="WHIT">      </span><span class="COMM">// when store needs to propagate out changes in the parent store</span><span class="WHIT">
<span class='line'>643</span> </span><span class="WHIT">      </span><span class="COMM">// to nested stores</span><span class="WHIT">
<span class='line'>644</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">editState</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.INHERITED</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>645</span> </span><span class="WHIT">        </span><span class="NAME">store._notifyRecordPropertyChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">statusOnly</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">key</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>646</span> 
<span class='line'>647</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">SC.Record.BUSY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>648</span> </span><span class="WHIT">        </span><span class="COMM">// make sure nested store does not have any changes before resetting</span><span class="WHIT">
<span class='line'>649</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">store.get</span><span class="PUNC">(</span><span class="STRN">'hasChanges'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">K.CHAIN_CONFLICT_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>650</span> </span><span class="WHIT">        </span><span class="NAME">store.reset</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>651</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>652</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>653</span> 
<span class='line'>654</span> </span><span class="WHIT">    </span><span class="COMM">// store info in changes hash and schedule notification if needed.</span><span class="WHIT">
<span class='line'>655</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">changes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.recordPropertyChanges</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>656</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">changes</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>657</span> </span><span class="WHIT">      </span><span class="NAME">changes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.recordPropertyChanges</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT">
<span class='line'>658</span> </span><span class="WHIT">        </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">:</span><span class="WHIT">      </span><span class="NAME">SC.CoreSet.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>659</span> </span><span class="WHIT">          </span><span class="NAME">records</span><span class="PUNC">:</span><span class="WHIT">        </span><span class="NAME">SC.CoreSet.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>660</span> </span><span class="WHIT">          </span><span class="NAME">hasDataChanges</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">SC.CoreSet.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>661</span> </span><span class="WHIT">          </span><span class="NAME">propertyForStoreKeys</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>662</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>663</span> 
<span class='line'>664</span> </span><span class="WHIT">    </span><span class="NAME">changes.storeKeys.add</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>665</span> 
<span class='line'>666</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">records</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">rec</span><span class="PUNC">=</span><span class="NAME">records</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>667</span> </span><span class="WHIT">      </span><span class="NAME">changes.records.push</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>668</span> 
<span class='line'>669</span> </span><span class="WHIT">      </span><span class="COMM">// If there are changes other than just the status we need to record</span><span class="WHIT">
<span class='line'>670</span> </span><span class="WHIT">      </span><span class="COMM">// that information so we do the right thing during the next flush.</span><span class="WHIT">
<span class='line'>671</span> </span><span class="WHIT">      </span><span class="COMM">// Note that if we're called multiple times before flush and one call</span><span class="WHIT">
<span class='line'>672</span> </span><span class="WHIT">      </span><span class="COMM">// has `statusOnly=true` and another has `statusOnly=false`, the flush</span><span class="WHIT">
<span class='line'>673</span> </span><span class="WHIT">      </span><span class="COMM">// will (correctly) operate in `statusOnly=false` mode.</span><span class="WHIT">
<span class='line'>674</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">statusOnly</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">changes.hasDataChanges.push</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>675</span> 
<span class='line'>676</span> </span><span class="WHIT">      </span><span class="COMM">// If this is a key specific change, make sure that only those</span><span class="WHIT">
<span class='line'>677</span> </span><span class="WHIT">      </span><span class="COMM">// properties/keys are notified.  However, if a previous invocation of</span><span class="WHIT">
<span class='line'>678</span> </span><span class="WHIT">      </span><span class="COMM">// `_notifyRecordPropertyChange` specified that all keys have changed, we</span><span class="WHIT">
<span class='line'>679</span> </span><span class="WHIT">      </span><span class="COMM">// need to respect that.</span><span class="WHIT">
<span class='line'>680</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>681</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">changes.propertyForStoreKeys</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>682</span> </span><span class="WHIT">          </span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">changes.propertyForStoreKeys</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.CoreSet.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>683</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>684</span> 
<span class='line'>685</span> </span><span class="WHIT">        </span><span class="COMM">// If it's '*' instead of a set, then that means there was a previous</span><span class="WHIT">
<span class='line'>686</span> </span><span class="WHIT">        </span><span class="COMM">// invocation that said all keys have changed.</span><span class="WHIT">
<span class='line'>687</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">'*'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>688</span> </span><span class="WHIT">          </span><span class="NAME">keys.add</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>689</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>690</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>691</span> </span><span class="WHIT">      </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>692</span> </span><span class="WHIT">        </span><span class="COMM">// Mark that all properties have changed.</span><span class="WHIT">
<span class='line'>693</span> </span><span class="WHIT">        </span><span class="NAME">changes.propertyForStoreKeys</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'*'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>694</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>695</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>696</span> 
<span class='line'>697</span> </span><span class="WHIT">    </span><span class="NAME">this.invokeOnce</span><span class="PUNC">(</span><span class="NAME">this.flush</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>698</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>699</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>700</span> 
<span class='line'>701</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>702</span>     Delivers any pending changes to materialized records.  Normally this
<span class='line'>703</span>     happens once, automatically, at the end of the RunLoop.  If you have
<span class='line'>704</span>     updated some records and need to update records immediately, however,
<span class='line'>705</span>     you may call this manually.
<span class='line'>706</span> 
<span class='line'>707</span>     @returns {SC.Store} receiver
<span class='line'>708</span>   */</span><span class="WHIT">
<span class='line'>709</span> </span><span class="WHIT">  </span><span class="NAME">flush</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>710</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.recordPropertyChanges</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>711</span> 
<span class='line'>712</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">changes</span><span class="WHIT">              </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.recordPropertyChanges</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>713</span> </span><span class="WHIT">        </span><span class="NAME">storeKeys</span><span class="WHIT">            </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">changes.storeKeys</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>714</span> </span><span class="WHIT">        </span><span class="NAME">hasDataChanges</span><span class="WHIT">       </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">changes.hasDataChanges</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>715</span> </span><span class="WHIT">        </span><span class="NAME">records</span><span class="WHIT">              </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">changes.records</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>716</span> </span><span class="WHIT">        </span><span class="NAME">propertyForStoreKeys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">changes.propertyForStoreKeys</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>717</span> </span><span class="WHIT">        </span><span class="NAME">recordTypes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.CoreSet.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>718</span> </span><span class="WHIT">        </span><span class="NAME">rec</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">statusOnly</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>719</span> 
<span class='line'>720</span> </span><span class="WHIT">    </span><span class="NAME">storeKeys.forEach</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>721</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">records.contains</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>722</span> </span><span class="WHIT">        </span><span class="NAME">statusOnly</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">hasDataChanges.contains</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>723</span> </span><span class="WHIT">        </span><span class="NAME">rec</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.records</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>724</span> </span><span class="WHIT">        </span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">propertyForStoreKeys</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">propertyForStoreKeys</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>725</span> 
<span class='line'>726</span> </span><span class="WHIT">        </span><span class="COMM">// Are we invalidating all keys?  If so, don't pass any to</span><span class="WHIT">
<span class='line'>727</span> </span><span class="WHIT">        </span><span class="COMM">// storeDidChangeProperties.</span><span class="WHIT">
<span class='line'>728</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'*'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>729</span> 
<span class='line'>730</span> </span><span class="WHIT">        </span><span class="COMM">// remove it so we don't trigger this twice</span><span class="WHIT">
<span class='line'>731</span> </span><span class="WHIT">        </span><span class="NAME">records.remove</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>732</span> 
<span class='line'>733</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">rec</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">rec.storeDidChangeProperties</span><span class="PUNC">(</span><span class="NAME">statusOnly</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>734</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>735</span> 
<span class='line'>736</span> </span><span class="WHIT">      </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Store.recordTypeFor</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>737</span> </span><span class="WHIT">      </span><span class="NAME">recordTypes.add</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>738</span> 
<span class='line'>739</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>740</span> 
<span class='line'>741</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKeys.get</span><span class="PUNC">(</span><span class="STRN">'length'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">this._notifyRecordArrays</span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>742</span> 
<span class='line'>743</span> </span><span class="WHIT">    </span><span class="NAME">storeKeys.clear</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>744</span> </span><span class="WHIT">    </span><span class="NAME">hasDataChanges.clear</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>745</span> </span><span class="WHIT">    </span><span class="NAME">records.clear</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>746</span> </span><span class="WHIT">    </span><span class="COMM">// Provide full reference to overwrite</span><span class="WHIT">
<span class='line'>747</span> </span><span class="WHIT">    </span><span class="NAME">this.recordPropertyChanges.propertyForStoreKeys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>748</span> 
<span class='line'>749</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>750</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>751</span> 
<span class='line'>752</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>753</span>     Resets the store content.  This will clear all internal data for all
<span class='line'>754</span>     records, resetting them to an EMPTY state.  You generally do not want
<span class='line'>755</span>     to call this method yourself, though you may override it.
<span class='line'>756</span> 
<span class='line'>757</span>     @returns {SC.Store} receiver
<span class='line'>758</span>   */</span><span class="WHIT">
<span class='line'>759</span> </span><span class="WHIT">  </span><span class="NAME">reset</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>760</span> 
<span class='line'>761</span> </span><span class="WHIT">    </span><span class="COMM">// create a new empty data store</span><span class="WHIT">
<span class='line'>762</span> </span><span class="WHIT">    </span><span class="NAME">this.dataHashes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>763</span> </span><span class="WHIT">    </span><span class="NAME">this.revisions</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>764</span> </span><span class="WHIT">    </span><span class="NAME">this.statuses</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>765</span> </span><span class="WHIT">    </span><span class="NAME">this.records</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>766</span> </span><span class="WHIT">    </span><span class="NAME">this.childRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>767</span> </span><span class="WHIT">    </span><span class="NAME">this.parentRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>768</span> 
<span class='line'>769</span> </span><span class="WHIT">    </span><span class="COMM">// also reset temporary objects and errors</span><span class="WHIT">
<span class='line'>770</span> </span><span class="WHIT">    </span><span class="NAME">this.chainedChanges</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.locks</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.editables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>771</span> </span><span class="WHIT">    </span><span class="NAME">this.changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>772</span> </span><span class="WHIT">    </span><span class="NAME">this.recordErrors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>773</span> </span><span class="WHIT">    </span><span class="NAME">this.queryErrors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>774</span> 
<span class='line'>775</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">dataSource</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'dataSource'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>776</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">dataSource</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">dataSource.reset</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">dataSource.reset</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>777</span> 
<span class='line'>778</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">records</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.records</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>779</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">records</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>780</span> </span><span class="WHIT">      </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">records</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>781</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">records.hasOwnProperty</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">continue</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>782</span> </span><span class="WHIT">        </span><span class="NAME">this._notifyRecordPropertyChange</span><span class="PUNC">(</span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>783</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>784</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>785</span> 
<span class='line'>786</span> </span><span class="WHIT">    </span><span class="COMM">// Also reset all pre-created recordArrays.</span><span class="WHIT">
<span class='line'>787</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ra</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">raList</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'recordArrays'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>788</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">raList</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>789</span> </span><span class="WHIT">      </span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">ra</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">raList.pop</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>790</span> </span><span class="WHIT">        </span><span class="NAME">ra.destroy</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>791</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>792</span> </span><span class="WHIT">      </span><span class="NAME">raList.clear</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>793</span> </span><span class="WHIT">      </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'recordArrays'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>794</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>795</span> 
<span class='line'>796</span> </span><span class="WHIT">    </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'hasChanges'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>797</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>798</span> 
<span class='line'>799</span> </span><span class="WHIT">  </span><span class="COMM">/** @private
<span class='line'>800</span>     Called by a nested store on a parent store to commit any changes from the
<span class='line'>801</span>     store.  This will copy any changed dataHashes as well as any persistent
<span class='line'>802</span>     change logs.
<span class='line'>803</span> 
<span class='line'>804</span>     If the parentStore detects a conflict with the optimistic locking, it will
<span class='line'>805</span>     raise an exception before it makes any changes.  If you pass the
<span class='line'>806</span>     force flag then this detection phase will be skipped and the changes will
<span class='line'>807</span>     be applied even if another resource has modified the store in the mean
<span class='line'>808</span>     time.
<span class='line'>809</span> 
<span class='line'>810</span>     @param {SC.Store} nestedStore the child store
<span class='line'>811</span>     @param {SC.Set} changes the set of changed store keys
<span class='line'>812</span>     @param {Boolean} force
<span class='line'>813</span>     @returns {SC.Store} receiver
<span class='line'>814</span>   */</span><span class="WHIT">
<span class='line'>815</span> </span><span class="WHIT">  </span><span class="NAME">commitChangesFromNestedStore</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nestedStore</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">changes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">force</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>816</span> </span><span class="WHIT">    </span><span class="COMM">// first, check for optimistic locking problems</span><span class="WHIT">
<span class='line'>817</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">force</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">nestedStore.get</span><span class="PUNC">(</span><span class="STRN">'conflictedStoreKeys'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>818</span> </span><span class="WHIT">      </span><span class="NAME">SC.Store.CHAIN_CONFLICT_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>819</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>820</span> 
<span class='line'>821</span> </span><span class="WHIT">    </span><span class="COMM">// OK, no locking issues.  So let's just copy them changes.</span><span class="WHIT">
<span class='line'>822</span> </span><span class="WHIT">    </span><span class="COMM">// get local reference to values.</span><span class="WHIT">
<span class='line'>823</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">changes.length</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">myDataHashes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">myStatuses</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>824</span> </span><span class="WHIT">      </span><span class="NAME">myEditables</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">myRevisions</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">myParentRecords</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">myChildRecords</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>825</span> </span><span class="WHIT">      </span><span class="NAME">chDataHashes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">chStatuses</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">chRevisions</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">chParentRecords</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">chChildRecords</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>826</span> 
<span class='line'>827</span> </span><span class="WHIT">    </span><span class="NAME">myRevisions</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.revisions</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>828</span> </span><span class="WHIT">    </span><span class="NAME">myDataHashes</span><span class="WHIT">    </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.dataHashes</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>829</span> </span><span class="WHIT">    </span><span class="NAME">myStatuses</span><span class="WHIT">      </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.statuses</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>830</span> </span><span class="WHIT">    </span><span class="NAME">myEditables</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.editables</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>831</span> </span><span class="WHIT">    </span><span class="NAME">myParentRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.parentRecords</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.parentRecords</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.parentRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="PUNC">{</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>832</span> </span><span class="WHIT">    </span><span class="NAME">myChildRecords</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.childRecords</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.childRecords</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.childRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>833</span> 
<span class='line'>834</span> </span><span class="WHIT">    </span><span class="COMM">// setup some arrays if needed</span><span class="WHIT">
<span class='line'>835</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">myEditables</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">myEditables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.editables</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>836</span> </span><span class="WHIT">    </span><span class="NAME">chDataHashes</span><span class="WHIT">    </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nestedStore.dataHashes</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>837</span> </span><span class="WHIT">    </span><span class="NAME">chRevisions</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nestedStore.revisions</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>838</span> </span><span class="WHIT">    </span><span class="NAME">chStatuses</span><span class="WHIT">      </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nestedStore.statuses</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>839</span> </span><span class="WHIT">    </span><span class="NAME">chParentRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nestedStore.parentRecords</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>840</span> </span><span class="WHIT">    </span><span class="NAME">chChildRecords</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nestedStore.childRecords</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>841</span> 
<span class='line'>842</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>843</span> </span><span class="WHIT">      </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">changes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>844</span> 
<span class='line'>845</span> </span><span class="WHIT">      </span><span class="COMM">// now copy changes</span><span class="WHIT">
<span class='line'>846</span> </span><span class="WHIT">      </span><span class="NAME">myDataHashes</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT">    </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">chDataHashes</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>847</span> </span><span class="WHIT">      </span><span class="NAME">myStatuses</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT">      </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">chStatuses</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>848</span> </span><span class="WHIT">      </span><span class="NAME">myRevisions</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">chRevisions</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>849</span> </span><span class="WHIT">      </span><span class="NAME">myParentRecords</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">chParentRecords</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>850</span> </span><span class="WHIT">      </span><span class="NAME">myChildRecords</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">chChildRecords</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>851</span> 
<span class='line'>852</span> </span><span class="WHIT">      </span><span class="NAME">myEditables</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// always make dataHash no longer editable</span><span class="WHIT">
<span class='line'>853</span> 
<span class='line'>854</span> </span><span class="WHIT">      </span><span class="NAME">this._notifyRecordPropertyChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>855</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>856</span> 
<span class='line'>857</span> </span><span class="WHIT">    </span><span class="COMM">// add any records to the changelog for commit handling</span><span class="WHIT">
<span class='line'>858</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myChangelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.changelog</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">chChangelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nestedStore.changelog</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>859</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">chChangelog</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>860</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">myChangelog</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">myChangelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.CoreSet.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>861</span> </span><span class="WHIT">      </span><span class="NAME">myChangelog.addEach</span><span class="PUNC">(</span><span class="NAME">chChangelog</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>862</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>863</span> </span><span class="WHIT">    </span><span class="NAME">this.changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">myChangelog</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>864</span> 
<span class='line'>865</span> </span><span class="WHIT">    </span><span class="COMM">// immediately flush changes to notify records - nested stores will flush</span><span class="WHIT">
<span class='line'>866</span> </span><span class="WHIT">    </span><span class="COMM">// later on.</span><span class="WHIT">
<span class='line'>867</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'parentStore'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">this.flush</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>868</span> 
<span class='line'>869</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>870</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>871</span> 
<span class='line'>872</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>873</span> </span><span class="WHIT">  </span><span class="COMM">// HIGH-LEVEL RECORD API</span><span class="WHIT">
<span class='line'>874</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>875</span> 
<span class='line'>876</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>877</span>     Finds a single record instance with the specified `recordType` and id or
<span class='line'>878</span>     an  array of records matching some query conditions.
<span class='line'>879</span> 
<span class='line'>880</span>     Finding a Single Record
<span class='line'>881</span>     ---
<span class='line'>882</span> 
<span class='line'>883</span>     If you pass a single `recordType` and id, this method will return an
<span class='line'>884</span>     actual record instance.  If the record has not been loaded into the store
<span class='line'>885</span>     yet, this method will ask the data source to retrieve it.  If no data
<span class='line'>886</span>     source indicates that it can retrieve the record, then this method will
<span class='line'>887</span>     return `null`.
<span class='line'>888</span> 
<span class='line'>889</span>     Note that if the record needs to be retrieved from the server, then the
<span class='line'>890</span>     record instance returned from this method will not have any data yet.
<span class='line'>891</span>     Instead it will have a status of `SC.Record.READY_LOADING`.  You can
<span class='line'>892</span>     monitor the status property to be notified when the record data is
<span class='line'>893</span>     available for you to use it.
<span class='line'>894</span> 
<span class='line'>895</span>     Find a Collection of Records
<span class='line'>896</span>     ---
<span class='line'>897</span> 
<span class='line'>898</span>     If you pass only a record type or a query object, you can instead find
<span class='line'>899</span>     all records matching a specified set of conditions.  When you call
<span class='line'>900</span>     `find()` in this way, it will create a query if needed and pass it to the
<span class='line'>901</span>     data source to fetch the results.
<span class='line'>902</span> 
<span class='line'>903</span>     If this is the first time you have fetched the query, then the store will
<span class='line'>904</span>     automatically ask the data source to fetch any records related to it as
<span class='line'>905</span>     well.  Otherwise you can refresh the query results at anytime by calling
<span class='line'>906</span>     `refresh()` on the returned `RecordArray`.
<span class='line'>907</span> 
<span class='line'>908</span>     You can detect whether a RecordArray is fetching from the server by
<span class='line'>909</span>     checking its status.
<span class='line'>910</span> 
<span class='line'>911</span>     Examples
<span class='line'>912</span>     ---
<span class='line'>913</span> 
<span class='line'>914</span>     Finding a single record:
<span class='line'>915</span> 
<span class='line'>916</span>         MyApp.store.find(MyApp.Contact, "23"); // returns MyApp.Contact
<span class='line'>917</span> 
<span class='line'>918</span>     Finding all records of a particular type:
<span class='line'>919</span> 
<span class='line'>920</span>         MyApp.store.find(MyApp.Contact); // returns SC.RecordArray of contacts
<span class='line'>921</span> 
<span class='line'>922</span> 
<span class='line'>923</span>     Finding all contacts with first name John:
<span class='line'>924</span> 
<span class='line'>925</span>         var query = SC.Query.local(MyApp.Contact, "firstName = %@", "John");
<span class='line'>926</span>         MyApp.store.find(query); // returns SC.RecordArray of contacts
<span class='line'>927</span> 
<span class='line'>928</span>     Finding all contacts using a remote query:
<span class='line'>929</span> 
<span class='line'>930</span>         var query = SC.Query.remote(MyApp.Contact);
<span class='line'>931</span>         MyApp.store.find(query); // returns SC.RecordArray filled by server
<span class='line'>932</span> 
<span class='line'>933</span>     @param {SC.Record|String} recordType the expected record type
<span class='line'>934</span>     @param {String} id the id to load
<span class='line'>935</span>     @returns {SC.Record} record instance or null
<span class='line'>936</span>   */</span><span class="WHIT">
<span class='line'>937</span> </span><span class="WHIT">  </span><span class="NAME">find</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>938</span> 
<span class='line'>939</span> </span><span class="WHIT">    </span><span class="COMM">// if recordType is passed as string, find object</span><span class="WHIT">
<span class='line'>940</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="NAME">SC.T_STRING</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>941</span> </span><span class="WHIT">      </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.objectForPropertyPath</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>942</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>943</span> 
<span class='line'>944</span> </span><span class="WHIT">    </span><span class="COMM">// handle passing a query...</span><span class="WHIT">
<span class='line'>945</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">arguments.length</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">recordType.get</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">recordType.get</span><span class="PUNC">(</span><span class="STRN">'isRecord'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>946</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">recordType</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"SC.Store#find() must pass recordType or query"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>947</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">recordType.isQuery</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>948</span> </span><span class="WHIT">        </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Query.local</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>949</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>950</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this._findQuery</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>951</span> 
<span class='line'>952</span> </span><span class="WHIT">    </span><span class="COMM">// handle finding a single record</span><span class="WHIT">
<span class='line'>953</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>954</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this._findRecord</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>955</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>956</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>957</span> 
<span class='line'>958</span> </span><span class="WHIT">  </span><span class="COMM">/** @private */</span><span class="WHIT">
<span class='line'>959</span> </span><span class="WHIT">  </span><span class="NAME">_findQuery</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">createIfNeeded</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">refreshIfNew</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>960</span> 
<span class='line'>961</span> </span><span class="WHIT">    </span><span class="COMM">// lookup the local RecordArray for this query.</span><span class="WHIT">
<span class='line'>962</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cache</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._scst_recordArraysByQuery</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>963</span> </span><span class="WHIT">        </span><span class="NAME">key</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.guidFor</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>964</span> </span><span class="WHIT">        </span><span class="NAME">ret</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ra</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>965</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">cache</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">cache</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._scst_recordArraysByQuery</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>966</span> </span><span class="WHIT">    </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cache</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>967</span> 
<span class='line'>968</span> </span><span class="WHIT">    </span><span class="COMM">// if a RecordArray was not found, then create one and also add it to the</span><span class="WHIT">
<span class='line'>969</span> </span><span class="WHIT">    </span><span class="COMM">// list of record arrays to update.</span><span class="WHIT">
<span class='line'>970</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">createIfNeeded</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>971</span> </span><span class="WHIT">      </span><span class="NAME">cache</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.RecordArray.create</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">store</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">query</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">query</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>972</span> 
<span class='line'>973</span> </span><span class="WHIT">      </span><span class="NAME">ra</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'recordArrays'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>974</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">ra</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">this.set</span><span class="PUNC">(</span><span class="STRN">'recordArrays'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ra</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Set.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>975</span> </span><span class="WHIT">      </span><span class="NAME">ra.add</span><span class="PUNC">(</span><span class="NAME">ret</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>976</span> 
<span class='line'>977</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">refreshIfNew</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">this.refreshQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>978</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>979</span> 
<span class='line'>980</span> </span><span class="WHIT">    </span><span class="NAME">this.flush</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>981</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>982</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>983</span> 
<span class='line'>984</span> </span><span class="WHIT">  </span><span class="COMM">/** @private */</span><span class="WHIT">
<span class='line'>985</span> </span><span class="WHIT">  </span><span class="NAME">_findRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>986</span> 
<span class='line'>987</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>988</span> 
<span class='line'>989</span> </span><span class="WHIT">    </span><span class="COMM">// if a record instance is passed, simply use the storeKey.  This allows</span><span class="WHIT">
<span class='line'>990</span> </span><span class="WHIT">    </span><span class="COMM">// you to pass a record from a chained store to get the same record in the</span><span class="WHIT">
<span class='line'>991</span> </span><span class="WHIT">    </span><span class="COMM">// current store.</span><span class="WHIT">
<span class='line'>992</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">recordType.get</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">recordType.get</span><span class="PUNC">(</span><span class="STRN">'isRecord'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>993</span> </span><span class="WHIT">      </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.get</span><span class="PUNC">(</span><span class="STRN">'storeKey'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>994</span> 
<span class='line'>995</span> </span><span class="WHIT">    </span><span class="COMM">// otherwise, lookup the storeKey for the passed id.  look in subclasses</span><span class="WHIT">
<span class='line'>996</span> </span><span class="WHIT">    </span><span class="COMM">// as well.</span><span class="WHIT">
<span class='line'>997</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">id</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>998</span> 
<span class='line'>999</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.peekStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.Record.EMPTY</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1000</span> </span><span class="WHIT">      </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.retrieveRecord</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1001</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1002</span> 
<span class='line'>1003</span> </span><span class="WHIT">    </span><span class="COMM">// now we have the storeKey, materialize the record and return it.</span><span class="WHIT">
<span class='line'>1004</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.materializeRecord</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1005</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1006</span> 
<span class='line'>1007</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>1008</span> </span><span class="WHIT">  </span><span class="COMM">// RECORD ARRAY OPERATIONS</span><span class="WHIT">
<span class='line'>1009</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1010</span> 
<span class='line'>1011</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1012</span>     Called by the record array just before it is destroyed.  This will
<span class='line'>1013</span>     de-register it from receiving future notifications.
<span class='line'>1014</span> 
<span class='line'>1015</span>     You should never call this method yourself.  Instead call `destroy()` on
<span class='line'>1016</span>     the `RecordArray` directly.
<span class='line'>1017</span> 
<span class='line'>1018</span>     @param {SC.RecordArray} recordArray the record array
<span class='line'>1019</span>     @returns {SC.Store} receiver
<span class='line'>1020</span>   */</span><span class="WHIT">
<span class='line'>1021</span> </span><span class="WHIT">  </span><span class="NAME">recordArrayWillDestroy</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1022</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cache</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._scst_recordArraysByQuery</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1023</span> </span><span class="WHIT">        </span><span class="NAME">set</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'recordArrays'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1024</span> 
<span class='line'>1025</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">cache</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">cache</span><span class="PUNC">[</span><span class="NAME">SC.guidFor</span><span class="PUNC">(</span><span class="NAME">recordArray.get</span><span class="PUNC">(</span><span class="STRN">'query'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1026</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">set</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">set.remove</span><span class="PUNC">(</span><span class="NAME">recordArray</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1027</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1028</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1029</span> 
<span class='line'>1030</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1031</span>     Called by the record array whenever it needs the data source to refresh
<span class='line'>1032</span>     its contents.  Nested stores will actually just pass this along to the
<span class='line'>1033</span>     parent store.  The parent store will call `fetch()` on the data source.
<span class='line'>1034</span> 
<span class='line'>1035</span>     You should never call this method yourself.  Instead call `refresh()` on
<span class='line'>1036</span>     the `RecordArray` directly.
<span class='line'>1037</span> 
<span class='line'>1038</span>     @param {SC.Query} query the record array query to refresh
<span class='line'>1039</span>     @returns {SC.Store} receiver
<span class='line'>1040</span>   */</span><span class="WHIT">
<span class='line'>1041</span> </span><span class="WHIT">  </span><span class="NAME">refreshQuery</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1042</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">query</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"refreshQuery() requires a query"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1043</span> 
<span class='line'>1044</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cache</span><span class="WHIT">    </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._scst_recordArraysByQuery</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1045</span> </span><span class="WHIT">        </span><span class="NAME">recArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cache</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">cache</span><span class="PUNC">[</span><span class="NAME">SC.guidFor</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1046</span> </span><span class="WHIT">        </span><span class="NAME">source</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._getDataSource</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1047</span> 
<span class='line'>1048</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">source</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">source.fetch</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1049</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">recArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recArray.storeWillFetchQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1050</span> </span><span class="WHIT">      </span><span class="NAME">source.fetch.call</span><span class="PUNC">(</span><span class="NAME">source</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">query</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1051</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1052</span> 
<span class='line'>1053</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1054</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1055</span> 
<span class='line'>1056</span> </span><span class="WHIT">  </span><span class="COMM">/** @private
<span class='line'>1057</span>     Will ask all record arrays that have been returned from `find`
<span class='line'>1058</span>     with an `SC.Query` to check their arrays with the new `storeKey`s
<span class='line'>1059</span> 
<span class='line'>1060</span>     @param {SC.IndexSet} storeKeys set of storeKeys that changed
<span class='line'>1061</span>     @param {SC.Set} recordTypes
<span class='line'>1062</span>     @returns {SC.Store} receiver
<span class='line'>1063</span>   */</span><span class="WHIT">
<span class='line'>1064</span> </span><span class="WHIT">  </span><span class="NAME">_notifyRecordArrays</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1065</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">recordArrays</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'recordArrays'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1066</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">recordArrays</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1067</span> 
<span class='line'>1068</span> </span><span class="WHIT">    </span><span class="NAME">recordArrays.forEach</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1069</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">recArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recArray.storeDidChangeStoreKeys</span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1070</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1071</span> 
<span class='line'>1072</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1073</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1074</span> 
<span class='line'>1075</span> 
<span class='line'>1076</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>1077</span> </span><span class="WHIT">  </span><span class="COMM">// LOW-LEVEL HELPERS</span><span class="WHIT">
<span class='line'>1078</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1079</span> 
<span class='line'>1080</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1081</span>     Array of all records currently in the store with the specified
<span class='line'>1082</span>     type.  This method only reflects the actual records loaded into memory and
<span class='line'>1083</span>     therefore is not usually needed at runtime.  However you will often use
<span class='line'>1084</span>     this method for testing.
<span class='line'>1085</span> 
<span class='line'>1086</span>     @param {SC.Record} recordType the record type
<span class='line'>1087</span>     @returns {SC.Array} array instance - usually SC.RecordArray
<span class='line'>1088</span>   */</span><span class="WHIT">
<span class='line'>1089</span> </span><span class="WHIT">  </span><span class="NAME">recordsFor</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1090</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1091</span> </span><span class="WHIT">        </span><span class="NAME">storeKeysById</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeysById</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1092</span> </span><span class="WHIT">        </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1093</span> 
<span class='line'>1094</span> </span><span class="WHIT">    </span><span class="COMM">// collect all non-empty store keys</span><span class="WHIT">
<span class='line'>1095</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">id</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">storeKeysById</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1096</span> </span><span class="WHIT">      </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeysById</span><span class="PUNC">[</span><span class="NAME">id</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// get the storeKey</span><span class="WHIT">
<span class='line'>1097</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">SC.RECORD_EMPTY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1098</span> </span><span class="WHIT">        </span><span class="NAME">storeKeys.push</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1099</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1100</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1101</span> 
<span class='line'>1102</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKeys.length</span><span class="PUNC">></span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1103</span> </span><span class="WHIT">      </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.RecordArray.create</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">store</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1104</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// empty array</span><span class="WHIT">
<span class='line'>1105</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1106</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1107</span> 
<span class='line'>1108</span> </span><span class="WHIT">  </span><span class="COMM">/** @private */</span><span class="WHIT">
<span class='line'>1109</span> </span><span class="WHIT">  </span><span class="NAME">_CACHED_REC_ATTRS</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1110</span> 
<span class='line'>1111</span> </span><span class="WHIT">  </span><span class="COMM">/** @private */</span><span class="WHIT">
<span class='line'>1112</span> </span><span class="WHIT">  </span><span class="NAME">_CACHED_REC_INIT</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1113</span> 
<span class='line'>1114</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1115</span>     Given a `storeKey`, return a materialized record.  You will not usually
<span class='line'>1116</span>     call this method yourself.  Instead it will used by other methods when
<span class='line'>1117</span>     you find records by id or perform other searches.
<span class='line'>1118</span> 
<span class='line'>1119</span>     If a `recordType` has been mapped to the storeKey, then a record instance
<span class='line'>1120</span>     will be returned even if the data hash has not been requested yet.
<span class='line'>1121</span> 
<span class='line'>1122</span>     Each Store instance returns unique record instances for each storeKey.
<span class='line'>1123</span> 
<span class='line'>1124</span>     @param {Number} storeKey The storeKey for the dataHash.
<span class='line'>1125</span>     @returns {SC.Record} Returns a record instance.
<span class='line'>1126</span>   */</span><span class="WHIT">
<span class='line'>1127</span> </span><span class="WHIT">  </span><span class="NAME">materializeRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1128</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">records</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.records</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1129</span> </span><span class="WHIT">      </span><span class="NAME">ret</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">attrs</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1130</span> 
<span class='line'>1131</span> </span><span class="WHIT">    </span><span class="COMM">// look up in cached records</span><span class="WHIT">
<span class='line'>1132</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">records</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">records</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.records</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// load cached records</span><span class="WHIT">
<span class='line'>1133</span> </span><span class="WHIT">    </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">records</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1134</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ret</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1135</span> 
<span class='line'>1136</span> </span><span class="WHIT">    </span><span class="COMM">// not found -- OK, create one then.</span><span class="WHIT">
<span class='line'>1137</span> </span><span class="WHIT">    </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Store.recordTypeFor</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1138</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">recordType</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// not recordType registered, nothing to do</span><span class="WHIT">
<span class='line'>1139</span> 
<span class='line'>1140</span> </span><span class="WHIT">    </span><span class="COMM">// Populate the attributes.</span><span class="WHIT">
<span class='line'>1141</span> </span><span class="WHIT">    </span><span class="NAME">attrs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._CACHED_REC_ATTRS</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1142</span> </span><span class="WHIT">    </span><span class="NAME">attrs.storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1143</span> </span><span class="WHIT">    </span><span class="NAME">attrs.store</span><span class="WHIT">    </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1144</span> 
<span class='line'>1145</span> </span><span class="WHIT">    </span><span class="COMM">// We do a little gymnastics here to prevent record initialization before we've</span><span class="WHIT">
<span class='line'>1146</span> </span><span class="WHIT">    </span><span class="COMM">// received and cached a copy of the object. This is because if initialization</span><span class="WHIT">
<span class='line'>1147</span> </span><span class="WHIT">    </span><span class="COMM">// triggers downstream effects which call materializeRecord for the same record,</span><span class="WHIT">
<span class='line'>1148</span> </span><span class="WHIT">    </span><span class="COMM">// we won't have a copy of it cached yet, causing another copy to be created</span><span class="WHIT">
<span class='line'>1149</span> </span><span class="WHIT">    </span><span class="COMM">// and resulting in a stack overflow at best and a really hard-to-diagnose bug</span><span class="WHIT">
<span class='line'>1150</span> </span><span class="WHIT">    </span><span class="COMM">// involving two instances of the same record floating around at worst.</span><span class="WHIT">
<span class='line'>1151</span> 
<span class='line'>1152</span> </span><span class="WHIT">    </span><span class="COMM">// Override _object_init to prevent premature initialization.</span><span class="WHIT">
<span class='line'>1153</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">_object_init</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.prototype._object_init</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1154</span> </span><span class="WHIT">    </span><span class="NAME">recordType.prototype._object_init</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._CACHED_REC_INIT</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1155</span> </span><span class="WHIT">    </span><span class="COMM">// Create the record (but don't init it).</span><span class="WHIT">
<span class='line'>1156</span> </span><span class="WHIT">    </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">records</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1157</span> </span><span class="WHIT">    </span><span class="COMM">// Repopulate the _object_init method and run initialization.</span><span class="WHIT">
<span class='line'>1158</span> </span><span class="WHIT">    </span><span class="NAME">recordType.prototype._object_init</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ret._object_init</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">_object_init</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1159</span> </span><span class="WHIT">    </span><span class="NAME">ret._object_init</span><span class="PUNC">(</span><span class="PUNC">[</span><span class="NAME">attrs</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1160</span> 
<span class='line'>1161</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1162</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1163</span> 
<span class='line'>1164</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>1165</span> </span><span class="WHIT">  </span><span class="COMM">// CORE RECORDS API</span><span class="WHIT">
<span class='line'>1166</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1167</span> </span><span class="WHIT">  </span><span class="COMM">// The methods in this section can be used to manipulate records without</span><span class="WHIT">
<span class='line'>1168</span> </span><span class="WHIT">  </span><span class="COMM">// actually creating record instances.</span><span class="WHIT">
<span class='line'>1169</span> 
<span class='line'>1170</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1171</span>     Creates a new record instance with the passed `recordType` and `dataHash`.
<span class='line'>1172</span>     You can also optionally specify an id or else it will be pulled from the
<span class='line'>1173</span>     data hash.
<span class='line'>1174</span> 
<span class='line'>1175</span>     Example:
<span class='line'>1176</span> 
<span class='line'>1177</span>       MyApp.Record = SC.Record.extend({
<span class='line'>1178</span>         attrA: SC.Record.attr(String, { defaultValue: 'def' }),
<span class='line'>1179</span>         isAttrB: SC.Record.attr(Boolean, { key: 'attr_b' }),
<span class='line'>1180</span>         primaryKey: 'pKey'
<span class='line'>1181</span>       });
<span class='line'>1182</span> 
<span class='line'>1183</span>       // If you don't provide a value and have designated a defaultValue, the
<span class='line'>1184</span>       // defaultValue will be used.
<span class='line'>1185</span>       MyApp.store.createRecord(MyApp.Record).get('attributes');
<span class='line'>1186</span>       > { attrA: 'def' }
<span class='line'>1187</span> 
<span class='line'>1188</span>       // If you use a key on an attribute, you can specify the key name or the
<span class='line'>1189</span>       // attribute name when creating the record, but if you specify both, only
<span class='line'>1190</span>       // the key name will be used.
<span class='line'>1191</span>       MyApp.store.createRecord(MyApp.Record, { isAttrB: YES }).get('attributes');
<span class='line'>1192</span>       > { attr_b: YES }
<span class='line'>1193</span>       MyApp.store.createRecord(MyApp.Record, { attr_b: YES }).get('attributes');
<span class='line'>1194</span>       > { attr_b: YES }
<span class='line'>1195</span>       MyApp.store.createRecord(MyApp.Record, { isAttrB: NO, attr_b: YES }).get('attributes');
<span class='line'>1196</span>       > { attr_b: YES }
<span class='line'>1197</span> 
<span class='line'>1198</span>     Note that the record will not yet be saved back to the server.  To save
<span class='line'>1199</span>     a record to the server, call `commitChanges()` on the store.
<span class='line'>1200</span> 
<span class='line'>1201</span>     @param {SC.Record} recordType the record class to use on creation
<span class='line'>1202</span>     @param {Hash} dataHash the JSON attributes to assign to the hash.
<span class='line'>1203</span>     @param {String} id (optional) id to assign to record
<span class='line'>1204</span> 
<span class='line'>1205</span>     @returns {SC.Record} Returns the created record
<span class='line'>1206</span>   */</span><span class="WHIT">
<span class='line'>1207</span> </span><span class="WHIT">  </span><span class="NAME">createRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1208</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">primaryKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">prototype</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">changelog</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">defaultVal</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1209</span> 
<span class='line'>1210</span> </span><span class="WHIT">    </span><span class="COMM">//initialize dataHash if necessary</span><span class="WHIT">
<span class='line'>1211</span> </span><span class="WHIT">    </span><span class="NAME">dataHash</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">dataHash</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1212</span> 
<span class='line'>1213</span> </span><span class="WHIT">    </span><span class="COMM">// First, try to get an id.  If no id is passed, look it up in the</span><span class="WHIT">
<span class='line'>1214</span> </span><span class="WHIT">    </span><span class="COMM">// dataHash.</span><span class="WHIT">
<span class='line'>1215</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">primaryKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.prototype.primaryKey</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1216</span> </span><span class="WHIT">      </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">[</span><span class="NAME">primaryKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1217</span> </span><span class="WHIT">      </span><span class="COMM">// if still no id, check if there is a defaultValue function for</span><span class="WHIT">
<span class='line'>1218</span> </span><span class="WHIT">      </span><span class="COMM">// the primaryKey attribute and assign that</span><span class="WHIT">
<span class='line'>1219</span> </span><span class="WHIT">      </span><span class="NAME">defaultVal</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.prototype</span><span class="PUNC">[</span><span class="NAME">primaryKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">recordType.prototype</span><span class="PUNC">[</span><span class="NAME">primaryKey</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">defaultValue</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1220</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">defaultVal</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="NAME">SC.T_FUNCTION</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1221</span> </span><span class="WHIT">        </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">[</span><span class="NAME">primaryKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">defaultVal</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1222</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1223</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1224</span> 
<span class='line'>1225</span> </span><span class="WHIT">    </span><span class="COMM">// Next get the storeKey - base on id if available</span><span class="WHIT">
<span class='line'>1226</span> </span><span class="WHIT">    </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">id</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">SC.Store.generateStoreKey</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1227</span> 
<span class='line'>1228</span> </span><span class="WHIT">    </span><span class="COMM">// now, check the state and do the right thing.</span><span class="WHIT">
<span class='line'>1229</span> </span><span class="WHIT">    </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1230</span> 
<span class='line'>1231</span> </span><span class="WHIT">    </span><span class="COMM">// check state</span><span class="WHIT">
<span class='line'>1232</span> </span><span class="WHIT">    </span><span class="COMM">// any busy or ready state or destroyed dirty state is not allowed</span><span class="WHIT">
<span class='line'>1233</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.BUSY</span><span class="PUNC">)</span><span class="WHIT">  </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>1234</span> </span><span class="WHIT">        </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.READY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>1235</span> </span><span class="WHIT">        </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_DIRTY</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1236</span> </span><span class="WHIT">      </span><span class="PUNC">(</span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">K.RECORD_EXISTS_ERROR</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">K.BAD_STATE_ERROR</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="KEYW">throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1237</span> 
<span class='line'>1238</span> </span><span class="WHIT">    </span><span class="COMM">// allow error or destroyed state only with id</span><span class="WHIT">
<span class='line'>1239</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="PUNC">===</span><span class="NAME">SC.DESTROYED_CLEAN</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">===</span><span class="NAME">SC.ERROR</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1240</span> </span><span class="WHIT">      </span><span class="NAME">K.BAD_STATE_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1241</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1242</span> 
<span class='line'>1243</span> </span><span class="WHIT">    </span><span class="COMM">// Store the dataHash and setup initial status.</span><span class="WHIT">
<span class='line'>1244</span> </span><span class="WHIT">    </span><span class="NAME">this.writeDataHash</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K.READY_NEW</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1245</span> 
<span class='line'>1246</span> </span><span class="WHIT">    </span><span class="COMM">// Register the recordType with the store.</span><span class="WHIT">
<span class='line'>1247</span> </span><span class="WHIT">    </span><span class="NAME">SC.Store.replaceRecordTypeFor</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1248</span> </span><span class="WHIT">    </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1249</span> 
<span class='line'>1250</span> </span><span class="WHIT">    </span><span class="COMM">// If the attribute wasn't provided in the dataHash, attempt to insert a</span><span class="WHIT">
<span class='line'>1251</span> </span><span class="WHIT">    </span><span class="COMM">// default value.  We have to do this after materializing the record,</span><span class="WHIT">
<span class='line'>1252</span> </span><span class="WHIT">    </span><span class="COMM">// because the defaultValue property may be a function that expects</span><span class="WHIT">
<span class='line'>1253</span> </span><span class="WHIT">    </span><span class="COMM">// the record as an argument.</span><span class="WHIT">
<span class='line'>1254</span> </span><span class="WHIT">    </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.materializeRecord</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1255</span> </span><span class="WHIT">    </span><span class="NAME">prototype</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.prototype</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1256</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">prop</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">prototype</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1257</span> </span><span class="WHIT">      </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">propPrototype</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">prototype</span><span class="PUNC">[</span><span class="WHIT"> </span><span class="NAME">prop</span><span class="WHIT"> </span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1258</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">propPrototype</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">propPrototype.isRecordAttribute</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1259</span> </span><span class="WHIT">        </span><span class="COMM">// Use the record attribute key if it is defined.</span><span class="WHIT">
<span class='line'>1260</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">attrKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">propPrototype.key</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">prop</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1261</span> 
<span class='line'>1262</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">dataHash.hasOwnProperty</span><span class="PUNC">(</span><span class="NAME">attrKey</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1263</span> </span><span class="WHIT">          </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">dataHash.hasOwnProperty</span><span class="PUNC">(</span><span class="NAME">prop</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1264</span> </span><span class="WHIT">            </span><span class="COMM">// If the attribute key doesn't exist but the name does, fix it up.</span><span class="WHIT">
<span class='line'>1265</span> </span><span class="WHIT">            </span><span class="COMM">// (i.e. the developer has a record attribute `endDate` with a key</span><span class="WHIT">
<span class='line'>1266</span> </span><span class="WHIT">            </span><span class="COMM">// `end_date` on a record and when they created the record they</span><span class="WHIT">
<span class='line'>1267</span> </span><span class="WHIT">            </span><span class="COMM">// provided `endDate` not `end_date`)</span><span class="WHIT">
<span class='line'>1268</span> </span><span class="WHIT">            </span><span class="NAME">dataHash</span><span class="PUNC">[</span><span class="WHIT"> </span><span class="NAME">attrKey</span><span class="WHIT"> </span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">[</span><span class="WHIT"> </span><span class="NAME">prop</span><span class="WHIT"> </span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1269</span> </span><span class="WHIT">            </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">[</span><span class="WHIT"> </span><span class="NAME">prop</span><span class="WHIT"> </span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1270</span> </span><span class="WHIT">          </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1271</span> </span><span class="WHIT">            </span><span class="COMM">// If the attribute doesn't exist in the hash at all, check for a</span><span class="WHIT">
<span class='line'>1272</span> </span><span class="WHIT">            </span><span class="COMM">// default value to use instead.</span><span class="WHIT">
<span class='line'>1273</span> </span><span class="WHIT">            </span><span class="NAME">defaultVal</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">propPrototype.defaultValue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1274</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">defaultVal</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1275</span> </span><span class="WHIT">              </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">defaultVal</span><span class="PUNC">)</span><span class="PUNC">===</span><span class="NAME">SC.T_FUNCTION</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">[</span><span class="WHIT"> </span><span class="NAME">attrKey</span><span class="WHIT"> </span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.copy</span><span class="PUNC">(</span><span class="NAME">defaultVal</span><span class="PUNC">(</span><span class="NAME">ret</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">attrKey</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1276</span> </span><span class="WHIT">              </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">[</span><span class="WHIT"> </span><span class="NAME">attrKey</span><span class="WHIT"> </span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.copy</span><span class="PUNC">(</span><span class="NAME">defaultVal</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1277</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1278</span> </span><span class="WHIT">          </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1279</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">attrKey</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">prop</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">dataHash.hasOwnProperty</span><span class="PUNC">(</span><span class="NAME">prop</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1280</span> </span><span class="WHIT">          </span><span class="COMM">// If both attrKey and prop are provided, use attrKey only.</span><span class="WHIT">
<span class='line'>1281</span> </span><span class="WHIT">          </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">[</span><span class="WHIT"> </span><span class="NAME">prop</span><span class="WHIT"> </span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1282</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1283</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1284</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1285</span> 
<span class='line'>1286</span> </span><span class="WHIT">    </span><span class="COMM">// Record is now in a committable state -- add storeKey to changelog</span><span class="WHIT">
<span class='line'>1287</span> </span><span class="WHIT">    </span><span class="NAME">changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.changelog</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1288</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">changelog</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Set.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1289</span> </span><span class="WHIT">    </span><span class="NAME">changelog.add</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1290</span> </span><span class="WHIT">    </span><span class="NAME">this.changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">changelog</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1291</span> 
<span class='line'>1292</span> </span><span class="WHIT">    </span><span class="COMM">// if commit records is enabled</span><span class="WHIT">
<span class='line'>1293</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'commitRecordsAutomatically'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1294</span> </span><span class="WHIT">      </span><span class="NAME">this.invokeLast</span><span class="PUNC">(</span><span class="NAME">this.commitRecords</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1295</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1296</span> 
<span class='line'>1297</span> </span><span class="WHIT">    </span><span class="COMM">// Propagate the status to any aggregate records before returning.</span><span class="WHIT">
<span class='line'>1298</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ret</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">ret.propagateToAggregates</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1299</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1300</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1301</span> 
<span class='line'>1302</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1303</span>     Creates an array of new records.  You must pass an array of `dataHash`es
<span class='line'>1304</span>     plus a `recordType` and, optionally, an array of ids.  This will create an
<span class='line'>1305</span>     array of record instances with the same record type.
<span class='line'>1306</span> 
<span class='line'>1307</span>     If you need to instead create a bunch of records with different data types
<span class='line'>1308</span>     you can instead pass an array of `recordType`s, one for each data hash.
<span class='line'>1309</span> 
<span class='line'>1310</span>     @param {SC.Record|Array} recordTypes class or array of classes
<span class='line'>1311</span>     @param {Array} dataHashes array of data hashes
<span class='line'>1312</span>     @param {Array} ids (optional) ids to assign to records
<span class='line'>1313</span>     @returns {Array} array of materialized record instances.
<span class='line'>1314</span>   */</span><span class="WHIT">
<span class='line'>1315</span> </span><span class="WHIT">  </span><span class="NAME">createRecords</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHashes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1316</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dataHashes.length</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1317</span> </span><span class="WHIT">    </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_ARRAY</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1318</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1319</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1320</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1321</span> </span><span class="WHIT">      </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1322</span> </span><span class="WHIT">      </span><span class="NAME">ret.push</span><span class="PUNC">(</span><span class="NAME">this.createRecord</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHashes</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1323</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1324</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1325</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1326</span> 
<span class='line'>1327</span> 
<span class='line'>1328</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1329</span>     Unloads a record, removing the data hash from the store.  If you try to
<span class='line'>1330</span>     unload a record that is already destroyed then this method will have no effect.
<span class='line'>1331</span>     If you unload a record that does not exist or an error then an exception
<span class='line'>1332</span>     will be raised.
<span class='line'>1333</span> 
<span class='line'>1334</span>     @param {SC.Record} recordType the recordType
<span class='line'>1335</span>     @param {String} id the record id
<span class='line'>1336</span>     @param {Number} storeKey (optional) if passed, ignores recordType and id
<span class='line'>1337</span>     @returns {SC.Store} receiver
<span class='line'>1338</span>   */</span><span class="WHIT">
<span class='line'>1339</span> </span><span class="WHIT">  </span><span class="NAME">unloadRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newStatus</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1340</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1341</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1342</span> </span><span class="WHIT">    </span><span class="NAME">newStatus</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newStatus</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">K.EMPTY</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1343</span> </span><span class="WHIT">    </span><span class="COMM">// handle status - ignore if destroying or destroyed</span><span class="WHIT">
<span class='line'>1344</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.BUSY_DESTROYING</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1345</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// nothing to do</span><span class="WHIT">
<span class='line'>1346</span> 
<span class='line'>1347</span> </span><span class="WHIT">    </span><span class="COMM">// error out if empty</span><span class="WHIT">
<span class='line'>1348</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.BUSY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1349</span> </span><span class="WHIT">      </span><span class="NAME">K.BUSY_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1350</span> 
<span class='line'>1351</span> </span><span class="WHIT">    </span><span class="COMM">// otherwise, destroy in dirty state</span><span class="WHIT">
<span class='line'>1352</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newStatus</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1353</span> 
<span class='line'>1354</span> </span><span class="WHIT">    </span><span class="COMM">// remove the data hash, set the new status and remove the cached record.</span><span class="WHIT">
<span class='line'>1355</span> </span><span class="WHIT">    </span><span class="NAME">this.removeDataHash</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1356</span> </span><span class="WHIT">    </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1357</span> </span><span class="WHIT">    </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">this.records</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1358</span> 
<span class='line'>1359</span> </span><span class="WHIT">    </span><span class="COMM">// If this record is a parent record, unregister all of its child records.</span><span class="WHIT">
<span class='line'>1360</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">that</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1361</span> </span><span class="WHIT">    </span><span class="NAME">this._propagateToChildren</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1362</span> </span><span class="WHIT">      </span><span class="NAME">that.unregisterChildFromParent</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1363</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1364</span> 
<span class='line'>1365</span> </span><span class="WHIT">    </span><span class="COMM">// If this record is a parent record, its child records have been cleared so also clear the</span><span class="WHIT">
<span class='line'>1366</span> </span><span class="WHIT">    </span><span class="COMM">// cached reference as well.</span><span class="WHIT">
<span class='line'>1367</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.parentRecords</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1368</span> </span><span class="WHIT">      </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">this.parentRecords</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1369</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1370</span> 
<span class='line'>1371</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1372</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1373</span> 
<span class='line'>1374</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1375</span>     Unloads a group of records.  If you have a set of record ids, unloading
<span class='line'>1376</span>     them this way can be faster than retrieving each record and unloading
<span class='line'>1377</span>     it individually.
<span class='line'>1378</span> 
<span class='line'>1379</span>     You can pass either a single `recordType` or an array of `recordType`s. If
<span class='line'>1380</span>     you pass a single `recordType`, then the record type will be used for each
<span class='line'>1381</span>     record.  If you pass an array, then each id must have a matching record
<span class='line'>1382</span>     type in the array.
<span class='line'>1383</span> 
<span class='line'>1384</span>     You can optionally pass an array of `storeKey`s instead of the `recordType`
<span class='line'>1385</span>     and ids.  In this case the first two parameters will be ignored.  This
<span class='line'>1386</span>     is usually only used by low-level internal methods.  You will not usually
<span class='line'>1387</span>     unload records this way.
<span class='line'>1388</span> 
<span class='line'>1389</span>     @param {SC.Record|Array} recordTypes class or array of classes
<span class='line'>1390</span>     @param {Array} [ids] ids to unload
<span class='line'>1391</span>     @param {Array} [storeKeys] store keys to unload
<span class='line'>1392</span>     @returns {SC.Store} receiver
<span class='line'>1393</span>   */</span><span class="WHIT">
<span class='line'>1394</span> </span><span class="WHIT">  </span><span class="NAME">unloadRecords</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newStatus</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1395</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1396</span> 
<span class='line'>1397</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1398</span> </span><span class="WHIT">      </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_ARRAY</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1399</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1400</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ids</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1401</span> </span><span class="WHIT">        </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">recordTypes.length</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1402</span> </span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1403</span> </span><span class="WHIT">          </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1404</span> </span><span class="WHIT">          </span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.storeKeysFor</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1405</span> </span><span class="WHIT">          </span><span class="NAME">this.unloadRecords</span><span class="PUNC">(</span><span class="NAME">undefined</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newStatus</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1406</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1407</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1408</span> </span><span class="WHIT">        </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ids.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1409</span> </span><span class="WHIT">        </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1410</span> </span><span class="WHIT">          </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1411</span> </span><span class="WHIT">          </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1412</span> </span><span class="WHIT">          </span><span class="NAME">this.unloadRecord</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newStatus</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1413</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1414</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1415</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1416</span> </span><span class="WHIT">      </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1417</span> </span><span class="WHIT">      </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1418</span> </span><span class="WHIT">        </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1419</span> </span><span class="WHIT">        </span><span class="NAME">this.unloadRecord</span><span class="PUNC">(</span><span class="NAME">undefined</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newStatus</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1420</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1421</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1422</span> 
<span class='line'>1423</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1424</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1425</span> 
<span class='line'>1426</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1427</span>     Destroys a record, removing the data hash from the store and adding the
<span class='line'>1428</span>     record to the destroyed changelog.  If you try to destroy a record that is
<span class='line'>1429</span>     already destroyed then this method will have no effect.  If you destroy a
<span class='line'>1430</span>     record that does not exist or an error then an exception will be raised.
<span class='line'>1431</span> 
<span class='line'>1432</span>     @param {SC.Record} recordType the recordType
<span class='line'>1433</span>     @param {String} id the record id
<span class='line'>1434</span>     @param {Number} storeKey (optional) if passed, ignores recordType and id
<span class='line'>1435</span>     @returns {SC.Store} receiver
<span class='line'>1436</span>   */</span><span class="WHIT">
<span class='line'>1437</span> </span><span class="WHIT">  </span><span class="NAME">destroyRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1438</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1439</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">changelog</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1440</span> 
<span class='line'>1441</span> </span><span class="WHIT">    </span><span class="COMM">// handle status - ignore if destroying or destroyed</span><span class="WHIT">
<span class='line'>1442</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.BUSY_DESTROYING</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1443</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// nothing to do</span><span class="WHIT">
<span class='line'>1444</span> 
<span class='line'>1445</span> </span><span class="WHIT">    </span><span class="COMM">// error out if empty</span><span class="WHIT">
<span class='line'>1446</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.EMPTY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1447</span> </span><span class="WHIT">      </span><span class="NAME">K.NOT_FOUND_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1448</span> 
<span class='line'>1449</span> </span><span class="WHIT">    </span><span class="COMM">// error out if busy</span><span class="WHIT">
<span class='line'>1450</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.BUSY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1451</span> </span><span class="WHIT">      </span><span class="NAME">K.BUSY_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1452</span> 
<span class='line'>1453</span> </span><span class="WHIT">    </span><span class="COMM">// if new status, destroy in clean state</span><span class="WHIT">
<span class='line'>1454</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.READY_NEW</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1455</span> </span><span class="WHIT">      </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_CLEAN</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1456</span> </span><span class="WHIT">      </span><span class="NAME">this.removeDataHash</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1457</span> 
<span class='line'>1458</span> </span><span class="WHIT">    </span><span class="COMM">// otherwise, destroy in dirty state</span><span class="WHIT">
<span class='line'>1459</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_DIRTY</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1460</span> 
<span class='line'>1461</span> </span><span class="WHIT">    </span><span class="COMM">// remove the data hash, set new status</span><span class="WHIT">
<span class='line'>1462</span> </span><span class="WHIT">    </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1463</span> </span><span class="WHIT">    </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1464</span> 
<span class='line'>1465</span> </span><span class="WHIT">    </span><span class="COMM">// add/remove change log</span><span class="WHIT">
<span class='line'>1466</span> </span><span class="WHIT">    </span><span class="NAME">changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.changelog</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1467</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">changelog</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Set.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1468</span> 
<span class='line'>1469</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.DIRTY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">changelog.add</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1470</span> </span><span class="WHIT">    </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">changelog.remove</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1471</span> </span><span class="WHIT">    </span><span class="NAME">this.changelog</span><span class="PUNC">=</span><span class="NAME">changelog</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1472</span> 
<span class='line'>1473</span> </span><span class="WHIT">    </span><span class="COMM">// if commit records is enabled</span><span class="WHIT">
<span class='line'>1474</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'commitRecordsAutomatically'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1475</span> </span><span class="WHIT">      </span><span class="NAME">this.invokeLast</span><span class="PUNC">(</span><span class="NAME">this.commitRecords</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1476</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1477</span> 
<span class='line'>1478</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">that</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1479</span> </span><span class="WHIT">    </span><span class="NAME">this._propagateToChildren</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1480</span> </span><span class="WHIT">      </span><span class="NAME">that.destroyRecord</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1481</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1482</span> 
<span class='line'>1483</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1484</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1485</span> 
<span class='line'>1486</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1487</span>     Destroys a group of records.  If you have a set of record ids, destroying
<span class='line'>1488</span>     them this way can be faster than retrieving each record and destroying
<span class='line'>1489</span>     it individually.
<span class='line'>1490</span> 
<span class='line'>1491</span>     You can pass either a single `recordType` or an array of `recordType`s. If
<span class='line'>1492</span>     you pass a single `recordType`, then the record type will be used for each
<span class='line'>1493</span>     record.  If you pass an array, then each id must have a matching record
<span class='line'>1494</span>     type in the array.
<span class='line'>1495</span> 
<span class='line'>1496</span>     You can optionally pass an array of `storeKey`s instead of the `recordType`
<span class='line'>1497</span>     and ids.  In this case the first two parameters will be ignored.  This
<span class='line'>1498</span>     is usually only used by low-level internal methods.  You will not usually
<span class='line'>1499</span>     destroy records this way.
<span class='line'>1500</span> 
<span class='line'>1501</span>     @param {SC.Record|Array} recordTypes class or array of classes
<span class='line'>1502</span>     @param {Array} ids ids to destroy
<span class='line'>1503</span>     @param {Array} storeKeys (optional) store keys to destroy
<span class='line'>1504</span>     @returns {SC.Store} receiver
<span class='line'>1505</span>   */</span><span class="WHIT">
<span class='line'>1506</span> </span><span class="WHIT">  </span><span class="NAME">destroyRecords</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1507</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1508</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="PUNC">===</span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1509</span> </span><span class="WHIT">      </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ids.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1510</span> </span><span class="WHIT">      </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_ARRAY</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1511</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1512</span> </span><span class="WHIT">      </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1513</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1514</span> </span><span class="WHIT">        </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1515</span> </span><span class="WHIT">        </span><span class="NAME">this.destroyRecord</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1516</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1517</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1518</span> </span><span class="WHIT">      </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1519</span> </span><span class="WHIT">      </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1520</span> </span><span class="WHIT">        </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1521</span> </span><span class="WHIT">        </span><span class="NAME">this.destroyRecord</span><span class="PUNC">(</span><span class="NAME">undefined</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1522</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1523</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1524</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1525</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1526</span> 
<span class='line'>1527</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1528</span>     register a Child Record to the parent
<span class='line'>1529</span>   */</span><span class="WHIT">
<span class='line'>1530</span> </span><span class="WHIT">  </span><span class="NAME">registerChildToParent</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">parentStoreKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">childStoreKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">path</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1531</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parentRecords</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">childRecords</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">oldPk</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">oldChildren</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pkRef</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1532</span> 
<span class='line'>1533</span> </span><span class="WHIT">    </span><span class="COMM">// Check the child to see if it has a parent</span><span class="WHIT">
<span class='line'>1534</span> </span><span class="WHIT">    </span><span class="NAME">childRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.childRecords</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1535</span> </span><span class="WHIT">    </span><span class="NAME">parentRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.parentRecords</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1536</span> 
<span class='line'>1537</span> </span><span class="WHIT">    </span><span class="COMM">// first rid of the old parent</span><span class="WHIT">
<span class='line'>1538</span> </span><span class="WHIT">    </span><span class="NAME">oldPk</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">childRecords</span><span class="PUNC">[</span><span class="NAME">childStoreKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1539</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">oldPk</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1540</span> </span><span class="WHIT">      </span><span class="NAME">oldChildren</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentRecords</span><span class="PUNC">[</span><span class="NAME">oldPk</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1541</span> </span><span class="WHIT">      </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">oldChildren</span><span class="PUNC">[</span><span class="NAME">childStoreKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1542</span> </span><span class="WHIT">      </span><span class="COMM">// this.recordDidChange(null, null, oldPk, key);</span><span class="WHIT">
<span class='line'>1543</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1544</span> </span><span class="WHIT">    </span><span class="NAME">pkRef</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentRecords</span><span class="PUNC">[</span><span class="NAME">parentStoreKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1545</span> </span><span class="WHIT">    </span><span class="NAME">pkRef</span><span class="PUNC">[</span><span class="NAME">childStoreKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">path</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1546</span> </span><span class="WHIT">    </span><span class="NAME">parentRecords</span><span class="PUNC">[</span><span class="NAME">parentStoreKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">pkRef</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1547</span> </span><span class="WHIT">    </span><span class="NAME">childRecords</span><span class="PUNC">[</span><span class="NAME">childStoreKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentStoreKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1548</span> 
<span class='line'>1549</span> </span><span class="WHIT">    </span><span class="COMM">// sync the status of the child</span><span class="WHIT">
<span class='line'>1550</span> </span><span class="WHIT">    </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">childStoreKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.statuses</span><span class="PUNC">[</span><span class="NAME">parentStoreKey</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1551</span> </span><span class="WHIT">    </span><span class="NAME">this.childRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">childRecords</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1552</span> </span><span class="WHIT">    </span><span class="NAME">this.parentRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentRecords</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1553</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1554</span> 
<span class='line'>1555</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1556</span>     Unregister the Child Record from its Parent.  This will cause the Child
<span class='line'>1557</span>     Record to be removed from the store.
<span class='line'>1558</span> 
<span class='line'>1559</span>     @param {Number} childStoreKey storeKey to unregister
<span class='line'>1560</span>   */</span><span class="WHIT">
<span class='line'>1561</span> </span><span class="WHIT">  </span><span class="NAME">unregisterChildFromParent</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">childStoreKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1562</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">childRecords</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">oldPk</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1563</span> </span><span class="WHIT">        </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.recordTypeFor</span><span class="PUNC">(</span><span class="NAME">childStoreKey</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1564</span> </span><span class="WHIT">        </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.idFor</span><span class="PUNC">(</span><span class="NAME">childStoreKey</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1565</span> </span><span class="WHIT">        </span><span class="NAME">that</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1566</span> 
<span class='line'>1567</span> </span><span class="WHIT">    </span><span class="COMM">// Check the child to see if it has a parent</span><span class="WHIT">
<span class='line'>1568</span> </span><span class="WHIT">    </span><span class="NAME">childRecords</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.childRecords</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1569</span> 
<span class='line'>1570</span> </span><span class="WHIT">    </span><span class="COMM">// Remove the child.</span><span class="WHIT">
<span class='line'>1571</span> </span><span class="WHIT">    </span><span class="COMM">// 1. from the cache of data hashes</span><span class="WHIT">
<span class='line'>1572</span> </span><span class="WHIT">    </span><span class="COMM">// 2. from the cache of record objects</span><span class="WHIT">
<span class='line'>1573</span> </span><span class="WHIT">    </span><span class="COMM">// 3. from the cache of child record store keys</span><span class="WHIT">
<span class='line'>1574</span> </span><span class="WHIT">    </span><span class="NAME">this.removeDataHash</span><span class="PUNC">(</span><span class="NAME">childStoreKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1575</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.records</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1576</span> </span><span class="WHIT">      </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">this.records</span><span class="PUNC">[</span><span class="NAME">childStoreKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1577</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1578</span> 
<span class='line'>1579</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">childRecords</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1580</span> </span><span class="WHIT">      </span><span class="COMM">// Remove the parent's connection to the child.  This doesn't remove the</span><span class="WHIT">
<span class='line'>1581</span> </span><span class="WHIT">      </span><span class="COMM">// parent store key from the cache of parent store keys if the parent</span><span class="WHIT">
<span class='line'>1582</span> </span><span class="WHIT">      </span><span class="COMM">// no longer has any other registered children, because the amount of effort</span><span class="WHIT">
<span class='line'>1583</span> </span><span class="WHIT">      </span><span class="COMM">// to determine that would not be worth the miniscule memory savings.</span><span class="WHIT">
<span class='line'>1584</span> </span><span class="WHIT">      </span><span class="NAME">oldPk</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">childRecords</span><span class="PUNC">[</span><span class="NAME">childStoreKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1585</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">oldPk</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1586</span> </span><span class="WHIT">        </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">this.parentRecords</span><span class="PUNC">[</span><span class="NAME">oldPk</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">childStoreKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1587</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1588</span> 
<span class='line'>1589</span> </span><span class="WHIT">      </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">childRecords</span><span class="PUNC">[</span><span class="NAME">childStoreKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1590</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1591</span> 
<span class='line'>1592</span> </span><span class="WHIT">    </span><span class="COMM">// 4. from the cache of ids</span><span class="WHIT">
<span class='line'>1593</span> </span><span class="WHIT">    </span><span class="COMM">// 5. from the cache of store keys</span><span class="WHIT">
<span class='line'>1594</span> </span><span class="WHIT">    </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">SC.Store.idsByStoreKey</span><span class="PUNC">[</span><span class="NAME">childStoreKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1595</span> </span><span class="WHIT">    </span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeysById</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1596</span> </span><span class="WHIT">    </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">[</span><span class="NAME">id</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1597</span> 
<span class='line'>1598</span> </span><span class="WHIT">    </span><span class="NAME">this._propagateToChildren</span><span class="PUNC">(</span><span class="NAME">childStoreKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1599</span> </span><span class="WHIT">      </span><span class="NAME">that.unregisterChildFromParent</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1600</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1601</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1602</span> 
<span class='line'>1603</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1604</span>     materialize the parent when passing in a store key for the child
<span class='line'>1605</span>   */</span><span class="WHIT">
<span class='line'>1606</span> </span><span class="WHIT">  </span><span class="NAME">materializeParentRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">childStoreKey</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1607</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pk</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">crs</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1608</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">SC.none</span><span class="PUNC">(</span><span class="NAME">childStoreKey</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1609</span> </span><span class="WHIT">    </span><span class="NAME">crs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.childRecords</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1610</span> </span><span class="WHIT">    </span><span class="NAME">pk</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">crs</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">this.childRecords</span><span class="PUNC">[</span><span class="NAME">childStoreKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1611</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">SC.none</span><span class="PUNC">(</span><span class="NAME">pk</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1612</span> 
<span class='line'>1613</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.materializeRecord</span><span class="PUNC">(</span><span class="NAME">pk</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1614</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1615</span> 
<span class='line'>1616</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1617</span>     function for retrieving a parent record key
<span class='line'>1618</span> 
<span class='line'>1619</span>     @param {Number} storeKey The store key of the parent
<span class='line'>1620</span>   */</span><span class="WHIT">
<span class='line'>1621</span> </span><span class="WHIT">  </span><span class="NAME">parentStoreKeyExists</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1622</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">SC.none</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1623</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">crs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.childRecords</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1624</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">crs</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1625</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1626</span> 
<span class='line'>1627</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1628</span>     function that propagates a function call to all children
<span class='line'>1629</span>   */</span><span class="WHIT">
<span class='line'>1630</span> </span><span class="WHIT">  </span><span class="NAME">_propagateToChildren</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">func</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1631</span> </span><span class="WHIT">    </span><span class="COMM">// Handle all the child Records</span><span class="WHIT">
<span class='line'>1632</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">SC.none</span><span class="PUNC">(</span><span class="NAME">this.parentRecords</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1633</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">children</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.parentRecords</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1634</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">SC.none</span><span class="PUNC">(</span><span class="NAME">func</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1635</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">key</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">children</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1636</span> </span><span class="WHIT">      </span><span class="COMM">// for .. in makes the key a String, but be sure to pass a Number to the</span><span class="WHIT">
<span class='line'>1637</span> </span><span class="WHIT">      </span><span class="COMM">// function.</span><span class="WHIT">
<span class='line'>1638</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">children.hasOwnProperty</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">func</span><span class="PUNC">(</span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1639</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1640</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1641</span> 
<span class='line'>1642</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1643</span>     Notes that the data for the given record id has changed.  The record will
<span class='line'>1644</span>     be committed to the server the next time you commit the root store.  Only
<span class='line'>1645</span>     call this method on a record in a READY state of some type.
<span class='line'>1646</span> 
<span class='line'>1647</span>     @param {SC.Record} recordType the recordType
<span class='line'>1648</span>     @param {String} id the record id
<span class='line'>1649</span>     @param {Number} storeKey (optional) if passed, ignores recordType and id
<span class='line'>1650</span>     @param {String} key that changed (optional)
<span class='line'>1651</span>     @param {Boolean} if the change is to statusOnly (optional)
<span class='line'>1652</span>     @returns {SC.Store} receiver
<span class='line'>1653</span>   */</span><span class="WHIT">
<span class='line'>1654</span> </span><span class="WHIT">  </span><span class="NAME">recordDidChange</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">key</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">statusOnly</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1655</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1656</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">changelog</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1657</span> 
<span class='line'>1658</span> </span><span class="WHIT">    </span><span class="COMM">// BUSY_LOADING, BUSY_CREATING, BUSY_COMMITTING, BUSY_REFRESH_CLEAN</span><span class="WHIT">
<span class='line'>1659</span> </span><span class="WHIT">    </span><span class="COMM">// BUSY_REFRESH_DIRTY, BUSY_DESTROYING</span><span class="WHIT">
<span class='line'>1660</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.BUSY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1661</span> </span><span class="WHIT">      </span><span class="NAME">K.BUSY_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1662</span> 
<span class='line'>1663</span> </span><span class="WHIT">    </span><span class="COMM">// if record is not in ready state, then it is not found.</span><span class="WHIT">
<span class='line'>1664</span> </span><span class="WHIT">    </span><span class="COMM">// ERROR, EMPTY, DESTROYED_CLEAN, DESTROYED_DIRTY</span><span class="WHIT">
<span class='line'>1665</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.READY</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1666</span> </span><span class="WHIT">      </span><span class="NAME">K.NOT_FOUND_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1667</span> 
<span class='line'>1668</span> </span><span class="WHIT">    </span><span class="COMM">// otherwise, make new status READY_DIRTY unless new.</span><span class="WHIT">
<span class='line'>1669</span> </span><span class="WHIT">    </span><span class="COMM">// K.READY_CLEAN, K.READY_DIRTY, ignore K.READY_NEW</span><span class="WHIT">
<span class='line'>1670</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1671</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">K.READY_NEW</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K.READY_DIRTY</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1672</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1673</span> 
<span class='line'>1674</span> </span><span class="WHIT">    </span><span class="COMM">// record data hash change</span><span class="WHIT">
<span class='line'>1675</span> </span><span class="WHIT">    </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">statusOnly</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">key</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1676</span> 
<span class='line'>1677</span> </span><span class="WHIT">    </span><span class="COMM">// record in changelog</span><span class="WHIT">
<span class='line'>1678</span> </span><span class="WHIT">    </span><span class="NAME">changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.changelog</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1679</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">changelog</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Set.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1680</span> </span><span class="WHIT">    </span><span class="NAME">changelog.add</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1681</span> </span><span class="WHIT">    </span><span class="NAME">this.changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">changelog</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1682</span> 
<span class='line'>1683</span> </span><span class="WHIT">    </span><span class="COMM">// if commit records is enabled</span><span class="WHIT">
<span class='line'>1684</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'commitRecordsAutomatically'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1685</span> </span><span class="WHIT">      </span><span class="NAME">this.invokeLast</span><span class="PUNC">(</span><span class="NAME">this.commitRecords</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1686</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1687</span> 
<span class='line'>1688</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1689</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1690</span> 
<span class='line'>1691</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1692</span>     Mark a group of records as dirty.  The records will be committed to the
<span class='line'>1693</span>     server the next time you commit changes on the root store.  If you have a
<span class='line'>1694</span>     set of record ids, marking them dirty this way can be faster than
<span class='line'>1695</span>     retrieving each record and destroying it individually.
<span class='line'>1696</span> 
<span class='line'>1697</span>     You can pass either a single `recordType` or an array of `recordType`s. If
<span class='line'>1698</span>     you pass a single `recordType`, then the record type will be used for each
<span class='line'>1699</span>     record.  If you pass an array, then each id must have a matching record
<span class='line'>1700</span>     type in the array.
<span class='line'>1701</span> 
<span class='line'>1702</span>     You can optionally pass an array of `storeKey`s instead of the `recordType`
<span class='line'>1703</span>     and ids.  In this case the first two parameters will be ignored.  This
<span class='line'>1704</span>     is usually only used by low-level internal methods.
<span class='line'>1705</span> 
<span class='line'>1706</span>     @param {SC.Record|Array} recordTypes class or array of classes
<span class='line'>1707</span>     @param {Array} ids ids to destroy
<span class='line'>1708</span>     @param {Array} storeKeys (optional) store keys to destroy
<span class='line'>1709</span>     @returns {SC.Store} receiver
<span class='line'>1710</span>   */</span><span class="WHIT">
<span class='line'>1711</span> </span><span class="WHIT">  </span><span class="NAME">recordsDidChange</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1712</span> </span><span class="WHIT">     </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1713</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="PUNC">===</span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1714</span> </span><span class="WHIT">        </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ids.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1715</span> </span><span class="WHIT">        </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_ARRAY</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1716</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1717</span> </span><span class="WHIT">        </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1718</span> </span><span class="WHIT">          </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1719</span> </span><span class="WHIT">          </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1720</span> </span><span class="WHIT">          </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1721</span> </span><span class="WHIT">          </span><span class="NAME">this.recordDidChange</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1722</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1723</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1724</span> </span><span class="WHIT">        </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1725</span> </span><span class="WHIT">        </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1726</span> </span><span class="WHIT">          </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1727</span> </span><span class="WHIT">          </span><span class="NAME">this.recordDidChange</span><span class="PUNC">(</span><span class="NAME">undefined</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1728</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1729</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1730</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1731</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1732</span> 
<span class='line'>1733</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1734</span>     Retrieves a set of records from the server.  If the records has
<span class='line'>1735</span>     already been loaded in the store, then this method will simply return.
<span class='line'>1736</span>     Otherwise if your store has a `dataSource`, this will call the
<span class='line'>1737</span>     `dataSource` to retrieve the record.  Generally you will not need to
<span class='line'>1738</span>     call this method yourself. Instead you can just use `find()`.
<span class='line'>1739</span> 
<span class='line'>1740</span>     This will not actually create a record instance but it will initiate a
<span class='line'>1741</span>     load of the record from the server.  You can subsequently get a record
<span class='line'>1742</span>     instance itself using `materializeRecord()`.
<span class='line'>1743</span> 
<span class='line'>1744</span>     @param {SC.Record|Array} recordTypes class or array of classes
<span class='line'>1745</span>     @param {Array} ids ids to retrieve
<span class='line'>1746</span>     @param {Array} storeKeys (optional) store keys to retrieve
<span class='line'>1747</span>     @param {Boolean} isRefresh
<span class='line'>1748</span>     @param {Function|Array} callback function or array of functions
<span class='line'>1749</span>     @returns {Array} storeKeys to be retrieved
<span class='line'>1750</span>   */</span><span class="WHIT">
<span class='line'>1751</span> </span><span class="WHIT">  </span><span class="NAME">retrieveRecords</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isRefresh</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callbacks</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1752</span> 
<span class='line'>1753</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">source</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._getDataSource</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1754</span> </span><span class="WHIT">        </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_ARRAY</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1755</span> </span><span class="WHIT">        </span><span class="NAME">hasCallbackArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">callbacks</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_ARRAY</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1756</span> </span><span class="WHIT">        </span><span class="NAME">len</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">ids.length</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">storeKeys.length</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1757</span> </span><span class="WHIT">        </span><span class="NAME">ret</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1758</span> </span><span class="WHIT">        </span><span class="NAME">rev</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Store.generateStoreKey</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1759</span> </span><span class="WHIT">        </span><span class="NAME">K</span><span class="WHIT">       </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1760</span> </span><span class="WHIT">        </span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ok</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1761</span> 
<span class='line'>1762</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1763</span> 
<span class='line'>1764</span> </span><span class="WHIT">    </span><span class="COMM">// if no storeKeys were passed, map recordTypes + ids</span><span class="WHIT">
<span class='line'>1765</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1766</span> 
<span class='line'>1767</span> </span><span class="WHIT">      </span><span class="COMM">// collect store key</span><span class="WHIT">
<span class='line'>1768</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1769</span> </span><span class="WHIT">        </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1770</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1771</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1772</span> </span><span class="WHIT">        </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">ids</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1773</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1774</span> </span><span class="WHIT">      </span><span class="COMM">//collect the callback</span><span class="WHIT">
<span class='line'>1775</span> </span><span class="WHIT">      </span><span class="NAME">callback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">hasCallbackArray</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">callbacks</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">callbacks</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1776</span> 
<span class='line'>1777</span> </span><span class="WHIT">      </span><span class="COMM">// collect status and process</span><span class="WHIT">
<span class='line'>1778</span> </span><span class="WHIT">      </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1779</span> 
<span class='line'>1780</span> </span><span class="WHIT">      </span><span class="COMM">// K.EMPTY, K.ERROR, K.DESTROYED_CLEAN - initial retrieval</span><span class="WHIT">
<span class='line'>1781</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.EMPTY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.ERROR</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_CLEAN</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1782</span> </span><span class="WHIT">        </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K.BUSY_LOADING</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1783</span> </span><span class="WHIT">        </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rev</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1784</span> </span><span class="WHIT">        </span><span class="NAME">ret.push</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1785</span> </span><span class="WHIT">        </span><span class="NAME">this._setCallbackForStoreKey</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">hasCallbackArray</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1786</span> </span><span class="WHIT">      </span><span class="COMM">// otherwise, ignore record unless isRefresh is YES.</span><span class="WHIT">
<span class='line'>1787</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isRefresh</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1788</span> </span><span class="WHIT">        </span><span class="COMM">// K.READY_CLEAN, K.READY_DIRTY, ignore K.READY_NEW</span><span class="WHIT">
<span class='line'>1789</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.READY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1790</span> </span><span class="WHIT">          </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K.BUSY_REFRESH</span><span class="WHIT"> </span><span class="PUNC">|</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NUMB">0x03</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1791</span> </span><span class="WHIT">          </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rev</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1792</span> </span><span class="WHIT">          </span><span class="NAME">ret.push</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1793</span> </span><span class="WHIT">          </span><span class="NAME">this._setCallbackForStoreKey</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">hasCallbackArray</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1794</span> </span><span class="WHIT">        </span><span class="COMM">// K.BUSY_DESTROYING, K.BUSY_COMMITTING, K.BUSY_CREATING</span><span class="WHIT">
<span class='line'>1795</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.BUSY_DESTROYING</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.BUSY_CREATING</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.BUSY_COMMITTING</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1796</span> </span><span class="WHIT">          </span><span class="NAME">K.BUSY_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1797</span> 
<span class='line'>1798</span> </span><span class="WHIT">        </span><span class="COMM">// K.DESTROY_DIRTY, bad state...</span><span class="WHIT">
<span class='line'>1799</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_DIRTY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1800</span> </span><span class="WHIT">          </span><span class="NAME">K.BAD_STATE_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1801</span> 
<span class='line'>1802</span> </span><span class="WHIT">        </span><span class="COMM">// ignore K.BUSY_LOADING, K.BUSY_REFRESH_CLEAN, K.BUSY_REFRESH_DIRTY</span><span class="WHIT">
<span class='line'>1803</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1804</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1805</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1806</span> 
<span class='line'>1807</span> </span><span class="WHIT">    </span><span class="COMM">// now retrieve storeKeys from dataSource.  if there is no dataSource,</span><span class="WHIT">
<span class='line'>1808</span> </span><span class="WHIT">    </span><span class="COMM">// then act as if we couldn't retrieve.</span><span class="WHIT">
<span class='line'>1809</span> </span><span class="WHIT">    </span><span class="NAME">ok</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1810</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">source</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">ok</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">source.retrieveRecords.call</span><span class="PUNC">(</span><span class="NAME">source</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1811</span> 
<span class='line'>1812</span> </span><span class="WHIT">    </span><span class="COMM">// if the data source could not retrieve or if there is no source, then</span><span class="WHIT">
<span class='line'>1813</span> </span><span class="WHIT">    </span><span class="COMM">// simulate the data source calling dataSourceDidError on those we are</span><span class="WHIT">
<span class='line'>1814</span> </span><span class="WHIT">    </span><span class="COMM">// loading for the first time or dataSourceDidComplete on refreshes.</span><span class="WHIT">
<span class='line'>1815</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">ok</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1816</span> </span><span class="WHIT">      </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ret.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1817</span> </span><span class="WHIT">      </span><span class="NAME">rev</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Store.generateStoreKey</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1818</span> </span><span class="WHIT">      </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1819</span> </span><span class="WHIT">        </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1820</span> </span><span class="WHIT">        </span><span class="NAME">status</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1821</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.BUSY_LOADING</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1822</span> </span><span class="WHIT">          </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K.ERROR</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1823</span> </span><span class="WHIT">          </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rev</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1824</span> 
<span class='line'>1825</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.BUSY_REFRESH</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1826</span> </span><span class="WHIT">          </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K.READY</span><span class="WHIT"> </span><span class="PUNC">|</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NUMB">0x03</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1827</span> </span><span class="WHIT">          </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rev</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1828</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1829</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1830</span> </span><span class="WHIT">      </span><span class="NAME">ret.length</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// truncate to indicate that none could refresh</span><span class="WHIT">
<span class='line'>1831</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1832</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1833</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1834</span> 
<span class='line'>1835</span> </span><span class="WHIT">  </span><span class="NAME">_TMP_RETRIEVE_ARRAY</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1836</span> 
<span class='line'>1837</span> </span><span class="WHIT">  </span><span class="NAME">_callback_queue</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1838</span> 
<span class='line'>1839</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1840</span>     @private
<span class='line'>1841</span>     stores the callbacks for the storeKeys that are inflight
<span class='line'>1842</span>   **/</span><span class="WHIT">
<span class='line'>1843</span> </span><span class="WHIT">  </span><span class="NAME">_setCallbackForStoreKey</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">hasCallbackArray</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1844</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">queue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._callback_queue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1845</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">hasCallbackArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">queue</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">callback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">otherKeys</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1846</span> </span><span class="WHIT">    </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">queue</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1847</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1848</span> 
<span class='line'>1849</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1850</span>     @private
<span class='line'>1851</span>     Retrieves and calls callback for `storeKey` if exists, also handles if a single callback is
<span class='line'>1852</span>     needed for one key..
<span class='line'>1853</span>   **/</span><span class="WHIT">
<span class='line'>1854</span> </span><span class="WHIT">  </span><span class="NAME">_retrieveCallbackForStoreKey</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1855</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">queue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._callback_queue</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1856</span> </span><span class="WHIT">        </span><span class="NAME">callback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">queue</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1857</span> </span><span class="WHIT">        </span><span class="NAME">allFinished</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1858</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1859</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_FUNCTION</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1860</span> </span><span class="WHIT">        </span><span class="NAME">callback.call</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">//args?</span><span class="WHIT">
<span class='line'>1861</span> </span><span class="WHIT">        </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">queue</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">//cleanup</span><span class="WHIT">
<span class='line'>1862</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1863</span> </span><span class="WHIT">      </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_HASH</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1864</span> </span><span class="WHIT">        </span><span class="NAME">callback.completed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1865</span> </span><span class="WHIT">        </span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">callback.storeKeys</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1866</span> </span><span class="WHIT">        </span><span class="NAME">keys.forEach</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1867</span> </span><span class="WHIT">          </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">queue</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">completed</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">allFinished</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1868</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1869</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">allFinished</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1870</span> </span><span class="WHIT">          </span><span class="NAME">callback.callback.call</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// args?</span><span class="WHIT">
<span class='line'>1871</span> </span><span class="WHIT">          </span><span class="COMM">//cleanup</span><span class="WHIT">
<span class='line'>1872</span> </span><span class="WHIT">          </span><span class="NAME">keys.forEach</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1873</span> </span><span class="WHIT">            </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">queue</span><span class="PUNC">[</span><span class="NAME">key</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1874</span> </span><span class="WHIT">          </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1875</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1876</span> 
<span class='line'>1877</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1878</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1879</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1880</span> 
<span class='line'>1881</span> </span><span class="WHIT">  </span><span class="COMM">/*
<span class='line'>1882</span>     @private
<span class='line'>1883</span> 
<span class='line'>1884</span>   */</span><span class="WHIT">
<span class='line'>1885</span> </span><span class="WHIT">  </span><span class="NAME">_cancelCallback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1886</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">queue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._callback_queue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1887</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">queue</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1888</span> </span><span class="WHIT">      </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">queue</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1889</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1890</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1891</span> 
<span class='line'>1892</span> 
<span class='line'>1893</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1894</span>     Retrieves a record from the server.  If the record has already been loaded
<span class='line'>1895</span>     in the store, then this method will simply return.  Otherwise if your
<span class='line'>1896</span>     store has a `dataSource`, this will call the `dataSource` to retrieve the
<span class='line'>1897</span>     record.  Generally you will not need to call this method yourself.
<span class='line'>1898</span>     Instead you can just use `find()`.
<span class='line'>1899</span> 
<span class='line'>1900</span>     This will not actually create a record instance but it will initiate a
<span class='line'>1901</span>     load of the record from the server.  You can subsequently get a record
<span class='line'>1902</span>     instance itself using `materializeRecord()`.
<span class='line'>1903</span> 
<span class='line'>1904</span>     @param {SC.Record} recordType class
<span class='line'>1905</span>     @param {String} id id to retrieve
<span class='line'>1906</span>     @param {Number} storeKey (optional) store key
<span class='line'>1907</span>     @param {Boolean} isRefresh
<span class='line'>1908</span>     @param {Function} callback (optional)
<span class='line'>1909</span>     @returns {Number} storeKey that was retrieved
<span class='line'>1910</span>   */</span><span class="WHIT">
<span class='line'>1911</span> </span><span class="WHIT">  </span><span class="NAME">retrieveRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isRefresh</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1912</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">array</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._TMP_RETRIEVE_ARRAY</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1913</span> </span><span class="WHIT">        </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1914</span> 
<span class='line'>1915</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1916</span> </span><span class="WHIT">      </span><span class="NAME">array</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1917</span> </span><span class="WHIT">      </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">array</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1918</span> </span><span class="WHIT">      </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1919</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1920</span> </span><span class="WHIT">      </span><span class="NAME">array</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1921</span> </span><span class="WHIT">      </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">array</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1922</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1923</span> 
<span class='line'>1924</span> </span><span class="WHIT">    </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.retrieveRecords</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isRefresh</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1925</span> </span><span class="WHIT">    </span><span class="NAME">array.length</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1926</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1927</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1928</span> 
<span class='line'>1929</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1930</span>     Refreshes a record from the server.  If the record has already been loaded
<span class='line'>1931</span>     in the store, then this method will request a refresh from the
<span class='line'>1932</span>     `dataSource`. Otherwise it will attempt to retrieve the record.
<span class='line'>1933</span> 
<span class='line'>1934</span>     @param {SC.Record} recordType the expected record type
<span class='line'>1935</span>     @param {String} id to id of the record to load
<span class='line'>1936</span>     @param {Number} storeKey (optional) optional store key
<span class='line'>1937</span>     @param {Function} callback (optional) when refresh completes
<span class='line'>1938</span>     @returns {Boolean} YES if the retrieval was a success.
<span class='line'>1939</span>   */</span><span class="WHIT">
<span class='line'>1940</span> </span><span class="WHIT">  </span><span class="NAME">refreshRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1941</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">!</span><span class="NAME">this.retrieveRecord</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1942</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1943</span> 
<span class='line'>1944</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1945</span>     Refreshes a set of records from the server.  If the records has already been loaded
<span class='line'>1946</span>     in the store, then this method will request a refresh from the
<span class='line'>1947</span>     `dataSource`. Otherwise it will attempt to retrieve them.
<span class='line'>1948</span> 
<span class='line'>1949</span>     @param {SC.Record|Array} recordTypes class or array of classes
<span class='line'>1950</span>     @param {Array} ids ids to destroy
<span class='line'>1951</span>     @param {Array} storeKeys (optional) store keys to destroy
<span class='line'>1952</span>     @param {Function} callback (optional) when refresh completes
<span class='line'>1953</span>     @returns {Boolean} YES if the retrieval was a success.
<span class='line'>1954</span>   */</span><span class="WHIT">
<span class='line'>1955</span> </span><span class="WHIT">  </span><span class="NAME">refreshRecords</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1956</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.retrieveRecords</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1957</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">ret.length</span><span class="PUNC">></span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1958</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1959</span> 
<span class='line'>1960</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>1961</span>     Commits the passed store keys or ids. If no `storeKey`s are given,
<span class='line'>1962</span>     it will commit any records in the changelog.
<span class='line'>1963</span> 
<span class='line'>1964</span>     Based on the current state of the record, this will ask the data
<span class='line'>1965</span>     source to perform the appropriate actions
<span class='line'>1966</span>     on the store keys.
<span class='line'>1967</span> 
<span class='line'>1968</span>     @param {Array} recordTypes the expected record types (SC.Record)
<span class='line'>1969</span>     @param {Array} ids to commit
<span class='line'>1970</span>     @param {SC.Set} storeKeys to commit
<span class='line'>1971</span>     @param {Hash} params optional additional parameters to pass along to the
<span class='line'>1972</span>       data source
<span class='line'>1973</span>     @param {Function|Array} callback function or array of callbacks
<span class='line'>1974</span> 
<span class='line'>1975</span>     @returns {Boolean} if the action was succesful.
<span class='line'>1976</span>   */</span><span class="WHIT">
<span class='line'>1977</span> </span><span class="WHIT">  </span><span class="NAME">commitRecords</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">params</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callbacks</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1978</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">source</span><span class="WHIT">    </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._getDataSource</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1979</span> </span><span class="WHIT">        </span><span class="NAME">isArray</span><span class="WHIT">   </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_ARRAY</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1980</span> </span><span class="WHIT">        </span><span class="NAME">hasCallbackArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">callbacks</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_ARRAY</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1981</span> </span><span class="WHIT">        </span><span class="NAME">retCreate</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">retUpdate</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">retDestroy</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1982</span> </span><span class="WHIT">        </span><span class="NAME">rev</span><span class="WHIT">       </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Store.generateStoreKey</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1983</span> </span><span class="WHIT">        </span><span class="NAME">K</span><span class="WHIT">         </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1984</span> </span><span class="WHIT">        </span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1985</span> 
<span class='line'>1986</span> </span><span class="WHIT">    </span><span class="COMM">// If no params are passed, look up storeKeys in the changelog property.</span><span class="WHIT">
<span class='line'>1987</span> </span><span class="WHIT">    </span><span class="COMM">// Remove any committed records from changelog property.</span><span class="WHIT">
<span class='line'>1988</span> 
<span class='line'>1989</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">recordTypes</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">ids</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1990</span> </span><span class="WHIT">      </span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.changelog</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1991</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1992</span> 
<span class='line'>1993</span> </span><span class="WHIT">    </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">storeKeys.get</span><span class="PUNC">(</span><span class="STRN">'length'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ids</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">ids.get</span><span class="PUNC">(</span><span class="STRN">'length'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1994</span> 
<span class='line'>1995</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1996</span> 
<span class='line'>1997</span> </span><span class="WHIT">      </span><span class="COMM">// collect store key</span><span class="WHIT">
<span class='line'>1998</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1999</span> </span><span class="WHIT">        </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2000</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2001</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2002</span> </span><span class="WHIT">        </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2003</span> </span><span class="WHIT">        </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">ids</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2004</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2005</span> 
<span class='line'>2006</span> </span><span class="WHIT">      </span><span class="COMM">//collect the callback</span><span class="WHIT">
<span class='line'>2007</span> </span><span class="WHIT">      </span><span class="NAME">callback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">hasCallbackArray</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">callbacks</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">callbacks</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2008</span> 
<span class='line'>2009</span> </span><span class="WHIT">      </span><span class="COMM">// collect status and process</span><span class="WHIT">
<span class='line'>2010</span> </span><span class="WHIT">      </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2011</span> 
<span class='line'>2012</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.ERROR</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2013</span> </span><span class="WHIT">        </span><span class="NAME">K.NOT_FOUND_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2014</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2015</span> </span><span class="WHIT">      </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2016</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.READY_NEW</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2017</span> </span><span class="WHIT">          </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K.BUSY_CREATING</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2018</span> </span><span class="WHIT">          </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rev</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2019</span> </span><span class="WHIT">          </span><span class="NAME">retCreate.push</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2020</span> </span><span class="WHIT">          </span><span class="NAME">this._setCallbackForStoreKey</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">hasCallbackArray</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2021</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.READY_DIRTY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2022</span> </span><span class="WHIT">          </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K.BUSY_COMMITTING</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2023</span> </span><span class="WHIT">          </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rev</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2024</span> </span><span class="WHIT">          </span><span class="NAME">retUpdate.push</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2025</span> </span><span class="WHIT">          </span><span class="NAME">this._setCallbackForStoreKey</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">hasCallbackArray</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2026</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_DIRTY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2027</span> </span><span class="WHIT">          </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K.BUSY_DESTROYING</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2028</span> </span><span class="WHIT">          </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rev</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2029</span> </span><span class="WHIT">          </span><span class="NAME">retDestroy.push</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2030</span> </span><span class="WHIT">          </span><span class="NAME">this._setCallbackForStoreKey</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">hasCallbackArray</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2031</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_CLEAN</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2032</span> </span><span class="WHIT">          </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rev</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2033</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2034</span> </span><span class="WHIT">        </span><span class="COMM">// ignore K.EMPTY, K.READY_CLEAN, K.BUSY_LOADING, K.BUSY_CREATING, K.BUSY_COMMITTING,</span><span class="WHIT">
<span class='line'>2035</span> </span><span class="WHIT">        </span><span class="COMM">// K.BUSY_REFRESH_CLEAN, K_BUSY_REFRESH_DIRTY, KBUSY_DESTROYING</span><span class="WHIT">
<span class='line'>2036</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2037</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2038</span> 
<span class='line'>2039</span> </span><span class="WHIT">    </span><span class="COMM">// now commit storeKeys to dataSource</span><span class="WHIT">
<span class='line'>2040</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">source</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">len</span><span class="PUNC">></span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">params</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2041</span> </span><span class="WHIT">      </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">source.commitRecords.call</span><span class="PUNC">(</span><span class="NAME">source</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">retCreate</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">retUpdate</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">retDestroy</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">params</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2042</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2043</span> 
<span class='line'>2044</span> </span><span class="WHIT">    </span><span class="COMM">//remove all committed changes from changelog</span><span class="WHIT">
<span class='line'>2045</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">recordTypes</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">ids</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2046</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">this.changelog</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2047</span> </span><span class="WHIT">        </span><span class="NAME">this.changelog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2048</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2049</span> </span><span class="WHIT">      </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2050</span> </span><span class="WHIT">        </span><span class="NAME">this.changelog.removeEach</span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2051</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2052</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2053</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2054</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2055</span> 
<span class='line'>2056</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2057</span>     Commits the passed store key or id.  Based on the current state of the
<span class='line'>2058</span>     record, this will ask the data source to perform the appropriate action
<span class='line'>2059</span>     on the store key.
<span class='line'>2060</span> 
<span class='line'>2061</span>     You have to pass either the id or the storeKey otherwise it will return
<span class='line'>2062</span>     NO.
<span class='line'>2063</span> 
<span class='line'>2064</span>     @param {SC.Record} recordType the expected record type
<span class='line'>2065</span>     @param {String} id the id of the record to commit
<span class='line'>2066</span>     @param {Number} storeKey the storeKey of the record to commit
<span class='line'>2067</span>     @param {Hash} params optional additional params that will passed down
<span class='line'>2068</span>       to the data source
<span class='line'>2069</span>     @param {Function|Array} callback function or array of functions
<span class='line'>2070</span>     @returns {Boolean} if the action was successful.
<span class='line'>2071</span>   */</span><span class="WHIT">
<span class='line'>2072</span> </span><span class="WHIT">  </span><span class="NAME">commitRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">params</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2073</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">array</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._TMP_RETRIEVE_ARRAY</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2074</span> </span><span class="WHIT">        </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2075</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2076</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2077</span> </span><span class="WHIT">      </span><span class="NAME">array</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2078</span> </span><span class="WHIT">      </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">array</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2079</span> </span><span class="WHIT">      </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2080</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2081</span> </span><span class="WHIT">      </span><span class="NAME">array</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2082</span> </span><span class="WHIT">      </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">array</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2083</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2084</span> 
<span class='line'>2085</span> </span><span class="WHIT">    </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.commitRecords</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">params</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2086</span> </span><span class="WHIT">    </span><span class="NAME">array.length</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2087</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2088</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2089</span> 
<span class='line'>2090</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2091</span>     Cancels an inflight request for the passed records.  Depending on the
<span class='line'>2092</span>     server implementation, this could cancel an entire request, causing
<span class='line'>2093</span>     other records to also transition their current state.
<span class='line'>2094</span> 
<span class='line'>2095</span>     @param {SC.Record|Array} recordTypes class or array of classes
<span class='line'>2096</span>     @param {Array} ids ids to destroy
<span class='line'>2097</span>     @param {Array} storeKeys (optional) store keys to destroy
<span class='line'>2098</span>     @returns {SC.Store} the store.
<span class='line'>2099</span>   */</span><span class="WHIT">
<span class='line'>2100</span> </span><span class="WHIT">  </span><span class="NAME">cancelRecords</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2101</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">source</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._getDataSource</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2102</span> </span><span class="WHIT">        </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_ARRAY</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2103</span> </span><span class="WHIT">        </span><span class="NAME">K</span><span class="WHIT">       </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2104</span> </span><span class="WHIT">        </span><span class="NAME">ret</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2105</span> </span><span class="WHIT">        </span><span class="NAME">status</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2106</span> 
<span class='line'>2107</span> </span><span class="WHIT">    </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">ids.length</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">storeKeys.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2108</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2109</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2110</span> </span><span class="WHIT">      </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2111</span> 
<span class='line'>2112</span> </span><span class="WHIT">      </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2113</span> 
<span class='line'>2114</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="PUNC">===</span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2115</span> </span><span class="WHIT">        </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2116</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2117</span> </span><span class="WHIT">        </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2118</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2119</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2120</span> </span><span class="WHIT">        </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2121</span> 
<span class='line'>2122</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.EMPTY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.ERROR</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2123</span> </span><span class="WHIT">          </span><span class="NAME">K.NOT_FOUND_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2124</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2125</span> </span><span class="WHIT">        </span><span class="NAME">ret.push</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2126</span> </span><span class="WHIT">        </span><span class="NAME">this._cancelCallback</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2127</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2128</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2129</span> 
<span class='line'>2130</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">source</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">source.cancel.call</span><span class="PUNC">(</span><span class="NAME">source</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2131</span> 
<span class='line'>2132</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2133</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2134</span> 
<span class='line'>2135</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2136</span>     Cancels an inflight request for the passed record.  Depending on the
<span class='line'>2137</span>     server implementation, this could cancel an entire request, causing
<span class='line'>2138</span>     other records to also transition their current state.
<span class='line'>2139</span> 
<span class='line'>2140</span>     @param {SC.Record|Array} recordTypes class or array of classes
<span class='line'>2141</span>     @param {Array} ids ids to destroy
<span class='line'>2142</span>     @param {Array} storeKeys (optional) store keys to destroy
<span class='line'>2143</span>     @returns {SC.Store} the store.
<span class='line'>2144</span>   */</span><span class="WHIT">
<span class='line'>2145</span> </span><span class="WHIT">  </span><span class="NAME">cancelRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2146</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">array</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._TMP_RETRIEVE_ARRAY</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2147</span> </span><span class="WHIT">        </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2148</span> 
<span class='line'>2149</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2150</span> </span><span class="WHIT">      </span><span class="NAME">array</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2151</span> </span><span class="WHIT">      </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">array</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2152</span> </span><span class="WHIT">      </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2153</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2154</span> </span><span class="WHIT">      </span><span class="NAME">array</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2155</span> </span><span class="WHIT">      </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">array</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2156</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2157</span> 
<span class='line'>2158</span> </span><span class="WHIT">    </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.cancelRecords</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2159</span> </span><span class="WHIT">    </span><span class="NAME">array.length</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2160</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2161</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2162</span> 
<span class='line'>2163</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2164</span>     Convenience method can be called by the store or other parts of your
<span class='line'>2165</span>     application to load a record into the store.  This method will take a
<span class='line'>2166</span>     recordType and a data hashes and either add or update the
<span class='line'>2167</span>     record in the store.
<span class='line'>2168</span> 
<span class='line'>2169</span>     The loaded records will be in an `SC.Record.READY_CLEAN` state, indicating
<span class='line'>2170</span>     they were loaded from the data source and do not need to be committed
<span class='line'>2171</span>     back before changing.
<span class='line'>2172</span> 
<span class='line'>2173</span>     This method will check the state of the storeKey and call either
<span class='line'>2174</span>     `pushRetrieve()` or `dataSourceDidComplete()`.  The standard state constraints
<span class='line'>2175</span>     for these methods apply here.
<span class='line'>2176</span> 
<span class='line'>2177</span>     The return value will be the `storeKey` used for the push.  This is often
<span class='line'>2178</span>     convenient to pass into `loadQuery()`, if you are fetching a remote query.
<span class='line'>2179</span> 
<span class='line'>2180</span>     If you are upgrading from a pre SproutCore 1.0 application, this method
<span class='line'>2181</span>     is the closest to the old `updateRecord()`.
<span class='line'>2182</span> 
<span class='line'>2183</span>     @param {SC.Record} recordType the record type
<span class='line'>2184</span>     @param {Array} dataHash to update
<span class='line'>2185</span>     @param {Array} id optional.  if not passed lookup on the hash
<span class='line'>2186</span>     @returns {String} store keys assigned to these id
<span class='line'>2187</span>   */</span><span class="WHIT">
<span class='line'>2188</span> </span><span class="WHIT">  </span><span class="NAME">loadRecord</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2189</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">K</span><span class="WHIT">       </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2190</span> </span><span class="WHIT">        </span><span class="NAME">ret</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">primaryKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2191</span> 
<span class='line'>2192</span> </span><span class="WHIT">    </span><span class="COMM">// save lookup info</span><span class="WHIT">
<span class='line'>2193</span> </span><span class="WHIT">    </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2194</span> </span><span class="WHIT">    </span><span class="NAME">primaryKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.prototype.primaryKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2195</span> 
<span class='line'>2196</span> 
<span class='line'>2197</span> </span><span class="WHIT">    </span><span class="COMM">// push each record</span><span class="WHIT">
<span class='line'>2198</span> </span><span class="WHIT">    </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">[</span><span class="NAME">primaryKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2199</span> </span><span class="WHIT">    </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// needed to cache</span><span class="WHIT">
<span class='line'>2200</span> 
<span class='line'>2201</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.BUSY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2202</span> </span><span class="WHIT">      </span><span class="NAME">this.dataSourceDidComplete</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2203</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">this.pushRetrieve</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2204</span> 
<span class='line'>2205</span> </span><span class="WHIT">    </span><span class="COMM">// return storeKey</span><span class="WHIT">
<span class='line'>2206</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2207</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2208</span> 
<span class='line'>2209</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2210</span>     Convenience method can be called by the store or other parts of your
<span class='line'>2211</span>     application to load records into the store.  This method will take a
<span class='line'>2212</span>     recordType and an array of data hashes and either add or update the
<span class='line'>2213</span>     record in the store.
<span class='line'>2214</span> 
<span class='line'>2215</span>     The loaded records will be in an `SC.Record.READY_CLEAN` state, indicating
<span class='line'>2216</span>     they were loaded from the data source and do not need to be committed
<span class='line'>2217</span>     back before changing.
<span class='line'>2218</span> 
<span class='line'>2219</span>     This method will check the state of each storeKey and call either
<span class='line'>2220</span>     `pushRetrieve()` or `dataSourceDidComplete()`.  The standard state
<span class='line'>2221</span>     constraints for these methods apply here.
<span class='line'>2222</span> 
<span class='line'>2223</span>     The return value will be the storeKeys used for each push.  This is often
<span class='line'>2224</span>     convenient to pass into `loadQuery()`, if you are fetching a remote query.
<span class='line'>2225</span> 
<span class='line'>2226</span>     If you are upgrading from a pre SproutCore 1.0 application, this method
<span class='line'>2227</span>     is the closest to the old `updateRecords()`.
<span class='line'>2228</span> 
<span class='line'>2229</span>     @param {SC.Record} recordTypes the record type or array of record types
<span class='line'>2230</span>     @param {Array} dataHashes array of data hashes to update
<span class='line'>2231</span>     @param {Array} [ids] array of ids.  if not passed lookup on hashes
<span class='line'>2232</span>     @returns {Array} store keys assigned to these ids
<span class='line'>2233</span>   */</span><span class="WHIT">
<span class='line'>2234</span> </span><span class="WHIT">  </span><span class="COMM">// TODO: No reason for first argument to be an array. The developer can just call loadRecords multiple times with different record type each time. Would save us the need to check if recordTypes is an Array or not.</span><span class="WHIT">
<span class='line'>2235</span> </span><span class="WHIT">  </span><span class="NAME">loadRecords</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHashes</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ids</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2236</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">isArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.typeOf</span><span class="PUNC">(</span><span class="NAME">recordTypes</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.T_ARRAY</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2237</span> </span><span class="WHIT">        </span><span class="NAME">len</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dataHashes.get</span><span class="PUNC">(</span><span class="STRN">'length'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2238</span> </span><span class="WHIT">        </span><span class="NAME">ret</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2239</span> </span><span class="WHIT">        </span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2240</span> </span><span class="WHIT">        </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">primaryKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2241</span> 
<span class='line'>2242</span> </span><span class="WHIT">    </span><span class="COMM">// save lookup info</span><span class="WHIT">
<span class='line'>2243</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2244</span> </span><span class="WHIT">      </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2245</span> </span><span class="WHIT">      </span><span class="NAME">primaryKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.prototype.primaryKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2246</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2247</span> 
<span class='line'>2248</span> </span><span class="WHIT">    </span><span class="COMM">// push each record</span><span class="WHIT">
<span class='line'>2249</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">idx</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2250</span> </span><span class="WHIT">      </span><span class="NAME">dataHash</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dataHashes.objectAt</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2251</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2252</span> </span><span class="WHIT">        </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordTypes.objectAt</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2253</span> </span><span class="WHIT">        </span><span class="NAME">primaryKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.prototype.primaryKey</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2254</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2255</span> 
<span class='line'>2256</span> </span><span class="WHIT">      </span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ids</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">ids.objectAt</span><span class="PUNC">(</span><span class="NAME">idx</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">[</span><span class="NAME">primaryKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2257</span> 
<span class='line'>2258</span> </span><span class="WHIT">      </span><span class="NAME">ret</span><span class="PUNC">[</span><span class="NAME">idx</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.loadRecord</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2259</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2260</span> 
<span class='line'>2261</span> </span><span class="WHIT">    </span><span class="COMM">// return storeKeys</span><span class="WHIT">
<span class='line'>2262</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2263</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2264</span> 
<span class='line'>2265</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2266</span>     Returns the `SC.Error` object associated with a specific record.
<span class='line'>2267</span> 
<span class='line'>2268</span>     @param {Number} storeKey The store key of the record.
<span class='line'>2269</span> 
<span class='line'>2270</span>     @returns {SC.Error} SC.Error or undefined if no error associated with the record.
<span class='line'>2271</span>   */</span><span class="WHIT">
<span class='line'>2272</span> </span><span class="WHIT">  </span><span class="NAME">readError</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2273</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">errors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.recordErrors</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2274</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">errors</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">errors</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2275</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2276</span> 
<span class='line'>2277</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2278</span>     Returns the `SC.Error` object associated with a specific query.
<span class='line'>2279</span> 
<span class='line'>2280</span>     @param {SC.Query} query The SC.Query with which the error is associated.
<span class='line'>2281</span> 
<span class='line'>2282</span>     @returns {SC.Error} SC.Error or undefined if no error associated with the query.
<span class='line'>2283</span>   */</span><span class="WHIT">
<span class='line'>2284</span> </span><span class="WHIT">  </span><span class="NAME">readQueryError</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2285</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">errors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.queryErrors</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2286</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">errors</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">errors</span><span class="PUNC">[</span><span class="NAME">SC.guidFor</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2287</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2288</span> 
<span class='line'>2289</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>2290</span> </span><span class="WHIT">  </span><span class="COMM">// DATA SOURCE CALLBACKS</span><span class="WHIT">
<span class='line'>2291</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>2292</span> </span><span class="WHIT">  </span><span class="COMM">// Mathods called by the data source on the store</span><span class="WHIT">
<span class='line'>2293</span> 
<span class='line'>2294</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2295</span>     Called by a `dataSource` when it cancels an inflight operation on a
<span class='line'>2296</span>     record.  This will transition the record back to it non-inflight state.
<span class='line'>2297</span> 
<span class='line'>2298</span>     @param {Number} storeKey record store key to cancel
<span class='line'>2299</span>     @returns {SC.Store} receiver
<span class='line'>2300</span>   */</span><span class="WHIT">
<span class='line'>2301</span> </span><span class="WHIT">  </span><span class="NAME">dataSourceDidCancel</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2302</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2303</span> </span><span class="WHIT">        </span><span class="NAME">K</span><span class="WHIT">      </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2304</span> 
<span class='line'>2305</span> </span><span class="WHIT">    </span><span class="COMM">// EMPTY, ERROR, READY_CLEAN, READY_NEW, READY_DIRTY, DESTROYED_CLEAN,</span><span class="WHIT">
<span class='line'>2306</span> </span><span class="WHIT">    </span><span class="COMM">// DESTROYED_DIRTY</span><span class="WHIT">
<span class='line'>2307</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.BUSY</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2308</span> </span><span class="WHIT">      </span><span class="NAME">K.BAD_STATE_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// should never be called in this state</span><span class="WHIT">
<span class='line'>2309</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2310</span> 
<span class='line'>2311</span> </span><span class="WHIT">    </span><span class="COMM">// otherwise, determine proper state transition</span><span class="WHIT">
<span class='line'>2312</span> </span><span class="WHIT">    </span><span class="KEYW">switch</span><span class="PUNC">(</span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2313</span> </span><span class="WHIT">      </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="NAME">K.BUSY_LOADING</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>2314</span> </span><span class="WHIT">        </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.EMPTY</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2315</span> </span><span class="WHIT">        </span><span class="KEYW">break</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2316</span> 
<span class='line'>2317</span> </span><span class="WHIT">      </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="NAME">K.BUSY_CREATING</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>2318</span> </span><span class="WHIT">        </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.READY_NEW</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2319</span> </span><span class="WHIT">        </span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2320</span> 
<span class='line'>2321</span> </span><span class="WHIT">      </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="NAME">K.BUSY_COMMITTING</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>2322</span> </span><span class="WHIT">        </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.READY_DIRTY</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2323</span> </span><span class="WHIT">        </span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2324</span> 
<span class='line'>2325</span> </span><span class="WHIT">      </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="NAME">K.BUSY_REFRESH_CLEAN</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>2326</span> </span><span class="WHIT">        </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.READY_CLEAN</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2327</span> </span><span class="WHIT">        </span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2328</span> 
<span class='line'>2329</span> </span><span class="WHIT">      </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="NAME">K.BUSY_REFRESH_DIRTY</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>2330</span> </span><span class="WHIT">        </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.READY_DIRTY</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2331</span> </span><span class="WHIT">        </span><span class="KEYW">break</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2332</span> 
<span class='line'>2333</span> </span><span class="WHIT">      </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="NAME">K.BUSY_DESTROYING</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>2334</span> </span><span class="WHIT">        </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_DIRTY</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2335</span> </span><span class="WHIT">        </span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2336</span> 
<span class='line'>2337</span> </span><span class="WHIT">      </span><span class="KEYW">default</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>2338</span> </span><span class="WHIT">        </span><span class="NAME">K.BAD_STATE_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2339</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2340</span> </span><span class="WHIT">    </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2341</span> </span><span class="WHIT">    </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2342</span> </span><span class="WHIT">    </span><span class="NAME">this._cancelCallback</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2343</span> 
<span class='line'>2344</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2345</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2346</span> 
<span class='line'>2347</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2348</span>     Called by a data source when it creates or commits a record.  Passing an
<span class='line'>2349</span>     optional id will remap the `storeKey` to the new record id.  This is
<span class='line'>2350</span>     required when you commit a record that does not have an id yet.
<span class='line'>2351</span> 
<span class='line'>2352</span>     @param {Number} storeKey record store key to change to READY_CLEAN state
<span class='line'>2353</span>     @param {Hash} dataHash optional data hash to replace current hash
<span class='line'>2354</span>     @param {Object} newId optional new id to replace the old one
<span class='line'>2355</span>     @returns {SC.Store} receiver
<span class='line'>2356</span>   */</span><span class="WHIT">
<span class='line'>2357</span> </span><span class="WHIT">  </span><span class="NAME">dataSourceDidComplete</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newId</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2358</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">statusOnly</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2359</span> 
<span class='line'>2360</span> </span><span class="WHIT">    </span><span class="COMM">// EMPTY, ERROR, READY_CLEAN, READY_NEW, READY_DIRTY, DESTROYED_CLEAN,</span><span class="WHIT">
<span class='line'>2361</span> </span><span class="WHIT">    </span><span class="COMM">// DESTROYED_DIRTY</span><span class="WHIT">
<span class='line'>2362</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.BUSY</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2363</span> </span><span class="WHIT">      </span><span class="NAME">K.BAD_STATE_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// should never be called in this state</span><span class="WHIT">
<span class='line'>2364</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2365</span> 
<span class='line'>2366</span> </span><span class="WHIT">    </span><span class="COMM">// otherwise, determine proper state transition</span><span class="WHIT">
<span class='line'>2367</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.BUSY_DESTROYING</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2368</span> </span><span class="WHIT">      </span><span class="NAME">K.BAD_STATE_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2369</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.READY_CLEAN</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2370</span> 
<span class='line'>2371</span> </span><span class="WHIT">    </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2372</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">dataHash</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">this.writeDataHash</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2373</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">newId</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">SC.Store.replaceIdFor</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newId</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2374</span> 
<span class='line'>2375</span> </span><span class="WHIT">    </span><span class="NAME">statusOnly</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">newId</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2376</span> </span><span class="WHIT">    </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">statusOnly</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2377</span> 
<span class='line'>2378</span> </span><span class="WHIT">    </span><span class="COMM">// Force record to refresh its cached properties based on store key</span><span class="WHIT">
<span class='line'>2379</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">record</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.materializeRecord</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2380</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">record</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2381</span> </span><span class="WHIT">      </span><span class="COMM">// If the record's id property has been computed, ensure that it re-computes.</span><span class="WHIT">
<span class='line'>2382</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">newId</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">record.propertyDidChange</span><span class="PUNC">(</span><span class="STRN">'id'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2383</span> </span><span class="WHIT">      </span><span class="NAME">record.notifyPropertyChange</span><span class="PUNC">(</span><span class="STRN">'status'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2384</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2385</span> </span><span class="WHIT">    </span><span class="COMM">//update callbacks</span><span class="WHIT">
<span class='line'>2386</span> </span><span class="WHIT">    </span><span class="NAME">this._retrieveCallbackForStoreKey</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2387</span> 
<span class='line'>2388</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2389</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2390</span> 
<span class='line'>2391</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2392</span>     Called by a data source when it has destroyed a record.  This will
<span class='line'>2393</span>     transition the record to the proper state.
<span class='line'>2394</span> 
<span class='line'>2395</span>     @param {Number} storeKey record store key to cancel
<span class='line'>2396</span>     @returns {SC.Store} receiver
<span class='line'>2397</span>   */</span><span class="WHIT">
<span class='line'>2398</span> </span><span class="WHIT">  </span><span class="NAME">dataSourceDidDestroy</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2399</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2400</span> 
<span class='line'>2401</span> </span><span class="WHIT">    </span><span class="COMM">// EMPTY, ERROR, READY_CLEAN, READY_NEW, READY_DIRTY, DESTROYED_CLEAN,</span><span class="WHIT">
<span class='line'>2402</span> </span><span class="WHIT">    </span><span class="COMM">// DESTROYED_DIRTY</span><span class="WHIT">
<span class='line'>2403</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.BUSY</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2404</span> </span><span class="WHIT">      </span><span class="NAME">K.BAD_STATE_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// should never be called in this state</span><span class="WHIT">
<span class='line'>2405</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2406</span> </span><span class="WHIT">    </span><span class="COMM">// otherwise, determine proper state transition</span><span class="WHIT">
<span class='line'>2407</span> </span><span class="WHIT">    </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2408</span> </span><span class="WHIT">      </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_CLEAN</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2409</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2410</span> </span><span class="WHIT">    </span><span class="NAME">this.removeDataHash</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2411</span> </span><span class="WHIT">    </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2412</span> 
<span class='line'>2413</span> </span><span class="WHIT">    </span><span class="COMM">// Force record to refresh its cached properties based on store key</span><span class="WHIT">
<span class='line'>2414</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">record</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.materializeRecord</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2415</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">record</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2416</span> </span><span class="WHIT">      </span><span class="NAME">record.notifyPropertyChange</span><span class="PUNC">(</span><span class="STRN">'status'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2417</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2418</span> 
<span class='line'>2419</span> </span><span class="WHIT">    </span><span class="NAME">this._retrieveCallbackForStoreKey</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2420</span> 
<span class='line'>2421</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2422</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2423</span> 
<span class='line'>2424</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2425</span>     Converts the passed record into an error object.
<span class='line'>2426</span> 
<span class='line'>2427</span>     @param {Number} storeKey record store key to error
<span class='line'>2428</span>     @param {SC.Error} error [optional] an SC.Error instance to associate with storeKey
<span class='line'>2429</span>     @returns {SC.Store} receiver
<span class='line'>2430</span>   */</span><span class="WHIT">
<span class='line'>2431</span> </span><span class="WHIT">  </span><span class="NAME">dataSourceDidError</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2432</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.recordErrors</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">K</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2433</span> 
<span class='line'>2434</span> </span><span class="WHIT">    </span><span class="COMM">// EMPTY, ERROR, READY_CLEAN, READY_NEW, READY_DIRTY, DESTROYED_CLEAN,</span><span class="WHIT">
<span class='line'>2435</span> </span><span class="WHIT">    </span><span class="COMM">// DESTROYED_DIRTY</span><span class="WHIT">
<span class='line'>2436</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">&</span><span class="WHIT"> </span><span class="NAME">K.BUSY</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="NAME">K.BAD_STATE_ERROR.throw</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2437</span> 
<span class='line'>2438</span> </span><span class="WHIT">    </span><span class="COMM">// otherwise, determine proper state transition</span><span class="WHIT">
<span class='line'>2439</span> </span><span class="WHIT">    </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.ERROR</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2440</span> 
<span class='line'>2441</span> </span><span class="WHIT">    </span><span class="COMM">// Add the error to the array of record errors (for lookup later on if necessary).</span><span class="WHIT">
<span class='line'>2442</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">error</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">error.isError</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2443</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">errors</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">errors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.recordErrors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2444</span> </span><span class="WHIT">      </span><span class="NAME">errors</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">error</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2445</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2446</span> 
<span class='line'>2447</span> </span><span class="WHIT">    </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2448</span> </span><span class="WHIT">    </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2449</span> 
<span class='line'>2450</span> </span><span class="WHIT">    </span><span class="COMM">// Force record to refresh its cached properties based on store key</span><span class="WHIT">
<span class='line'>2451</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">record</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.materializeRecord</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2452</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">record</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2453</span> </span><span class="WHIT">      </span><span class="NAME">record.notifyPropertyChange</span><span class="PUNC">(</span><span class="STRN">'status'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2454</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2455</span> 
<span class='line'>2456</span> </span><span class="WHIT">    </span><span class="NAME">this._retrieveCallbackForStoreKey</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2457</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2458</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2459</span> 
<span class='line'>2460</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>2461</span> </span><span class="WHIT">  </span><span class="COMM">// PUSH CHANGES FROM DATA SOURCE</span><span class="WHIT">
<span class='line'>2462</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>2463</span> 
<span class='line'>2464</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2465</span>     Call by the data source whenever you want to push new data out of band
<span class='line'>2466</span>     into the store.
<span class='line'>2467</span> 
<span class='line'>2468</span>     @param {Class} recordType the SC.Record subclass
<span class='line'>2469</span>     @param {Object} id the record id or null
<span class='line'>2470</span>     @param {Hash} dataHash data hash to load
<span class='line'>2471</span>     @param {Number} storeKey optional store key.
<span class='line'>2472</span>     @returns {Number|Boolean} storeKey if push was allowed, NO if not
<span class='line'>2473</span>   */</span><span class="WHIT">
<span class='line'>2474</span> </span><span class="WHIT">  </span><span class="NAME">pushRetrieve</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2475</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">K</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2476</span> 
<span class='line'>2477</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">===</span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2478</span> </span><span class="WHIT">    </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2479</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.EMPTY</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.ERROR</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.READY_CLEAN</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_CLEAN</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2480</span> 
<span class='line'>2481</span> </span><span class="WHIT">      </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.READY_CLEAN</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2482</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">dataHash</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2483</span> </span><span class="WHIT">      </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">this.writeDataHash</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">dataHash</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2484</span> 
<span class='line'>2485</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.idFor</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2486</span> </span><span class="WHIT">        </span><span class="NAME">SC.Store.replaceIdFor</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2487</span> 
<span class='line'>2488</span> </span><span class="WHIT">        </span><span class="COMM">// If the record's id property has been computed, ensure that it re-computes.</span><span class="WHIT">
<span class='line'>2489</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">record</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.materializeRecord</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2490</span> </span><span class="WHIT">        </span><span class="NAME">record.propertyDidChange</span><span class="PUNC">(</span><span class="STRN">'id'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2491</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2492</span> </span><span class="WHIT">      </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2493</span> 
<span class='line'>2494</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2495</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2496</span> </span><span class="WHIT">    </span><span class="COMM">//conflicted (ready)</span><span class="WHIT">
<span class='line'>2497</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2498</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2499</span> 
<span class='line'>2500</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2501</span>     Call by the data source whenever you want to push a deletion into the
<span class='line'>2502</span>     store.
<span class='line'>2503</span> 
<span class='line'>2504</span>     @param {Class} recordType the SC.Record subclass
<span class='line'>2505</span>     @param {Object} id the record id or null
<span class='line'>2506</span>     @param {Number} storeKey optional store key.
<span class='line'>2507</span>     @returns {Number|Boolean} storeKey if push was allowed, NO if not
<span class='line'>2508</span>   */</span><span class="WHIT">
<span class='line'>2509</span> </span><span class="WHIT">  </span><span class="NAME">pushDestroy</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2510</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">K</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2511</span> 
<span class='line'>2512</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">===</span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2513</span> </span><span class="WHIT">      </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2514</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2515</span> </span><span class="WHIT">    </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2516</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.EMPTY</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.ERROR</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.READY_CLEAN</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_CLEAN</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2517</span> </span><span class="WHIT">      </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_CLEAN</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2518</span> </span><span class="WHIT">      </span><span class="NAME">this.removeDataHash</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2519</span> </span><span class="WHIT">      </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2520</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2521</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2522</span> </span><span class="WHIT">    </span><span class="COMM">//conflicted (destroy)</span><span class="WHIT">
<span class='line'>2523</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2524</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2525</span> 
<span class='line'>2526</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2527</span>     Call by the data source whenever you want to push an error into the
<span class='line'>2528</span>     store.
<span class='line'>2529</span> 
<span class='line'>2530</span>     @param {Class} recordType the SC.Record subclass
<span class='line'>2531</span>     @param {Object} id the record id or null
<span class='line'>2532</span>     @param {SC.Error} error [optional] an SC.Error instance to associate with id or storeKey
<span class='line'>2533</span>     @param {Number} storeKey optional store key.
<span class='line'>2534</span>     @returns {Number|Boolean} storeKey if push was allowed, NO if not
<span class='line'>2535</span>   */</span><span class="WHIT">
<span class='line'>2536</span> </span><span class="WHIT">  </span><span class="NAME">pushError</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">error</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2537</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">K</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Record</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.recordErrors</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2538</span> 
<span class='line'>2539</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">===</span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">id</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2540</span> </span><span class="WHIT">    </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.readStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2541</span> 
<span class='line'>2542</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.EMPTY</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.ERROR</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.READY_CLEAN</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">K.DESTROYED_CLEAN</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2543</span> </span><span class="WHIT">      </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">K.ERROR</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2544</span> 
<span class='line'>2545</span> </span><span class="WHIT">      </span><span class="COMM">// Add the error to the array of record errors (for lookup later on if necessary).</span><span class="WHIT">
<span class='line'>2546</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">error</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">error.isError</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2547</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">errors</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">errors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.recordErrors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2548</span> </span><span class="WHIT">        </span><span class="NAME">errors</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">error</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2549</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2550</span> 
<span class='line'>2551</span> </span><span class="WHIT">      </span><span class="NAME">this.writeStatus</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">status</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2552</span> </span><span class="WHIT">      </span><span class="NAME">this.dataHashDidChange</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2553</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2554</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2555</span> </span><span class="WHIT">    </span><span class="COMM">//conflicted (error)</span><span class="WHIT">
<span class='line'>2556</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2557</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2558</span> 
<span class='line'>2559</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>2560</span> </span><span class="WHIT">  </span><span class="COMM">// FETCH CALLBACKS</span><span class="WHIT">
<span class='line'>2561</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>2562</span> 
<span class='line'>2563</span> </span><span class="WHIT">  </span><span class="COMM">// **NOTE**: although these method works on RecordArray instances right now.</span><span class="WHIT">
<span class='line'>2564</span> </span><span class="WHIT">  </span><span class="COMM">// They could be optimized to actually share query results between nested</span><span class="WHIT">
<span class='line'>2565</span> </span><span class="WHIT">  </span><span class="COMM">// stores.  This is why these methods are implemented here instead of</span><span class="WHIT">
<span class='line'>2566</span> </span><span class="WHIT">  </span><span class="COMM">// directly on `Query` or `RecordArray` objects.</span><span class="WHIT">
<span class='line'>2567</span> 
<span class='line'>2568</span> </span><span class="WHIT">  </span><span class="COMM">/** @deprecated
<span class='line'>2569</span> 
<span class='line'>2570</span>     @param {SC.Query} query the query you are loading.  must be remote.
<span class='line'>2571</span>     @param {SC.Array} storeKeys array of store keys
<span class='line'>2572</span>     @returns {SC.Store} receiver
<span class='line'>2573</span>   */</span><span class="WHIT">
<span class='line'>2574</span> </span><span class="WHIT">  </span><span class="NAME">loadQueryResults</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2575</span> </span><span class="WHIT">    </span><span class="COMM">//@if(debug)</span><span class="WHIT">
<span class='line'>2576</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">query.get</span><span class="PUNC">(</span><span class="STRN">'location'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">SC.Query.LOCAL</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2577</span> </span><span class="WHIT">      </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"Developer Error: You should not call loadQueryResults with a local query.  You need to use dataSourceDidFetchQuery instead."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2578</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2579</span> </span><span class="WHIT">      </span><span class="NAME">SC.warn</span><span class="PUNC">(</span><span class="STRN">"Developer Warning: loadQueryResults has been deprecated in favor of using dataSourceDidFetchQuery for both local and remote queries.  With remote queries, include the store keys when calling dataSourceDidFetchQuery."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2580</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2581</span> </span><span class="WHIT">    </span><span class="COMM">//@endif</span><span class="WHIT">
<span class='line'>2582</span> 
<span class='line'>2583</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.dataSourceDidFetchQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2584</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2585</span> 
<span class='line'>2586</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2587</span>     Called by your data source whenever you finish fetching the results of a
<span class='line'>2588</span>     query.  This will put the record array for the query into a READY_CLEAN
<span class='line'>2589</span>     state if it was previously loading or refreshing.
<span class='line'>2590</span> 
<span class='line'>2591</span>     # Handling REMOTE queries
<span class='line'>2592</span> 
<span class='line'>2593</span>     Note that if the query is REMOTE, then you must first load the results
<span class='line'>2594</span>     into the store using `loadRecords()` and pass the ordered array of store
<span class='line'>2595</span>     keys returned by `loadRecords()` into this method.
<span class='line'>2596</span> 
<span class='line'>2597</span>     For example,
<span class='line'>2598</span> 
<span class='line'>2599</span>         storeKeys = store.loadRecords(MyApp.SomeType, body.contacts);
<span class='line'>2600</span>         store.dataSourceDidFetchQuery(query, storeKeys);
<span class='line'>2601</span> 
<span class='line'>2602</span>     # Automatic updates
<span class='line'>2603</span> 
<span class='line'>2604</span>     When you call this method the record array for the query will notify that
<span class='line'>2605</span>     its contents have changed.  If the query is LOCAL then the contents will
<span class='line'>2606</span>     update automatically to include any new records you added to the store.
<span class='line'>2607</span>     If the query is REMOTE the contents will update to be the ordered records
<span class='line'>2608</span>     for the passed in store keys.
<span class='line'>2609</span> 
<span class='line'>2610</span>     # Incremental loading for REMOTE queries
<span class='line'>2611</span> 
<span class='line'>2612</span>     If you want to support incremental loading, then pass an SC.SparseArray
<span class='line'>2613</span>     object to hold the store keys.  This will allow you to load results
<span class='line'>2614</span>     incrementally and provide more store keys as you do.
<span class='line'>2615</span> 
<span class='line'>2616</span>     See the SC.SparseArray documentation for more information.
<span class='line'>2617</span> 
<span class='line'>2618</span>     @param {SC.Query} query The query you fetched
<span class='line'>2619</span>     @param {Array} [storeKeys] Ordered array of store keys as returned by a remote query.  NOTE: Required for remote queries.
<span class='line'>2620</span>     @returns {SC.Store} receiver
<span class='line'>2621</span>   */</span><span class="WHIT">
<span class='line'>2622</span> </span><span class="WHIT">  </span><span class="NAME">dataSourceDidFetchQuery</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2623</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">recArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._findQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2624</span> 
<span class='line'>2625</span> </span><span class="WHIT">    </span><span class="COMM">// Set the ordered array of store keys for remote queries.</span><span class="WHIT">
<span class='line'>2626</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">recArray</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">query.get</span><span class="PUNC">(</span><span class="STRN">'isRemote'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2627</span> </span><span class="WHIT">      </span><span class="COMM">//@if(debug)</span><span class="WHIT">
<span class='line'>2628</span> </span><span class="WHIT">      </span><span class="COMM">// Prevent confusion between local and remote requests.</span><span class="WHIT">
<span class='line'>2629</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">SC.none</span><span class="PUNC">(</span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2630</span> </span><span class="WHIT">        </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"Developer Error: The storeKeys argument in dataSourceDidFetchQuery is not optional for remote queries.  For a remote query you must include the ordered array of store keys for the loaded records (even if it's an empty array)."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2631</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2632</span> </span><span class="WHIT">      </span><span class="COMM">//@endif</span><span class="WHIT">
<span class='line'>2633</span> 
<span class='line'>2634</span> </span><span class="WHIT">      </span><span class="NAME">recArray.set</span><span class="PUNC">(</span><span class="STRN">'storeKeys'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2635</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2636</span> 
<span class='line'>2637</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this._scstore_dataSourceDidFetchQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2638</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2639</span> 
<span class='line'>2640</span> </span><span class="WHIT">  </span><span class="COMM">/** @private */</span><span class="WHIT">
<span class='line'>2641</span> </span><span class="WHIT">  </span><span class="NAME">_scstore_dataSourceDidFetchQuery</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2642</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">recArray</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._findQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2643</span> </span><span class="WHIT">        </span><span class="NAME">nestedStores</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'nestedStores'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2644</span> </span><span class="WHIT">        </span><span class="NAME">loc</span><span class="WHIT">          </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nestedStores</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">nestedStores.get</span><span class="PUNC">(</span><span class="STRN">'length'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2645</span> 
<span class='line'>2646</span> </span><span class="WHIT">    </span><span class="COMM">// fix query if needed</span><span class="WHIT">
<span class='line'>2647</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">recArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recArray.storeDidFetchQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2648</span> 
<span class='line'>2649</span> </span><span class="WHIT">    </span><span class="COMM">// notify nested stores</span><span class="WHIT">
<span class='line'>2650</span> </span><span class="WHIT">    </span><span class="KEYW">while</span><span class="PUNC">(</span><span class="PUNC">--</span><span class="NAME">loc</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2651</span> </span><span class="WHIT">      </span><span class="NAME">nestedStores</span><span class="PUNC">[</span><span class="NAME">loc</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">_scstore_dataSourceDidFetchQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2652</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2653</span> 
<span class='line'>2654</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2655</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2656</span> 
<span class='line'>2657</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2658</span>     Called by your data source if it cancels fetching the results of a query.
<span class='line'>2659</span>     This will put any RecordArray's back into its original state (READY or
<span class='line'>2660</span>     EMPTY).
<span class='line'>2661</span> 
<span class='line'>2662</span>     @param {SC.Query} query the query you cancelled
<span class='line'>2663</span>     @returns {SC.Store} receiver
<span class='line'>2664</span>   */</span><span class="WHIT">
<span class='line'>2665</span> </span><span class="WHIT">  </span><span class="NAME">dataSourceDidCancelQuery</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2666</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this._scstore_dataSourceDidCancelQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2667</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2668</span> 
<span class='line'>2669</span> </span><span class="WHIT">  </span><span class="NAME">_scstore_dataSourceDidCancelQuery</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">createIfNeeded</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2670</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">recArray</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._findQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">createIfNeeded</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2671</span> </span><span class="WHIT">        </span><span class="NAME">nestedStores</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'nestedStores'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2672</span> </span><span class="WHIT">        </span><span class="NAME">loc</span><span class="WHIT">          </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nestedStores</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">nestedStores.get</span><span class="PUNC">(</span><span class="STRN">'length'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2673</span> 
<span class='line'>2674</span> </span><span class="WHIT">    </span><span class="COMM">// fix query if needed</span><span class="WHIT">
<span class='line'>2675</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">recArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recArray.storeDidCancelQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2676</span> 
<span class='line'>2677</span> </span><span class="WHIT">    </span><span class="COMM">// notify nested stores</span><span class="WHIT">
<span class='line'>2678</span> </span><span class="WHIT">    </span><span class="KEYW">while</span><span class="PUNC">(</span><span class="PUNC">--</span><span class="NAME">loc</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2679</span> </span><span class="WHIT">      </span><span class="NAME">nestedStores</span><span class="PUNC">[</span><span class="NAME">loc</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">_scstore_dataSourceDidCancelQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2680</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2681</span> 
<span class='line'>2682</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2683</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2684</span> 
<span class='line'>2685</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2686</span>     Called by your data source if it encountered an error loading the query.
<span class='line'>2687</span>     This will put the query into an error state until you try to refresh it
<span class='line'>2688</span>     again.
<span class='line'>2689</span> 
<span class='line'>2690</span>     @param {SC.Query} query the query with the error
<span class='line'>2691</span>     @param {SC.Error} error [optional] an SC.Error instance to associate with query
<span class='line'>2692</span>     @returns {SC.Store} receiver
<span class='line'>2693</span>   */</span><span class="WHIT">
<span class='line'>2694</span> </span><span class="WHIT">  </span><span class="NAME">dataSourceDidErrorQuery</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">error</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2695</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">errors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.queryErrors</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2696</span> 
<span class='line'>2697</span> </span><span class="WHIT">    </span><span class="COMM">// Add the error to the array of query errors (for lookup later on if necessary).</span><span class="WHIT">
<span class='line'>2698</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">error</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">error.isError</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2699</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">errors</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">errors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.queryErrors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2700</span> </span><span class="WHIT">      </span><span class="NAME">errors</span><span class="PUNC">[</span><span class="NAME">SC.guidFor</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">error</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2701</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2702</span> 
<span class='line'>2703</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this._scstore_dataSourceDidErrorQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">YES</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2704</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2705</span> 
<span class='line'>2706</span> </span><span class="WHIT">  </span><span class="NAME">_scstore_dataSourceDidErrorQuery</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">createIfNeeded</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2707</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">recArray</span><span class="WHIT">     </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._findQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">createIfNeeded</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2708</span> </span><span class="WHIT">        </span><span class="NAME">nestedStores</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'nestedStores'</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2709</span> </span><span class="WHIT">        </span><span class="NAME">loc</span><span class="WHIT">          </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nestedStores</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">nestedStores.get</span><span class="PUNC">(</span><span class="STRN">'length'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2710</span> 
<span class='line'>2711</span> </span><span class="WHIT">    </span><span class="COMM">// fix query if needed</span><span class="WHIT">
<span class='line'>2712</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">recArray</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">recArray.storeDidErrorQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2713</span> 
<span class='line'>2714</span> </span><span class="WHIT">    </span><span class="COMM">// notify nested stores</span><span class="WHIT">
<span class='line'>2715</span> </span><span class="WHIT">    </span><span class="KEYW">while</span><span class="PUNC">(</span><span class="PUNC">--</span><span class="NAME">loc</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2716</span> </span><span class="WHIT">      </span><span class="NAME">nestedStores</span><span class="PUNC">[</span><span class="NAME">loc</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">_scstore_dataSourceDidErrorQuery</span><span class="PUNC">(</span><span class="NAME">query</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">NO</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2717</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2718</span> 
<span class='line'>2719</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2720</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2721</span> 
<span class='line'>2722</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>2723</span> </span><span class="WHIT">  </span><span class="COMM">// INTERNAL SUPPORT</span><span class="WHIT">
<span class='line'>2724</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>2725</span> 
<span class='line'>2726</span> </span><span class="WHIT">  </span><span class="COMM">/** @private */</span><span class="WHIT">
<span class='line'>2727</span> </span><span class="WHIT">  </span><span class="NAME">init</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2728</span> </span><span class="WHIT">    </span><span class="NAME">sc_super</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2729</span> </span><span class="WHIT">    </span><span class="NAME">this.reset</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2730</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2731</span> 
<span class='line'>2732</span> 
<span class='line'>2733</span> </span><span class="WHIT">  </span><span class="NAME">toString</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2734</span> </span><span class="WHIT">    </span><span class="COMM">// Include the name if the client has specified one.</span><span class="WHIT">
<span class='line'>2735</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">name</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="STRN">'name'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2736</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">name</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2737</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">sc_super</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2738</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2739</span> </span><span class="WHIT">    </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2740</span> </span><span class="WHIT">      </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">sc_super</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2741</span> </span><span class="WHIT">      </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">"%@ (%@)"</span><span class="PUNC">.</span><span class="NAME">fmt</span><span class="PUNC">(</span><span class="NAME">name</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2742</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2743</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2744</span> 
<span class='line'>2745</span> 
<span class='line'>2746</span> </span><span class="WHIT">  </span><span class="COMM">// ..........................................................</span><span class="WHIT">
<span class='line'>2747</span> </span><span class="WHIT">  </span><span class="COMM">// PRIMARY KEY CONVENIENCE METHODS</span><span class="WHIT">
<span class='line'>2748</span> </span><span class="WHIT">  </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>2749</span> 
<span class='line'>2750</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2751</span>     Given a `storeKey`, return the `primaryKey`.
<span class='line'>2752</span> 
<span class='line'>2753</span>     @param {Number} storeKey the store key
<span class='line'>2754</span>     @returns {String} primaryKey value
<span class='line'>2755</span>   */</span><span class="WHIT">
<span class='line'>2756</span> </span><span class="WHIT">  </span><span class="NAME">idFor</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2757</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">SC.Store.idFor</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2758</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2759</span> 
<span class='line'>2760</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2761</span>     Given a storeKey, return the recordType.
<span class='line'>2762</span> 
<span class='line'>2763</span>     @param {Number} storeKey the store key
<span class='line'>2764</span>     @returns {SC.Record} record instance
<span class='line'>2765</span>   */</span><span class="WHIT">
<span class='line'>2766</span> </span><span class="WHIT">  </span><span class="NAME">recordTypeFor</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2767</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">SC.Store.recordTypeFor</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2768</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2769</span> 
<span class='line'>2770</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2771</span>     Given a `recordType` and `primaryKey`, find the `storeKey`. If the
<span class='line'>2772</span>     `primaryKey` has not been assigned a `storeKey` yet, it will be added.
<span class='line'>2773</span> 
<span class='line'>2774</span>     @param {SC.Record} recordType the record type
<span class='line'>2775</span>     @param {String} primaryKey the primary key
<span class='line'>2776</span>     @returns {Number} storeKey
<span class='line'>2777</span>   */</span><span class="WHIT">
<span class='line'>2778</span> </span><span class="WHIT">  </span><span class="NAME">storeKeyFor</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">primaryKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2779</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyFor</span><span class="PUNC">(</span><span class="NAME">primaryKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2780</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2781</span> 
<span class='line'>2782</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2783</span>     Given a `primaryKey` value for the record, returns the associated
<span class='line'>2784</span>     `storeKey`.  As opposed to `storeKeyFor()` however, this method
<span class='line'>2785</span>     will **NOT** generate a new `storeKey` but returned `undefined`.
<span class='line'>2786</span> 
<span class='line'>2787</span>     @param {SC.Record} recordType the record type
<span class='line'>2788</span>     @param {String} primaryKey the primary key
<span class='line'>2789</span>     @returns {Number} a storeKey.
<span class='line'>2790</span>   */</span><span class="WHIT">
<span class='line'>2791</span> </span><span class="WHIT">  </span><span class="NAME">storeKeyExists</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">primaryKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2792</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeyExists</span><span class="PUNC">(</span><span class="NAME">primaryKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2793</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2794</span> 
<span class='line'>2795</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2796</span>     Finds all `storeKey`s of a certain record type in this store
<span class='line'>2797</span>     and returns an array.
<span class='line'>2798</span> 
<span class='line'>2799</span>     @param {SC.Record} recordType
<span class='line'>2800</span>     @returns {Array} set of storeKeys
<span class='line'>2801</span>   */</span><span class="WHIT">
<span class='line'>2802</span> </span><span class="WHIT">  </span><span class="NAME">storeKeysFor</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">recordType</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2803</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2804</span> </span><span class="WHIT">        </span><span class="NAME">isEnum</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">recordType.isEnumerable</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2805</span> </span><span class="WHIT">        </span><span class="NAME">recType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isMatch</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2806</span> 
<span class='line'>2807</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.statuses</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2808</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">SC.Store.recordTypesByStoreKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2809</span> </span><span class="WHIT">      </span><span class="NAME">recType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SC.Store.recordTypesByStoreKey</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2810</span> 
<span class='line'>2811</span> </span><span class="WHIT">      </span><span class="COMM">// if same record type and this store has it</span><span class="WHIT">
<span class='line'>2812</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">isEnum</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">isMatch</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.contains</span><span class="PUNC">(</span><span class="NAME">recType</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2813</span> </span><span class="WHIT">      </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">isMatch</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recType</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2814</span> 
<span class='line'>2815</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">isMatch</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.statuses</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">ret.push</span><span class="PUNC">(</span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2816</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2817</span> 
<span class='line'>2818</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2819</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2820</span> 
<span class='line'>2821</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2822</span>     Finds all `storeKey`s in this store
<span class='line'>2823</span>     and returns an array.
<span class='line'>2824</span> 
<span class='line'>2825</span>     @returns {Array} set of storeKeys
<span class='line'>2826</span>   */</span><span class="WHIT">
<span class='line'>2827</span> </span><span class="WHIT">  </span><span class="NAME">storeKeys</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2828</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2829</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.statuses</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2830</span> 
<span class='line'>2831</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">this.statuses</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2832</span> </span><span class="WHIT">      </span><span class="COMM">// if status is not empty</span><span class="WHIT">
<span class='line'>2833</span> </span><span class="WHIT">      </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">this.statuses</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">SC.Record.EMPTY</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2834</span> </span><span class="WHIT">        </span><span class="NAME">ret.push</span><span class="PUNC">(</span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2835</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2836</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2837</span> 
<span class='line'>2838</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2839</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2840</span> 
<span class='line'>2841</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2842</span>     Returns string representation of a `storeKey`, with status.
<span class='line'>2843</span> 
<span class='line'>2844</span>     @param {Number} storeKey
<span class='line'>2845</span>     @returns {String}
<span class='line'>2846</span>   */</span><span class="WHIT">
<span class='line'>2847</span> </span><span class="WHIT">  </span><span class="NAME">statusString</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2848</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rec</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.materializeRecord</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2849</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">rec.statusString</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2850</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2851</span> 
<span class='line'>2852</span> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2853</span> 
<span class='line'>2854</span> </span><span class="NAME">SC.Store.mixin</span><span class="PUNC">(</span><span class="COMM">/** @scope SC.Store.prototype */</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2855</span> 
<span class='line'>2856</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2857</span>     Standard error raised if you try to commit changes from a nested store
<span class='line'>2858</span>     and there is a conflict.
<span class='line'>2859</span> 
<span class='line'>2860</span>     @type Error
<span class='line'>2861</span>   */</span><span class="WHIT">
<span class='line'>2862</span> </span><span class="WHIT">  </span><span class="NAME">CHAIN_CONFLICT_ERROR</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">SC.$error</span><span class="PUNC">(</span><span class="STRN">"Nested Store Conflict"</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2863</span> 
<span class='line'>2864</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2865</span>     Standard error if you try to perform an operation on a nested store
<span class='line'>2866</span>     without a parent.
<span class='line'>2867</span> 
<span class='line'>2868</span>     @type Error
<span class='line'>2869</span>   */</span><span class="WHIT">
<span class='line'>2870</span> </span><span class="WHIT">  </span><span class="NAME">NO_PARENT_STORE_ERROR</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">SC.$error</span><span class="PUNC">(</span><span class="STRN">"Parent Store Required"</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2871</span> 
<span class='line'>2872</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2873</span>     Standard error if you try to perform an operation on a nested store that
<span class='line'>2874</span>     is only supported in root stores.
<span class='line'>2875</span> 
<span class='line'>2876</span>     @type Error
<span class='line'>2877</span>   */</span><span class="WHIT">
<span class='line'>2878</span> </span><span class="WHIT">  </span><span class="NAME">NESTED_STORE_UNSUPPORTED_ERROR</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">SC.$error</span><span class="PUNC">(</span><span class="STRN">"Unsupported In Nested Store"</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2879</span> 
<span class='line'>2880</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2881</span>     Standard error if you try to retrieve a record in a nested store that is
<span class='line'>2882</span>     dirty.  (This is allowed on the main store, but not in nested stores.)
<span class='line'>2883</span> 
<span class='line'>2884</span>     @type Error
<span class='line'>2885</span>   */</span><span class="WHIT">
<span class='line'>2886</span> </span><span class="WHIT">  </span><span class="NAME">NESTED_STORE_RETRIEVE_DIRTY_ERROR</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">SC.$error</span><span class="PUNC">(</span><span class="STRN">"Cannot Retrieve Dirty Record in Nested Store"</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2887</span> 
<span class='line'>2888</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2889</span>     Data hash state indicates the data hash is currently editable
<span class='line'>2890</span> 
<span class='line'>2891</span>     @type String
<span class='line'>2892</span>   */</span><span class="WHIT">
<span class='line'>2893</span> </span><span class="WHIT">  </span><span class="NAME">EDITABLE</span><span class="PUNC">:</span><span class="WHIT">  </span><span class="STRN">'editable'</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2894</span> 
<span class='line'>2895</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2896</span>     Data hash state indicates the hash no longer tracks changes from a
<span class='line'>2897</span>     parent store, but it is not editable.
<span class='line'>2898</span> 
<span class='line'>2899</span>     @type String
<span class='line'>2900</span>   */</span><span class="WHIT">
<span class='line'>2901</span> </span><span class="WHIT">  </span><span class="NAME">LOCKED</span><span class="PUNC">:</span><span class="WHIT">    </span><span class="STRN">'locked'</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2902</span> 
<span class='line'>2903</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2904</span>     Data hash state indicates the hash is tracking changes from the parent
<span class='line'>2905</span>     store and is not editable.
<span class='line'>2906</span> 
<span class='line'>2907</span>     @type String
<span class='line'>2908</span>   */</span><span class="WHIT">
<span class='line'>2909</span> </span><span class="WHIT">  </span><span class="NAME">INHERITED</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">'inherited'</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2910</span> 
<span class='line'>2911</span> </span><span class="WHIT">  </span><span class="COMM">/** @private
<span class='line'>2912</span>     This array maps all storeKeys to primary keys.  You will not normally
<span class='line'>2913</span>     access this method directly.  Instead use the `idFor()` and
<span class='line'>2914</span>     `storeKeyFor()` methods on `SC.Record`.
<span class='line'>2915</span>   */</span><span class="WHIT">
<span class='line'>2916</span> </span><span class="WHIT">  </span><span class="NAME">idsByStoreKey</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2917</span> 
<span class='line'>2918</span> </span><span class="WHIT">  </span><span class="COMM">/** @private
<span class='line'>2919</span>     Maps all `storeKey`s to a `recordType`.  Once a `storeKey` is associated
<span class='line'>2920</span>     with a `primaryKey` and `recordType` that remains constant throughout the
<span class='line'>2921</span>     lifetime of the application.
<span class='line'>2922</span>   */</span><span class="WHIT">
<span class='line'>2923</span> </span><span class="WHIT">  </span><span class="NAME">recordTypesByStoreKey</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2924</span> 
<span class='line'>2925</span> </span><span class="WHIT">  </span><span class="COMM">/** @private
<span class='line'>2926</span>     Maps some `storeKeys` to query instance.  Once a `storeKey` is associated
<span class='line'>2927</span>     with a query instance, that remains constant through the lifetime of the
<span class='line'>2928</span>     application.  If a `Query` is destroyed, it will remove itself from this
<span class='line'>2929</span>     list.
<span class='line'>2930</span> 
<span class='line'>2931</span>     Don't access this directly.  Use queryFor().
<span class='line'>2932</span>   */</span><span class="WHIT">
<span class='line'>2933</span> </span><span class="WHIT">  </span><span class="NAME">queriesByStoreKey</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2934</span> 
<span class='line'>2935</span> </span><span class="WHIT">  </span><span class="COMM">/** @private
<span class='line'>2936</span>     The next store key to allocate.  A storeKey must always be greater than 0
<span class='line'>2937</span>   */</span><span class="WHIT">
<span class='line'>2938</span> </span><span class="WHIT">  </span><span class="NAME">nextStoreKey</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2939</span> 
<span class='line'>2940</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2941</span>     Generates a new store key for use.
<span class='line'>2942</span> 
<span class='line'>2943</span>     @type Number
<span class='line'>2944</span>   */</span><span class="WHIT">
<span class='line'>2945</span> </span><span class="WHIT">  </span><span class="NAME">generateStoreKey</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.nextStoreKey</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2946</span> 
<span class='line'>2947</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2948</span>     Given a `storeKey` returns the `primaryKey` associated with the key.
<span class='line'>2949</span>     If no `primaryKey` is associated with the `storeKey`, returns `null`.
<span class='line'>2950</span> 
<span class='line'>2951</span>     @param {Number} storeKey the store key
<span class='line'>2952</span>     @returns {String} the primary key or null
<span class='line'>2953</span>   */</span><span class="WHIT">
<span class='line'>2954</span> </span><span class="WHIT">  </span><span class="NAME">idFor</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2955</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.idsByStoreKey</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2956</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2957</span> 
<span class='line'>2958</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2959</span>     Given a `storeKey`, returns the query object associated with the key.  If
<span class='line'>2960</span>     no query is associated with the `storeKey`, returns `null`.
<span class='line'>2961</span> 
<span class='line'>2962</span>     @param {Number} storeKey the store key
<span class='line'>2963</span>     @returns {SC.Query} query query object
<span class='line'>2964</span>   */</span><span class="WHIT">
<span class='line'>2965</span> </span><span class="WHIT">  </span><span class="NAME">queryFor</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2966</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.queriesByStoreKey</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2967</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2968</span> 
<span class='line'>2969</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2970</span>     Given a `storeKey` returns the `SC.Record` class associated with the key.
<span class='line'>2971</span>     If no record type is associated with the store key, returns `null`.
<span class='line'>2972</span> 
<span class='line'>2973</span>     The SC.Record class will only be found if you have already called
<span class='line'>2974</span>     storeKeyFor() on the record.
<span class='line'>2975</span> 
<span class='line'>2976</span>     @param {Number} storeKey the store key
<span class='line'>2977</span>     @returns {SC.Record} the record type
<span class='line'>2978</span>   */</span><span class="WHIT">
<span class='line'>2979</span> </span><span class="WHIT">  </span><span class="NAME">recordTypeFor</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2980</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.recordTypesByStoreKey</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2981</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2982</span> 
<span class='line'>2983</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>2984</span>     Swaps the `primaryKey` mapped to the given storeKey with the new
<span class='line'>2985</span>     `primaryKey`.  If the `storeKey` is not currently associated with a record
<span class='line'>2986</span>     this will raise an exception.
<span class='line'>2987</span> 
<span class='line'>2988</span>     @param {Number} storeKey the existing store key
<span class='line'>2989</span>     @param {String} newPrimaryKey the new primary key
<span class='line'>2990</span>     @returns {SC.Store} receiver
<span class='line'>2991</span>   */</span><span class="WHIT">
<span class='line'>2992</span> </span><span class="WHIT">  </span><span class="NAME">replaceIdFor</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newId</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2993</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">oldId</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.idsByStoreKey</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>2994</span> </span><span class="WHIT">        </span><span class="NAME">recordType</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2995</span> 
<span class='line'>2996</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">oldId</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">newId</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="COMM">// skip if id isn't changing</span><span class="WHIT">
<span class='line'>2997</span> 
<span class='line'>2998</span> </span><span class="WHIT">      </span><span class="NAME">recordType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.recordTypeFor</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2999</span> </span><span class="WHIT">       </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">recordType</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>3000</span> </span><span class="WHIT">        </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"replaceIdFor: storeKey %@ does not exist"</span><span class="PUNC">.</span><span class="NAME">fmt</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>3001</span> </span><span class="WHIT">      </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>3002</span> 
<span class='line'>3003</span> </span><span class="WHIT">      </span><span class="COMM">// map one direction...</span><span class="WHIT">
<span class='line'>3004</span> </span><span class="WHIT">      </span><span class="NAME">this.idsByStoreKey</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newId</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>3005</span> 
<span class='line'>3006</span> </span><span class="WHIT">      </span><span class="COMM">// then the other...</span><span class="WHIT">
<span class='line'>3007</span> </span><span class="WHIT">      </span><span class="NAME">storeKeys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType.storeKeysById</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>3008</span> </span><span class="WHIT">      </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">storeKeys</span><span class="PUNC">[</span><span class="NAME">oldId</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>3009</span> </span><span class="WHIT">      </span><span class="NAME">storeKeys</span><span class="PUNC">[</span><span class="NAME">newId</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">storeKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>3010</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>3011</span> 
<span class='line'>3012</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>3013</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>3014</span> 
<span class='line'>3015</span> </span><span class="WHIT">  </span><span class="COMM">/**
<span class='line'>3016</span>     Swaps the `recordType` recorded for a given `storeKey`.  Normally you
<span class='line'>3017</span>     should not call this method directly as it can damage the store behavior.
<span class='line'>3018</span>     This method is used by other store methods to set the `recordType` for a
<span class='line'>3019</span>     `storeKey`.
<span class='line'>3020</span> 
<span class='line'>3021</span>     @param {Integer} storeKey the store key
<span class='line'>3022</span>     @param {SC.Record} recordType a record class
<span class='line'>3023</span>     @returns {SC.Store} receiver
<span class='line'>3024</span>   */</span><span class="WHIT">
<span class='line'>3025</span> </span><span class="WHIT">  </span><span class="NAME">replaceRecordTypeFor</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">storeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>3026</span> </span><span class="WHIT">    </span><span class="NAME">this.recordTypesByStoreKey</span><span class="PUNC">[</span><span class="NAME">storeKey</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">recordType</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>3027</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="WHIT"> </span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>3028</span> </span><span class="WHIT">  </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>3029</span> 
<span class='line'>3030</span> </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>3031</span> </span></pre></body></html>